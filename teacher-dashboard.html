<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - MathEase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                        'poppins': ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        'slate': {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        'indigo': {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81',
                        },
                        'emerald': {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            200: '#a7f3d0',
                            300: '#6ee7b7',
                            400: '#34d399',
                            500: '#10b981',
                            600: '#059669',
                            700: '#047857',
                            800: '#065f46',
                            900: '#064e3b',
                        },
                        'violet': {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            200: '#ddd6fe',
                            300: '#c4b5fd',
                            400: '#a78bfa',
                            500: '#8b5cf6',
                            600: '#7c3aed',
                            700: '#6d28d9',
                            800: '#5b21b6',
                            900: '#4c1d95',
                        },
                        'amber': {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.6s ease-out',
                        'scale-in': 'scaleIn 0.4s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Profile dropdown icon rotation animation */
        .rotate-180 {
            transform: rotate(180deg);
        }
        
        /* Profile dropdown animation */
        #profileDropdown {
            animation: slideDown 0.2s ease-out;
            transform-origin: top;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mx-auto mb-4"></div>
            <div class="text-xl font-semibold text-gray-700 mb-2">Loading Dashboard</div>
            <div class="text-sm text-gray-500">Please wait while we fetch your data...</div>
        </div>
    </div>
    <!-- Sidebar -->
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-white shadow-lg border-r border-gray-200 flex flex-col">
            <!-- Logo Section -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center">
                        <img src="css/nav-logo/nav-logo.png" alt="MathEase Logo" class="h-6 w-6">
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-900">MathEase</h1>
                        <p class="text-xs text-gray-500">Teacher Portal</p>
                    </div>
                </div>
            </div>

            <!-- Navigation Menu -->
            <nav class="flex-1 px-4 py-6 space-y-2">
                <button onclick="showSection('dashboard')" class="nav-item w-full flex items-center px-4 py-3 text-sm font-medium text-gray-700 rounded-lg hover:bg-indigo-50 hover:text-indigo-700 transition-all duration-200 active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt mr-3 text-gray-400"></i>
                    Dashboard
                </button>
                
                <button onclick="showSection('class-management')" class="nav-item w-full flex items-center px-4 py-3 text-sm font-medium text-gray-700 rounded-lg hover:bg-indigo-50 hover:text-indigo-700 transition-all duration-200" data-section="class-management">
                    <i class="fas fa-chalkboard-teacher mr-3 text-gray-400"></i>
                    Class Management
                </button>
                
                
                <button onclick="showSection('quiz-management')" class="nav-item w-full flex items-center px-4 py-3 text-sm font-medium text-gray-700 rounded-lg hover:bg-indigo-50 hover:text-indigo-700 transition-all duration-200" data-section="quiz-management">
                    <i class="fas fa-question-circle mr-3 text-gray-400"></i>
                    Quiz Management
                </button>
                
                <button onclick="showSection('class-performance')" class="nav-item w-full flex items-center px-4 py-3 text-sm font-medium text-gray-700 rounded-lg hover:bg-indigo-50 hover:text-indigo-700 transition-all duration-200" data-section="class-performance">
                    <i class="fas fa-chart-bar mr-3 text-gray-400"></i>
                    Class Performance
                </button>
            </nav>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Header -->
            <header class="bg-white shadow-sm border-b border-gray-200">
                <div class="px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900" id="pageTitle">Dashboard</h2>
                            <p class="text-sm text-gray-600" id="pageDescription">Welcome to your teacher dashboard</p>
                        </div>
                        
                        <!-- Right Side: Profile, Notifications, Stats -->
                        <div class="flex items-center space-x-4">
                            <!-- Teacher Profile with Dropdown -->
                            <div class="relative" id="profileDropdownContainer">
                                <button onclick="toggleProfileDropdown()" class="flex items-center space-x-3 px-4 py-2.5 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border border-indigo-200 hover:shadow-lg hover:border-indigo-300 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                    <div class="w-11 h-11 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center shadow-md flex-shrink-0">
                                        <i class="fas fa-user text-white text-base"></i>
                                    </div>
                                    <div class="text-left min-w-0 flex-1">
                                        <p class="text-sm font-semibold text-gray-900 truncate" id="headerTeacherName">Loading...</p>
                                        <p class="text-xs text-gray-600 truncate" id="headerTeacherEmail">teacher@mathease.com</p>
                                    </div>
                                    <i class="fas fa-chevron-down text-gray-500 text-xs transition-transform duration-200 flex-shrink-0" id="profileDropdownIcon"></i>
                                </button>
                                
                                <!-- Enhanced Profile Dropdown -->
                                <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden" style="z-index: 9999;">
                                    <!-- Profile Header -->
                                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 px-5 py-5">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center shadow-lg flex-shrink-0">
                                                <i class="fas fa-user text-indigo-600 text-xl"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-base font-bold text-white truncate" id="dropdownTeacherName">Teacher Name</p>
                                                <p class="text-xs text-indigo-100 truncate" id="dropdownTeacherEmail">email@example.com</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Profile Info -->
                                    <div class="px-5 py-4 bg-gray-50 border-b border-gray-200">
                                        <div class="space-y-2.5 text-sm">
                                            <div class="flex items-center justify-between">
                                                <span class="text-gray-600 font-medium flex items-center">
                                                    <i class="fas fa-id-card text-gray-400 mr-2 w-4"></i>
                                                    Teacher ID:
                                                </span>
                                                <span class="font-semibold text-gray-900" id="dropdownTeacherId">-</span>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <span class="text-gray-600 font-medium flex items-center">
                                                    <i class="fas fa-building text-gray-400 mr-2 w-4"></i>
                                                    Department:
                                                </span>
                                                <span class="font-semibold text-gray-900 text-right truncate max-w-[180px]" id="dropdownTeacherDept">-</span>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <span class="text-gray-600 font-medium flex items-center">
                                                    <i class="fas fa-book text-gray-400 mr-2 w-4"></i>
                                                    Subject:
                                                </span>
                                                <span class="font-semibold text-gray-900 text-right truncate max-w-[180px]" id="dropdownTeacherSubject">-</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Actions -->
                                    <div class="p-3">
                                        <a href="php/smart-logout.php?type=teacher" class="flex items-center px-4 py-3 text-sm text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200 group">
                                            <div class="w-10 h-10 rounded-lg bg-red-100 group-hover:bg-red-200 flex items-center justify-center mr-3 transition-colors">
                                                <i class="fas fa-sign-out-alt text-red-600 text-base"></i>
                                            </div>
                                            <div class="flex-1">
                                                <p class="font-bold text-red-600">Logout</p>
                                                <p class="text-xs text-gray-500 group-hover:text-gray-600">Sign out of your account</p>
                                            </div>
                                            <i class="fas fa-arrow-right text-red-400 group-hover:translate-x-1 transition-transform"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Notification Bell -->
                            <div class="relative">
                        <button id="notificationBtn" onclick="toggleNotifications()" class="relative p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
                            <i class="fas fa-bell text-xl"></i>
                            <span id="notificationBadge" class="absolute top-0 right-0 hidden w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">0</span>
                        </button>
                        
                        <!-- Notification Dropdown -->
                        <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 z-50 max-h-[32rem] overflow-hidden flex flex-col">
                            <!-- Notification Header -->
                            <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-indigo-50 to-purple-50">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900">Notifications</h3>
                                        <p class="text-xs text-gray-600">Class updates and alerts</p>
                                    </div>
                                    <button onclick="markAllAsRead()" class="text-xs text-indigo-600 hover:text-indigo-700 font-medium">
                                        Mark all read
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Notification List -->
                            <div id="notificationList" class="flex-1 overflow-y-auto">
                                <div class="flex items-center justify-center p-8">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                                </div>
                            </div>
                            
                            <!-- Notification Footer -->
                            <div class="p-3 border-t border-gray-200 bg-gray-50 text-center">
                                <button onclick="viewAllNotifications()" class="text-sm text-indigo-600 hover:text-indigo-700 font-medium">
                                    View All Notifications
                                </button>
                            </div>
                        </div>
                    </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bottom section with Quick Stats -->
                <div class="px-6 py-3 bg-gradient-to-r from-gray-50 to-gray-100 border-t border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-6">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-indigo-600" id="enrolledStudents">0</div>
                            <div class="text-xs text-gray-500">Students</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-emerald-600" id="pendingRequests">0</div>
                            <div class="text-xs text-gray-500">Pending</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600" id="totalClasses">0</div>
                            <div class="text-xs text-gray-500">Classes</div>
                        </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            <i class="fas fa-clock mr-1"></i>
                            Last updated: <span id="lastUpdatedTime">Just now</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 overflow-y-auto bg-gray-50 p-6">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="content-section">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Welcome Card -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-graduation-cap text-white text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Welcome back!</h3>
                                    <p class="text-sm text-gray-600">Ready to manage your classes today?</p>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="showSection('class-management')" class="flex items-center justify-center px-4 py-3 bg-indigo-50 text-indigo-700 rounded-lg hover:bg-indigo-100 transition-colors">
                                    <i class="fas fa-plus mr-2"></i>
                                    Create Class
                                </button>
                                <button onclick="showSection('quiz-management')" class="flex items-center justify-center px-4 py-3 bg-emerald-50 text-emerald-700 rounded-lg hover:bg-emerald-100 transition-colors">
                                    <i class="fas fa-question-circle mr-2"></i>
                                    Manage Quiz
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Class Management Section -->
                <div id="class-management-section" class="content-section hidden">
                    <div class="mb-6">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Class Management</h3>
                            <button onclick="openCreateClassModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-plus mr-2"></i>
                                Create New Class
                            </button>
                        </div>
                    </div>

                    <!-- Pending Requests Card -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-user-plus text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">Pending Requests</h4>
                                    <p class="text-sm text-gray-600">Review student enrollment requests</p>
                                </div>
                            </div>
                            <button onclick="openPendingRequestsModal()" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-eye mr-2"></i>
                                View Requests
                            </button>
                        </div>
                    </div>

                    <!-- My Classes List -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h4 class="font-semibold text-gray-900 mb-4">My Classes</h4>
                        <div id="myClassesList">
                            <!-- Classes will be populated by JavaScript -->
                        </div>
                    </div>

                </div>


                <!-- Quiz Management Section -->
                <div id="quiz-management-section" class="content-section hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Quiz Management</h3>
                        <p class="text-sm text-gray-600">Manage quiz deadlines and view student performance</p>
                    </div>

                    <!-- Class Selection -->
                    <div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="flex flex-col space-y-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-chalkboard-teacher text-indigo-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-md font-semibold text-gray-900">Select Class</h4>
                                        <p class="text-sm text-gray-600">Choose a class to manage quizzes</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <select id="quizClassSelector" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm">
                                        <option value="">Loading classes...</option>
                                    </select>
                                    <button onclick="refreshClassData()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center">
                                        <i class="fas fa-sync-alt mr-2"></i>
                                        Refresh
                                    </button>
                                </div>
                            </div>
                            <div id="selectedClassInfo" class="p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border border-indigo-100 hidden">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="text-sm font-medium text-indigo-900">Selected Class: </span>
                                        <span id="selectedClassName" class="text-sm font-semibold text-indigo-700"></span>
                                    </div>
                                    <div class="flex items-center space-x-4 text-sm">
                                        <div class="flex items-center">
                                            <i class="fas fa-users text-indigo-500 mr-2"></i>
                                            <span class="text-indigo-700"><span id="selectedClassStudentCount">0</span> students</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- No Class Selected Message -->
                    <div id="noClassSelectedMessage" class="text-center py-12">
                        <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-chalkboard-teacher text-gray-400 text-3xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Select a Class to Manage Quizzes</h3>
                        <p class="text-gray-600 mb-6">Choose a class from the dropdown above to view and manage quiz settings, deadlines, and student performance.</p>
                        <div class="inline-flex items-center px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg">
                            <i class="fas fa-info-circle mr-2"></i>
                            Quiz settings will apply to all your classes
                        </div>
                    </div>

                    <!-- Quiz Content Wrapper -->
                    <div id="quizContentWrapper" class="hidden">
                        <!-- All Quizzes -->
                    <div id="allQuizzes" class="space-y-4">
                        <!-- Functions Quiz -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-function text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900">Functions Quiz</h4>
                                        <p class="text-sm text-gray-600">15 questions • Basic function concepts and operations</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Quiz Deadline</label>
                                    <input type="datetime-local" id="functionsQuizDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <div id="functionsQuizDeadlineStatus" class="mt-2 text-sm">
                                        <!-- Deadline status will be shown here -->
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Limit (minutes)</label>
                                    <input type="number" id="functionsQuizTimeLimit" min="5" max="120" value="20" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div class="flex items-end">
                                    <div class="flex flex-wrap gap-2 w-full">
                                        <button onclick="saveQuizSettings('functions')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-save mr-2"></i>
                                            Save
                                        </button>
                                        <button onclick="viewQuizResults('functions')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-chart-bar mr-2"></i>
                                            Results
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Evaluating Functions Quiz -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-600 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-calculator text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900">Evaluating Functions</h4>
                                        <p class="text-sm text-gray-600">10 questions • Function evaluation and substitution</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Quiz Deadline</label>
                                    <input type="datetime-local" id="evaluatingFunctionsQuizDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Limit (minutes)</label>
                                    <input type="number" id="evaluatingFunctionsQuizTimeLimit" min="5" max="120" value="20" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div class="flex items-end">
                                    <div class="flex flex-wrap gap-2 w-full">
                                        <button onclick="saveQuizSettings('evaluating-functions')" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-save mr-2"></i>
                                            Save
                                        </button>
                                        <button onclick="viewQuizResults('evaluating-functions')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-chart-bar mr-2"></i>
                                            Results
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Operations on Functions Quiz -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-plus-minus text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900">Operations on Functions</h4>
                                        <p class="text-sm text-gray-600">14 questions • Addition, subtraction, multiplication, and division of functions</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Quiz Deadline</label>
                                    <input type="datetime-local" id="operationsOnFunctionsQuizDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                    <div id="operationsOnFunctionsQuizDeadlineStatus" class="mt-2 text-sm">
                                        <!-- Deadline status will be shown here -->
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Limit (minutes)</label>
                                    <input type="number" id="operationsOnFunctionsQuizTimeLimit" min="5" max="120" value="30" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                </div>
                                <div class="flex items-end">
                                    <div class="flex flex-wrap gap-2 w-full">
                                        <button onclick="saveQuizSettings('operations-on-functions')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-save mr-2"></i>
                                            Save
                                        </button>
                                        <button onclick="viewQuizResults('operations-on-functions')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-chart-bar mr-2"></i>
                                            Results
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Real-Life Problems Quiz -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-globe text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900">Real-Life Problems</h4>
                                        <p class="text-sm text-gray-600">11 questions • Application of functions in real-world scenarios</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Quiz Deadline</label>
                                    <input type="datetime-local" id="realLifeProblemsQuizDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Limit (minutes)</label>
                                    <input type="number" id="realLifeProblemsQuizTimeLimit" min="5" max="120" value="30" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                                </div>
                                <div class="flex items-end">
                                    <div class="flex flex-wrap gap-2 w-full">
                                        <button onclick="saveQuizSettings('real-life-problems')" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-save mr-2"></i>
                                            Save
                                        </button>
                                        <button onclick="viewQuizResults('real-life-problems')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-chart-bar mr-2"></i>
                                            Results
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rational Functions Quiz -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-chart-line text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900">Rational Functions</h4>
                                        <p class="text-sm text-gray-600">11 questions • Understanding rational function properties and behavior</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Quiz Deadline</label>
                                    <input type="datetime-local" id="rationalFunctionsQuizDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Limit (minutes)</label>
                                    <input type="number" id="rationalFunctionsQuizTimeLimit" min="5" max="120" value="30" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div class="flex items-end">
                                    <div class="flex flex-wrap gap-2 w-full">
                                        <button onclick="saveQuizSettings('rational-functions')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-save mr-2"></i>
                                            Save
                                        </button>
                                        <button onclick="viewQuizResults('rational-functions')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-chart-bar mr-2"></i>
                                            Results
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Solving Rational Equations and Inequalities Quiz -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-br from-rose-500 to-pink-600 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-equals text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900">Solving Rational Equations and Inequalities</h4>
                                        <p class="text-sm text-gray-600">11 questions • Solving equations and inequalities involving rational functions</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Quiz Deadline</label>
                                    <input type="datetime-local" id="solvingRationalEquationsInequalitiesQuizDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-rose-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Limit (minutes)</label>
                                    <input type="number" id="solvingRationalEquationsInequalitiesQuizTimeLimit" min="5" max="120" value="30" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-rose-500">
                                </div>
                                <div class="flex items-end">
                                    <div class="flex flex-wrap gap-2 w-full">
                                        <button onclick="saveQuizSettings('solving-rational-equations-inequalities')" class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-save mr-2"></i>
                                            Save
                                        </button>
                                        <button onclick="viewQuizResults('solving-rational-equations-inequalities')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-chart-bar mr-2"></i>
                                            Results
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Representations of Rational Functions Quiz -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-chart-area text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900">Representations of Rational Functions</h4>
                                        <p class="text-sm text-gray-600">11 questions • Graphical, tabular, and algebraic representations</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Quiz Deadline</label>
                                    <input type="datetime-local" id="representationsOfRationalFunctionsQuizDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Limit (minutes)</label>
                                    <input type="number" id="representationsOfRationalFunctionsQuizTimeLimit" min="5" max="120" value="30" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                                </div>
                                <div class="flex items-end">
                                    <div class="flex flex-wrap gap-2 w-full">
                                        <button onclick="saveQuizSettings('representations-of-rational-functions')" class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-save mr-2"></i>
                                            Save
                                        </button>
                                        <button onclick="viewQuizResults('representations-of-rational-functions')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-chart-bar mr-2"></i>
                                            Results
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Domain and Range of Rational Functions Quiz -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-br from-lime-500 to-green-600 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-bullseye text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900">Domain and Range of Rational Functions</h4>
                                        <p class="text-sm text-gray-600">11 questions • Finding domain and range of rational functions</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Quiz Deadline</label>
                                    <input type="datetime-local" id="domainRangeRationalFunctionsQuizDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-lime-500 focus:border-lime-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Limit (minutes)</label>
                                    <input type="number" id="domainRangeRationalFunctionsQuizTimeLimit" min="5" max="120" value="30" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-lime-500 focus:border-lime-500">
                                </div>
                                <div class="flex items-end">
                                    <div class="flex flex-wrap gap-2 w-full">
                                        <button onclick="saveQuizSettings('domain-range-rational-functions')" class="bg-lime-600 hover:bg-lime-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-save mr-2"></i>
                                            Save
                                        </button>
                                        <button onclick="viewQuizResults('domain-range-rational-functions')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-chart-bar mr-2"></i>
                                            Results
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Domain and Range of Inverse Functions Quiz -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-yellow-600 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-exchange-alt text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900">Domain and Range of Inverse Functions</h4>
                                        <p class="text-sm text-gray-600">11 questions • Understanding inverse function domain and range relationships</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Quiz Deadline</label>
                                    <input type="datetime-local" id="domainRangeInverseFunctionsQuizDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Limit (minutes)</label>
                                    <input type="number" id="domainRangeInverseFunctionsQuizTimeLimit" min="5" max="120" value="30" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                                </div>
                                <div class="flex items-end">
                                    <div class="flex flex-wrap gap-2 w-full">
                                        <button onclick="saveQuizSettings('domain-range-inverse-functions')" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-save mr-2"></i>
                                            Save
                                        </button>
                                        <button onclick="viewQuizResults('domain-range-inverse-functions')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-chart-bar mr-2"></i>
                                            Results
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- One-to-One Functions Quiz -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-br from-violet-500 to-purple-600 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-fingerprint text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900">One-to-One Functions</h4>
                                        <p class="text-sm text-gray-600">11 questions • Understanding one-to-one function properties and testing</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Quiz Deadline</label>
                                    <input type="datetime-local" id="oneToOneFunctionsQuizDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-violet-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Limit (minutes)</label>
                                    <input type="number" id="oneToOneFunctionsQuizTimeLimit" min="5" max="120" value="30" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-violet-500">
                                </div>
                                <div class="flex items-end">
                                    <div class="flex flex-wrap gap-2 w-full">
                                        <button onclick="saveQuizSettings('one-to-one-functions')" class="bg-violet-600 hover:bg-violet-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-save mr-2"></i>
                                            Save
                                        </button>
                                        <button onclick="viewQuizResults('one-to-one-functions')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-chart-bar mr-2"></i>
                                            Results
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Quiz Content Wrapper -->
                </div>
                <!-- End Quiz Management Section -->

                <!-- Class Performance Section -->
                <div id="class-performance-section" class="content-section hidden">
                    <div class="mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Class Performance</h3>
                                <p class="text-sm text-gray-600">Select a class to view detailed student quiz scores and performance</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <div class="flex items-center space-x-2">
                                    <label for="classSelector" class="text-sm font-medium text-gray-700">Select Class:</label>
                                    <select id="classSelector" onchange="loadClassPerformance()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 min-w-[200px]">
                                        <option value="">Choose a class...</option>
                                    </select>
                                </div>
                                <button onclick="refreshPerformanceData()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                    <i class="fas fa-sync-alt mr-2"></i>
                                    Refresh
                                </button>
                                <button onclick="syncPerformanceData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                    <i class="fas fa-sync mr-2"></i>
                                    Sync Data
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Class Information -->
                    <div id="selectedClassInfo" class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200 hidden">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900" id="selectedClassName">Class Name</h4>
                                <p class="text-sm text-gray-600" id="selectedClassDetails">Class details will appear here</p>
                            </div>
                            <div class="flex items-center space-x-4 text-sm">
                                <div class="text-center">
                                    <div class="text-lg font-bold text-blue-600" id="selectedClassStudentCount">0</div>
                                    <div class="text-gray-600">Students</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-green-600" id="selectedClassApprovedCount">0</div>
                                    <div class="text-gray-600">Approved</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-purple-600" id="selectedClassAvgScore">0%</div>
                                    <div class="text-gray-600">Avg Score</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Table -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-4 py-3 bg-gradient-to-r from-indigo-50 to-purple-50 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <p class="text-sm text-gray-700 font-medium">
                                    <i class="fas fa-chart-line mr-2 text-indigo-600"></i>
                                    Student Quiz Performance Overview - All Topics
                                </p>
                                <p class="text-xs text-gray-600">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Click on any student to view detailed performance
                                </p>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                                    <tr>
                                        <th rowspan="2" class="px-3 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-r border-gray-300 sticky left-0 bg-gray-50 z-10">
                                            No.
                                        </th>
                                        <th rowspan="2" class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-r border-gray-300 sticky left-12 bg-gray-50 z-10 min-w-[180px]">
                                            Student Name
                                        </th>
                                        <th colspan="9" class="px-4 py-2 text-center text-xs font-bold text-indigo-700 uppercase tracking-wider border-r border-gray-300 bg-indigo-50">
                                            Quiz Scores (Best Attempt)
                                        </th>
                                        <th rowspan="2" class="px-4 py-3 text-center text-xs font-bold text-green-700 uppercase tracking-wider bg-green-50">
                                            Average<br/>Score
                                        </th>
                                    </tr>
                                    <tr>
                                        <!-- Quiz 1 -->
                                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 border-r border-gray-200 bg-indigo-50">
                                            <div class="flex flex-col items-center">
                                                <i class="fas fa-function text-indigo-600 mb-1"></i>
                                                <span>Functions</span>
                                                <span class="text-xs text-gray-500 font-normal">(100)</span>
                                            </div>
                                        </th>
                                        <!-- Quiz 2 -->
                                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 border-r border-gray-200 bg-orange-50">
                                            <div class="flex flex-col items-center">
                                                <i class="fas fa-calculator text-orange-600 mb-1"></i>
                                                <span>Evaluating</span>
                                                <span class="text-xs text-gray-500 font-normal">(100)</span>
                                            </div>
                                        </th>
                                        <!-- Quiz 3 -->
                                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 border-r border-gray-200 bg-purple-50">
                                            <div class="flex flex-col items-center">
                                                <i class="fas fa-plus-minus text-purple-600 mb-1"></i>
                                                <span>Operations</span>
                                                <span class="text-xs text-gray-500 font-normal">(100)</span>
                                            </div>
                                        </th>
                                        <!-- Quiz 4 -->
                                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 border-r border-gray-200 bg-teal-50">
                                            <div class="flex flex-col items-center">
                                                <i class="fas fa-globe text-teal-600 mb-1"></i>
                                                <span>Real-Life</span>
                                                <span class="text-xs text-gray-500 font-normal">(100)</span>
                                            </div>
                                        </th>
                                        <!-- Quiz 5 -->
                                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 border-r border-gray-200 bg-emerald-50">
                                            <div class="flex flex-col items-center">
                                                <i class="fas fa-divide text-emerald-600 mb-1"></i>
                                                <span>Rational</span>
                                                <span class="text-xs text-gray-500 font-normal">(100)</span>
                                            </div>
                                        </th>
                                        <!-- Quiz 6 -->
                                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 border-r border-gray-200 bg-rose-50">
                                            <div class="flex flex-col items-center">
                                                <i class="fas fa-equals text-rose-600 mb-1"></i>
                                                <span>Solving</span>
                                                <span class="text-xs text-gray-500 font-normal">(100)</span>
                                            </div>
                                        </th>
                                        <!-- Quiz 7 -->
                                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 border-r border-gray-200 bg-cyan-50">
                                            <div class="flex flex-col items-center">
                                                <i class="fas fa-chart-area text-cyan-600 mb-1"></i>
                                                <span>Representations</span>
                                                <span class="text-xs text-gray-500 font-normal">(100)</span>
                                            </div>
                                        </th>
                                        <!-- Quiz 8 -->
                                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 border-r border-gray-200 bg-lime-50">
                                            <div class="flex flex-col items-center">
                                                <i class="fas fa-arrows-alt-h text-lime-600 mb-1"></i>
                                                <span>Domain/Range</span>
                                                <span class="text-xs text-gray-500 font-normal">(100)</span>
                                            </div>
                                        </th>
                                        <!-- Quiz 9 -->
                                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 border-r border-gray-300 bg-violet-50">
                                            <div class="flex flex-col items-center">
                                                <i class="fas fa-exchange-alt text-violet-600 mb-1"></i>
                                                <span>One-to-One</span>
                                                <span class="text-xs text-gray-500 font-normal">(100)</span>
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="performanceTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- End Class Performance Section -->
            </main>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div id="studentDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col mx-4">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <div>
                    <h3 class="text-xl font-semibold text-gray-900" id="studentDetailsTitle">Student Details</h3>
                    <p class="text-sm text-gray-600" id="studentDetailsSubtitle">Detailed quiz performance and progress</p>
                </div>
                <button onclick="closeStudentDetails()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <div id="studentDetailsContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>



    <script src="js/main.js"></script>
    <script src="js/teacher-dashboard.js"></script>
    <script src="js/teacher-class-management.js"></script>
    <script src="js/pending-requests-modal.js"></script>
    <script src="js/view-students-modal.js"></script>
    <script src="js/session-manager.js"></script>
    
    <script>
        // Convert local datetime-local string to full UTC ISO string
        function toUTCISOStringFromLocal(localDateTimeValue) {
            if (!localDateTimeValue) return '';
            try {
                // Create a date object from the local time string
                const localDate = new Date(localDateTimeValue);
                if (isNaN(localDate.getTime())) return '';
                // Convert it to a full UTC ISO string (e.g., '2025-10-30T02:00:00.000Z')
                return localDate.toISOString();
            } catch (e) {
                console.error('Error converting local time to UTC:', e);
                return '';
            }
        }

        function toDatetimeLocalValueFromServer(serverDateString) {
            // Server returns a full UTC ISO string (e.g., ...Z)
            if (!serverDateString) return '';
            try {
                const date = new Date(serverDateString); // Parses ISO string into user's local time
                if (isNaN(date.getTime())) return '';

                // Get local components to format for datetime-local input
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0'); // getMonth is 0-indexed
                const day = date.getDate().toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');

                // Format as YYYY-MM-DDTHH:mm
                const result = `${year}-${month}-${day}T${hours}:${minutes}`;
                console.log(`Converting server time (UTC): ${serverDateString} → Local Input: ${result}`);
                return result;
            } catch (e) {
                console.error('Error converting UTC to local input time:', e);
                return '';
            }
        }
        // Debug function to check all elements
        function debugClassPerformance() {
            console.log('=== DEBUGGING CLASS PERFORMANCE SECTION ===');
            
            const section = document.getElementById('class-performance-section');
            console.log('Section element:', section);
            console.log('Section classes:', section ? section.className : 'NOT FOUND');
            console.log('Section hidden:', section ? section.classList.contains('hidden') : 'NOT FOUND');
            
            // Check all child elements
            if (section) {
                const children = section.children;
                console.log('Number of child elements:', children.length);
                for (let i = 0; i < children.length; i++) {
                    const child = children[i];
                    console.log(`Child ${i}:`, child.tagName, child.className, child.id);
                }
            }
            
            // Check specific elements
            const elements = [
                'classSelector',
                'performanceTableBody', 
                'selectedClassInfo',
                'classPerformanceSummary'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`${id}:`, element ? 'EXISTS' : 'NOT FOUND');
                if (element) {
                    console.log(`  - Classes: ${element.className}`);
                    console.log(`  - Hidden: ${element.classList.contains('hidden')}`);
                    console.log(`  - Visible: ${element.offsetParent !== null}`);
                }
            });
            
            alert('Check console for debug information');
        }

        // Force show function with inline styles
        function forceShowClassPerformance() {
            console.log('Force showing class performance section...');
            const section = document.getElementById('class-performance-section');
            if (section) {
                // Remove hidden class
                section.classList.remove('hidden');
                // Force with inline styles
                section.style.display = 'block';
                section.style.visibility = 'visible';
                section.style.opacity = '1';
                
                // Hide other sections
                const otherSections = document.querySelectorAll('.content-section:not(#class-performance-section)');
                otherSections.forEach(s => {
                    s.classList.add('hidden');
                    s.style.display = 'none';
                });
                
                console.log('Section forced to be visible with inline styles');
                alert('Class Performance section should now be visible!');
            }
        }

        // Test function to force show class performance section
        function testClassPerformance() {
            console.log('Testing class performance section...');
            
            // Force show the section
            const section = document.getElementById('class-performance-section');
            if (section) {
                section.classList.remove('hidden');
                console.log('Class performance section should now be visible');
                
                // Check if content elements exist
                const classSelector = document.getElementById('classSelector');
                const tableBody = document.getElementById('performanceTableBody');
                const selectedClassInfo = document.getElementById('selectedClassInfo');
                
                console.log('Class selector exists:', !!classSelector);
                console.log('Table body exists:', !!tableBody);
                console.log('Selected class info exists:', !!selectedClassInfo);
                
                // Force show some content to test
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-green-500"><i class="fas fa-check-circle mr-2"></i>Class Performance section is working! Please select a class.</td></tr>';
                }
                
                // Also force show the class selector
                if (classSelector) {
                    classSelector.style.display = 'block';
                    classSelector.style.visibility = 'visible';
                }
                
                // Force show the selected class info
                if (selectedClassInfo) {
                    selectedClassInfo.classList.remove('hidden');
                    selectedClassInfo.style.display = 'block';
                    selectedClassInfo.style.visibility = 'visible';
                }
                
                // Also hide other sections
                const otherSections = document.querySelectorAll('.content-section:not(#class-performance-section)');
                otherSections.forEach(s => s.classList.add('hidden'));
                
                // Update navigation
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    item.classList.remove('bg-indigo-50', 'text-indigo-700');
                    item.classList.add('text-gray-700');
                });
                
                const activeItem = document.querySelector('[data-section="class-performance"]');
                if (activeItem) {
                    activeItem.classList.remove('text-gray-700');
                    activeItem.classList.add('bg-indigo-50', 'text-indigo-700');
                }
                
                // Initialize the section
                initializeClassPerformance();
                
                alert('Class Performance section should now be visible! Check the page.');
            } else {
                console.error('Class performance section not found!');
                alert('Error: Class performance section not found!');
            }
        }

        // Navigation functionality
        function showSection(sectionName) {
            console.log('showSection called with:', sectionName);
            
            // Hide all content sections
            const sections = document.querySelectorAll('.content-section');
            console.log('Found sections:', sections.length);
            sections.forEach(section => {
                section.classList.add('hidden');
                console.log('Hiding section:', section.id);
            });

            // Show the selected section
            const targetSection = document.getElementById(sectionName + '-section');
            console.log('Target section element:', targetSection);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                console.log('Section shown:', sectionName + '-section');
                console.log('Section classes after show:', targetSection.className);
                
                // Verify the section is actually visible
                setTimeout(() => {
                    const isVisible = targetSection.offsetParent !== null;
                    console.log('Section visibility verified:', isVisible);
                    if (!isVisible) {
                        console.error('Section is still not visible after removing hidden class!');
                        console.log('Current classes:', targetSection.className);
                        console.log('Computed style display:', window.getComputedStyle(targetSection).display);
                        
                        // Auto-fix: Force show with inline styles
                        console.log('Auto-fixing with inline styles...');
                        targetSection.style.display = 'block';
                        targetSection.style.visibility = 'visible';
                        targetSection.style.opacity = '1';
                        targetSection.style.position = 'relative';
                        targetSection.style.zIndex = '1';
                        targetSection.style.height = 'auto';
                        targetSection.style.minHeight = '200px';
                        targetSection.style.width = '100%';
                        
                        // Also check parent containers
                        let parent = targetSection.parentElement;
                        while (parent && parent !== document.body) {
                            if (parent.style.display === 'none' || parent.classList.contains('hidden')) {
                                console.log('Found hidden parent:', parent.tagName, parent.className);
                                parent.style.display = 'block';
                                parent.classList.remove('hidden');
                            }
                            parent = parent.parentElement;
                        }
                        
                        // Verify again
                        setTimeout(() => {
                            const isNowVisible = targetSection.offsetParent !== null;
                            console.log('Section visibility after auto-fix:', isNowVisible);
                        }, 50);
                    }
                }, 100);
            } else {
                console.error('Section not found:', sectionName + '-section');
            }

            // Update navigation active state
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('bg-indigo-50', 'text-indigo-700');
                item.classList.add('text-gray-700');
            });

            const activeItem = document.querySelector(`[data-section="${sectionName}"]`);
            if (activeItem) {
                activeItem.classList.remove('text-gray-700');
                activeItem.classList.add('bg-indigo-50', 'text-indigo-700');
                console.log('Navigation updated for:', sectionName);
            } else {
                console.error('Navigation item not found for:', sectionName);
            }

            // Update page title and description
            updatePageHeader(sectionName);
            
            // Initialize specific sections
            if (sectionName === 'quiz-management') {
                console.log('Initializing quiz management...');
                initializeQuizManagement();
            } else if (sectionName === 'class-performance') {
                console.log('Initializing class performance...');
                // Clear quiz management state to avoid conflicts
                currentClassId = null;
                currentClassFilter = 'all';
                initializeClassPerformance();
            }
        }

        function updatePageHeader(sectionName) {
            const titles = {
                'dashboard': {
                    title: 'Dashboard',
                    description: 'Welcome to your teacher dashboard'
                },
                'class-management': {
                    title: 'Class Management',
                    description: 'Manage your classes and student enrollments'
                },
                'quiz-management': {
                    title: 'Quiz Management',
                    description: 'Manage quiz deadlines and view student performance'
                },
                'class-performance': {
                    title: 'Class Performance',
                    description: 'Track overall class performance across different topics'
                }
            };

            const pageTitle = document.getElementById('pageTitle');
            const pageDescription = document.getElementById('pageDescription');

            if (titles[sectionName]) {
                pageTitle.textContent = titles[sectionName].title;
                pageDescription.textContent = titles[sectionName].description;
            }
        }

        // Global functions for topic management
        async function toggleTopicLock(topicId, isLocked, classId) {
            try {
                const formData = new FormData();
                formData.append('action', 'toggle_topic_lock');
                formData.append('topic_id', topicId);
                formData.append('class_id', classId);
                formData.append('is_locked', isLocked);

                const response = await fetch('php/topic-management.php', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        Swal.fire({
                            title: 'Authentication Required',
                            text: 'Please log in again to continue.',
                            icon: 'warning',
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#6366f1'
                        }).then(() => {
                            window.location.href = 'teacher-login.html';
                        });
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    Swal.fire({
                        title: 'Success',
                        text: result.message,
                        icon: 'success',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6366f1'
                    });
                    
                    // Reload topics for the class
                    loadClassTopics(classId);
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: result.message || 'Failed to update topic lock status',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#ef4444'
                    });
                }
            } catch (error) {
                console.error('Error toggling topic lock:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'An error occurred while updating topic lock status',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        // Show topic management for specific class
        function showTopicManagement(classId, className) {
            currentClassId = classId; // Store current class ID globally
            const modal = document.getElementById('topicManagementModal');
            const titleElement = document.getElementById('topicManagementTitle');
            const subtitleElement = document.getElementById('topicManagementSubtitle');
            
            if (modal) {
                // Update modal title and subtitle
                if (titleElement) {
                    titleElement.textContent = `Topic Management - ${className}`;
                }
                if (subtitleElement) {
                    subtitleElement.textContent = `Control which topics students can access for ${className}`;
                }
                
                // Show modal
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
                
                // Load topics for this specific class
                loadClassTopics(classId);
            }
        }

        // Hide topic management
        function hideTopicManagement() {
            const modal = document.getElementById('topicManagementModal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // Restore background scrolling
            }
        }

        // Load topics for specific class
        async function loadClassTopics(classId) {
            try {
                console.log('Loading topics for class ID:', classId);
                const response = await fetch(`php/topic-management.php?action=get_class_topics&class_id=${classId}`, {
                    credentials: 'include'
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = 'teacher-login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const responseText = await response.text();
                console.log('Raw response:', responseText);

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    console.error('Response text:', responseText);
                    throw new Error('Invalid JSON response from server');
                }

                console.log('Parsed result:', result);

                if (result.success && result.topics) {
                    displayClassTopics(result.topics);
                } else {
                    console.error('Failed to load class topics:', result.message);
                    showTopicManagementError(result.message);
                }
            } catch (error) {
                console.error('Error loading class topics:', error);
                showTopicManagementError('Failed to load topics for this class');
            }
        }

        // Map topic names to their URL paths
        function getTopicUrl(topicName) {
            const topicUrlMap = {
                'Functions': 'topics/functions.html',
                'Evaluating Functions': 'topics/evaluating-functions.html',
                'Operations on Functions': 'topics/operations-on-functions.html',
                'Solving Real-Life Problems': 'topics/solving-real-life-problems.html',
                'Rational Functions': 'topics/rational-functions.html',
                'Representations of Rational Functions': 'topics/representations-of-rational-functions.html',
                'Domain and Range of Rational Functions': 'topics/domain-range-rational-functions.html',
                'Domain and Range of Inverse Functions': 'topics/domain-range-inverse-functions.html',
                'One-to-One Functions': 'topics/one-to-one-functions.html',
                'Solving Rational Equations and Inequalities': 'topics/solving-rational-equations-inequalities.html',
                'Simple Interest': 'topics/simple-interest.html',
                'Compound Interest': 'topics/compound-interest.html',
                'Interest, Maturity, Future, and Present Values': 'topics/interest-maturity-future-present-values.html',
                'Solving Problems: Simple and Compound Interest': 'topics/solving-problems-simple-compound-interest.html'
            };
            return topicUrlMap[topicName] || '#';
        }

        // Display topics for class
        function displayClassTopics(topics) {
            const container = document.getElementById('topicManagementList');
            const topicCountElement = document.getElementById('topicCount');
            
            if (!container) return;

            // Update topic count
            if (topicCountElement) {
                topicCountElement.textContent = topics.length;
            }

            if (topics.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-book-open text-3xl mb-2"></i>
                        <p>No topics available for this class</p>
                    </div>
                `;
                return;
            }

                // Separate topics by quarter
            const firstQuarterTopics = topics.filter(topic => topic.topic_order <= 10);
            const secondQuarterTopics = topics.filter(topic => topic.topic_order > 10);

            container.innerHTML = `
                <!-- 1st Quarter Section -->
                <div class="mb-8">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-200 via-indigo-200 to-purple-200 rounded-2xl flex items-center justify-center shadow-lg mr-4">
                            <i class="fas fa-function text-2xl text-blue-600"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold bg-gradient-to-r from-blue-500 to-indigo-500 bg-clip-text text-transparent">1st Quarter</h3>
                            <p class="text-sm text-gray-600">Functions and Rational Functions</p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        ${firstQuarterTopics.length > 0 ? firstQuarterTopics.map(topic => `
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                                <div class="flex items-center space-x-4">
                                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-book text-white text-sm"></i>
                                    </div>
                                    <div>
                                        <h5 class="font-semibold text-gray-900">${topic.topic_name}</h5>
                                        <p class="text-sm text-gray-600">${topic.description || 'No description available'}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="px-3 py-1 rounded-full text-sm font-medium ${topic.is_locked ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                                        ${topic.is_locked ? 'Locked' : 'Unlocked'}
                                    </span>
                                    <button onclick="toggleTopicLock('${topic.topic_id}', ${topic.is_locked}, '${topic.class_id}')" 
                                            class="p-2 rounded-lg transition-colors ${topic.is_locked ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-red-600 hover:bg-red-700 text-white'}"
                                            title="${topic.is_locked ? 'Unlock Topic' : 'Lock Topic'}">
                                        <i class="fas ${topic.is_locked ? 'fa-unlock' : 'fa-lock'}"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('') : `
                            <div class="text-center py-6 text-gray-500 bg-gray-50 rounded-lg border border-gray-200">
                                <i class="fas fa-book-open text-2xl mb-2"></i>
                                <p class="text-sm">No 1st Quarter topics available</p>
                            </div>
                        `}
                    </div>
                </div>

                <!-- 2nd Quarter Section -->
                <div class="mb-8">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-200 via-emerald-200 to-teal-200 rounded-2xl flex items-center justify-center shadow-lg mr-4">
                            <i class="fas fa-calculator text-2xl text-green-600"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold bg-gradient-to-r from-green-500 to-emerald-500 bg-clip-text text-transparent">2nd Quarter</h3>
                            <p class="text-sm text-gray-600">Financial Mathematics and Interest Calculations</p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        ${secondQuarterTopics.length > 0 ? secondQuarterTopics.map(topic => `
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                                <div class="flex items-center space-x-4">
                                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-calculator text-white text-sm"></i>
                                    </div>
                                    <div>
                                        <h5 class="font-semibold text-gray-900">${topic.topic_name}</h5>
                                        <p class="text-sm text-gray-600">${topic.description || 'No description available'}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="px-3 py-1 rounded-full text-sm font-medium ${topic.is_locked ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                                        ${topic.is_locked ? 'Locked' : 'Unlocked'}
                                    </span>
                                    <button onclick="toggleTopicLock('${topic.topic_id}', ${topic.is_locked}, '${topic.class_id}')" 
                                            class="p-2 rounded-lg transition-colors ${topic.is_locked ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-red-600 hover:bg-red-700 text-white'}"
                                            title="${topic.is_locked ? 'Unlock Topic' : 'Lock Topic'}">
                                        <i class="fas ${topic.is_locked ? 'fa-unlock' : 'fa-lock'}"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('') : `
                            <div class="text-center py-6 text-gray-500 bg-gray-50 rounded-lg border border-gray-200">
                                <i class="fas fa-calculator text-2xl mb-2"></i>
                                <p class="text-sm">No 2nd Quarter topics available</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // Show topic management error
        function showTopicManagementError(message) {
            const container = document.getElementById('topicManagementList');
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-exclamation-triangle text-3xl mb-2 text-red-400"></i>
                        <p class="text-sm">${message}</p>
                        <button onclick="loadClassTopics('${currentClassId}')" class="text-xs text-indigo-600 hover:text-indigo-700 mt-2 underline">
                            Try again
                        </button>
                    </div>
                `;
            }
        }

        // Lock all topics for the current class
        async function lockAllTopics() {
            if (!currentClassId) return;
            
            const result = await Swal.fire({
                title: 'Lock All Topics?',
                text: 'This will lock all topics for this class. Students will not be able to access any topics.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, lock all',
                cancelButtonText: 'Cancel'
            });

            if (result.isConfirmed) {
                try {
                    // Get all topics for this class
                    const response = await fetch(`php/topic-management.php?action=get_class_topics&class_id=${currentClassId}`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.topics) {
                            // Lock all unlocked topics
                            const unlockPromises = data.topics
                                .filter(topic => !topic.is_locked)
                                .map(topic => toggleTopicLock(topic.topic_id, false, topic.class_id));
                            
                            await Promise.all(unlockPromises);
                            
                            Swal.fire({
                                title: 'Success',
                                text: 'All topics have been locked',
                                icon: 'success',
                                confirmButtonText: 'OK'
                            });
                            
                            // Reload topics to show updated status
                            loadClassTopics(currentClassId);
                        }
                    }
                } catch (error) {
                    console.error('Error locking all topics:', error);
                    Swal.fire({
                        title: 'Error',
                        text: 'Failed to lock all topics',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            }
        }

        // Unlock all topics for the current class
        async function unlockAllTopics() {
            if (!currentClassId) return;
            
            const result = await Swal.fire({
                title: 'Unlock All Topics?',
                text: 'This will unlock all topics for this class. Students will be able to access all topics.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, unlock all',
                cancelButtonText: 'Cancel'
            });

            if (result.isConfirmed) {
                try {
                    // Get all topics for this class
                    const response = await fetch(`php/topic-management.php?action=get_class_topics&class_id=${currentClassId}`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.topics) {
                            // Unlock all locked topics
                            const lockPromises = data.topics
                                .filter(topic => topic.is_locked)
                                .map(topic => toggleTopicLock(topic.topic_id, true, topic.class_id));
                            
                            await Promise.all(lockPromises);
                            
                            Swal.fire({
                                title: 'Success',
                                text: 'All topics have been unlocked',
                                icon: 'success',
                                confirmButtonText: 'OK'
                            });
                            
                            // Reload topics to show updated status
                            loadClassTopics(currentClassId);
                        }
                    }
                } catch (error) {
                    console.error('Error unlocking all topics:', error);
                    Swal.fire({
                        title: 'Error',
                        text: 'Failed to unlock all topics',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            }
        }

        // Lock all 1st Quarter topics
        async function lockFirstQuarter() {
            if (!currentClassId) return;
            
            const result = await Swal.fire({
                title: 'Lock 1st Quarter Topics?',
                text: 'This will lock all 1st Quarter topics (Functions and Rational Functions) for this class.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3b82f6',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, lock 1st Quarter',
                cancelButtonText: 'Cancel'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`php/topic-management.php?action=get_class_topics&class_id=${currentClassId}`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.topics) {
                            // Lock all 1st quarter topics (order <= 10)
                            const firstQuarterPromises = data.topics
                                .filter(topic => topic.topic_order <= 10 && !topic.is_locked)
                                .map(topic => toggleTopicLock(topic.topic_id, false, topic.class_id));
                            
                            await Promise.all(firstQuarterPromises);
                            
                            Swal.fire({
                                title: 'Success',
                                text: 'All 1st Quarter topics have been locked',
                                icon: 'success',
                                confirmButtonText: 'OK'
                            });
                            
                            loadClassTopics(currentClassId);
                        }
                    }
                } catch (error) {
                    console.error('Error locking 1st quarter topics:', error);
                    Swal.fire({
                        title: 'Error',
                        text: 'Failed to lock 1st Quarter topics',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            }
        }

        // Lock all 2nd Quarter topics
        async function lockSecondQuarter() {
            if (!currentClassId) return;
            
            const result = await Swal.fire({
                title: 'Lock 2nd Quarter Topics?',
                text: 'This will lock all 2nd Quarter topics (Financial Mathematics) for this class.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, lock 2nd Quarter',
                cancelButtonText: 'Cancel'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`php/topic-management.php?action=get_class_topics&class_id=${currentClassId}`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.topics) {
                            // Lock all 2nd quarter topics (order > 10)
                            const secondQuarterPromises = data.topics
                                .filter(topic => topic.topic_order > 10 && !topic.is_locked)
                                .map(topic => toggleTopicLock(topic.topic_id, false, topic.class_id));
                            
                            await Promise.all(secondQuarterPromises);
                            
                            Swal.fire({
                                title: 'Success',
                                text: 'All 2nd Quarter topics have been locked',
                                icon: 'success',
                                confirmButtonText: 'OK'
                            });
                            
                            loadClassTopics(currentClassId);
                        }
                    }
                } catch (error) {
                    console.error('Error locking 2nd quarter topics:', error);
                    Swal.fire({
                        title: 'Error',
                        text: 'Failed to lock 2nd Quarter topics',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            }
        }

        // Initialize quiz management section
        function initializeQuizManagement() {
            console.log('Initializing quiz management section...');
            
            // Clear class performance state to avoid conflicts
            const classSelector = document.getElementById('classSelector');
            if (classSelector) {
                classSelector.value = '';
            }
            
            loadTeacherClasses(); // Load classes for selection
            
            // Ensure quizzes are hidden by default until class is selected
            const quizContentWrapper = document.getElementById('quizContentWrapper');
            
            if (quizContentWrapper) {
                quizContentWrapper.classList.add('hidden');
            }
            
            // Add test button for verifying connection
            console.log('✅ Quiz Management initialized - Ready to test connection with student page');
        }
        
        // TEST FUNCTION: Verify teacher can manage student quiz deadlines
        async function testQuizManagementConnection() {
            console.log('===========================================');
            console.log('🧪 TESTING QUIZ MANAGEMENT CONNECTION');
            console.log('===========================================');
            
            // Step 1: Check if class is selected
            const selectedClassElement = document.getElementById('quizClassSelector');
            const selectedClassId = selectedClassElement ? selectedClassElement.value : null;
            
            if (!selectedClassId) {
                console.error('❌ TEST FAILED: No class selected');
                console.log('📋 ACTION REQUIRED: Select a class from the dropdown first');
                await Swal.fire({
                    title: 'Test Failed',
                    html: `
                        <div class="text-left">
                            <p class="mb-3">❌ No class selected</p>
                            <p class="text-sm text-gray-600">Please select a class from the dropdown to run the test.</p>
                        </div>
                    `,
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#6366f1'
                });
                return;
            }
            
            console.log('✅ Step 1: Class selected - ID:', selectedClassId);
            
            // Step 2: Check if deadline input exists and has value
            const deadlineInput = document.getElementById('functionsQuizDeadline');
            if (!deadlineInput) {
                console.error('❌ TEST FAILED: Deadline input not found');
                return;
            }
            
            const currentDeadline = deadlineInput.value;
            console.log('✅ Step 2: Deadline input found');
            console.log('   Current value:', currentDeadline || '(empty)');
            
            // Step 3: Set a test deadline (tomorrow at 11:59 PM)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(23, 59, 0, 0);
            const testDeadline = tomorrow.toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:mm
            
            deadlineInput.value = testDeadline;
            console.log('✅ Step 3: Test deadline set to:', testDeadline);
            console.log('   Human readable:', tomorrow.toLocaleString('en-PH'));
            
            // Step 4: Save the settings
            console.log('📤 Step 4: Saving quiz settings...');
            
            try {
                await saveQuizSettings('functions');
                console.log('✅ Step 4: Save function called successfully');
                
                // Step 5: Wait a moment then verify it was saved
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                console.log('🔍 Step 5: Verifying save in database...');
                const verifyResponse = await fetch(`php/quiz-management.php?action=get_quiz_settings&class_id=${selectedClassId}`, {
                    credentials: 'include',
                    cache: 'no-store'
                });
                
                const verifyResult = await verifyResponse.json();
                
                if (verifyResult.success && verifyResult.settings && verifyResult.settings.functions) {
                    const savedSettings = verifyResult.settings.functions[selectedClassId];
                    if (savedSettings && savedSettings.deadline) {
                        console.log('✅ Step 5: Deadline saved in database!');
                        console.log('   Saved deadline:', savedSettings.deadline);
                        
                        // Step 6: Provide instructions for student verification
                        console.log('===========================================');
                        console.log('✅ TEST PASSED - TEACHER SIDE COMPLETE!');
                        console.log('===========================================');
                        console.log('');
                        console.log('📋 NEXT: Verify on Student Side');
                        console.log('1. Open student quizzes page (quizzes.html)');
                        console.log('2. Login as a student enrolled in class ID:', selectedClassId);
                        console.log('3. Open browser console (F12)');
                        console.log('4. Look for: "Functions Quiz" deadline');
                        console.log('5. Expected deadline:', tomorrow.toLocaleString('en-PH'));
                        console.log('');
                        console.log('Student should see:');
                        console.log('  ✓ Deadline displayed on Functions Quiz card');
                        console.log('  ✓ Countdown timer showing time remaining');
                        console.log('  ✓ Console log: "Using class-specific settings for functions"');
                        
                        await Swal.fire({
                            title: '✅ Test Passed!',
                            html: `
                                <div class="text-left space-y-3">
                                    <p class="font-semibold text-green-600">Teacher side is working correctly!</p>
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                        <p class="text-sm font-medium text-blue-800 mb-2">Test Results:</p>
                                        <ul class="text-sm text-blue-700 space-y-1">
                                            <li>✅ Class selected: ${selectedClassId}</li>
                                            <li>✅ Deadline set: ${tomorrow.toLocaleDateString()} ${tomorrow.toLocaleTimeString()}</li>
                                            <li>✅ Saved to database successfully</li>
                                        </ul>
                                    </div>
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                        <p class="text-sm font-medium text-yellow-800 mb-2">Next: Verify on Student Side</p>
                                        <ol class="text-sm text-yellow-700 space-y-1 list-decimal list-inside">
                                            <li>Open quizzes.html as student</li>
                                            <li>Check Functions Quiz card</li>
                                            <li>Verify deadline shows: ${tomorrow.toLocaleDateString()}</li>
                                            <li>Check browser console for logs</li>
                                        </ol>
                                    </div>
                                </div>
                            `,
                            icon: 'success',
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#10b981',
                            width: '600px'
                        });
                        
                    } else {
                        console.error('❌ Step 5: Deadline not found in database response');
                        console.log('Response:', verifyResult);
                    }
                } else {
                    console.error('❌ Step 5: Failed to verify save');
                    console.log('Response:', verifyResult);
                }
                
            } catch (error) {
                console.error('❌ TEST FAILED:', error);
                await Swal.fire({
                    title: 'Test Failed',
                    text: 'Error: ' + error.message,
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#ef4444'
                });
            }
        }
        
        // Initialize class performance section
        function initializeClassPerformance() {
            console.log('Initializing class performance section...');
            
            // Debug: Check if elements exist
            const tableBody = document.getElementById('performanceTableBody');
            const classSelector = document.getElementById('classSelector');
            
            console.log('Table body exists:', !!tableBody);
            console.log('Class selector exists:', !!classSelector);
            
            // Clear any previous class selection to avoid conflicts
            if (classSelector) {
                classSelector.value = '';
            }
            
            // Show a test message to verify the section is working
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-blue-500"><i class="fas fa-info-circle mr-2"></i>Class Performance section is loading...</td></tr>';
            }
            
            // Populate class selector with real-time data instead of old performance data
            populateClassSelectorWithRealData();
            
            // Initialize the table with default message
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-gray-500">Please select a class to view student quiz scores</td></tr>';
                console.log('Table initialized with default message');
            } else {
                console.error('Table body not found!');
            }
            
            // Hide summary initially
            if (summaryDiv) {
                summaryDiv.classList.add('hidden');
                console.log('Summary hidden');
            } else {
                console.error('Summary div not found!');
            }
        }

        // Quiz Management Functions
        async function saveQuizSettings(quizType) {
            try {
                console.log('=== SAVE QUIZ SETTINGS STARTED ===');
                console.log('Quiz Type:', quizType);
                
                // Require a class selection to manage quiz per specific class
                const selectedClassElement = document.getElementById('quizClassSelector');
                const selectedClassId = selectedClassElement && selectedClassElement.value ? selectedClassElement.value : currentClassId;
                const selectedClassName = selectedClassElement && selectedClassElement.selectedIndex > -1
                    ? selectedClassElement.options[selectedClassElement.selectedIndex].textContent.replace(/ \(\d+ students\)/, '')
                    : '';
                
                console.log('Selected Class ID:', selectedClassId);
                console.log('Selected Class Name:', selectedClassName);
                
                if (!selectedClassId) {
                    console.warn('No class selected!');
                    await Swal.fire({
                        title: 'Select a Class',
                        text: 'Please select a class first to apply quiz settings.',
                        icon: 'info',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6366f1'
                    });
                    return;
                }
                currentClassId = selectedClassId;
                
                // Convert quiz type to camelCase for element IDs
                const elementId = quizType.replace(/-([a-z])/g, (match, letter) => letter.toUpperCase());
                console.log('Element ID prefix:', elementId);
                
                const deadlineElement = document.getElementById(`${elementId}QuizDeadline`);
                const timeLimitElement = document.getElementById(`${elementId}QuizTimeLimit`);
                
                console.log('Deadline Element:', deadlineElement);
                console.log('Time Limit Element:', timeLimitElement);
                
                if (!deadlineElement || !timeLimitElement) {
                    console.error(`Elements not found for quiz type: ${quizType}`);
                    console.error(`Looking for: ${elementId}QuizDeadline and ${elementId}QuizTimeLimit`);
                    Swal.fire({
                        title: 'Error',
                        text: 'Quiz settings elements not found. Please refresh the page.',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6366f1'
                    });
                    return;
                }
                
                const deadlineLocal = deadlineElement.value;
                const timeLimit = timeLimitElement.value;
                
                console.log('Deadline Input Value (raw):', deadlineLocal);
                console.log('Time Limit Input Value:', timeLimit);
                
                // Keep as Philippine time - no conversion
                const deadline = toUTCISOStringFromLocal(deadlineLocal);
                
                console.log(`Saving quiz settings for ${quizType}:`);
                console.log(`  Deadline (formatted): ${deadline}`);
                console.log(`  Time limit: ${timeLimit} minutes`);
                console.log(`  Class ID: ${currentClassId}`);
                
                if (!deadline) {
                    Swal.fire({
                        title: 'Missing Information',
                        text: 'Please set a quiz deadline.',
                        icon: 'warning',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6366f1'
                    });
                    return;
                }

                const formData = new FormData();
                formData.append('action', 'save_quiz_settings');
                formData.append('quiz_type', quizType);
                formData.append('deadline', deadline);
                formData.append('time_limit', timeLimit);
                formData.append('class_id', currentClassId);

                console.log('Sending request to save quiz settings...');

                const response = await fetch('php/quiz-management.php', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    if (response.status === 401) {
                        Swal.fire({
                            title: 'Authentication Required',
                            text: 'Please log in again to continue.',
                            icon: 'warning',
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#6366f1'
                        }).then(() => {
                            window.location.href = 'teacher-login.html';
                        });
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Quiz settings save result:', result);

                // Handle authentication errors
                if (result.error_code === 'TEACHER_AUTH_REQUIRED') {
                    Swal.fire({
                        title: 'Authentication Required',
                        text: 'Please log in as a teacher to continue.',
                        icon: 'warning',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6366f1'
                    }).then(() => {
                        window.location.href = result.redirect || 'teacher-login.html';
                    });
                    return;
                }

                if (result.success) {
                    Swal.fire({
                        title: 'Settings Saved!',
                        html: `
                            <div class="text-center">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-check text-green-500 text-2xl"></i>
                                </div>
                                <p class="text-gray-700 mb-3">Quiz settings have been updated successfully for <strong>${selectedClassName}</strong>.</p>
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-3">
                                    <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                    <span class="text-sm text-blue-700">Students will see the updates within 3 seconds</span>
                                </div>
                                <div class="mt-3 text-xs text-gray-500">
                                    <strong>Quiz:</strong> ${quizType.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}<br>
                                    <strong>Deadline:</strong> ${deadline}<br>
                                    <strong>Time Limit:</strong> ${timeLimit} minutes
                                </div>
                            </div>
                        `,
                        icon: 'success',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6366f1'
                    });
                    
                    // Update status badge using correct element ID mapping
                    const elementId = quizType.replace(/-([a-z])/g, (match, letter) => letter.toUpperCase());
                    const statusElement = document.getElementById(`${elementId}QuizStatus`);
                    if (statusElement) {
                        statusElement.textContent = 'Active';
                        statusElement.className = 'text-sm bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full';
                    }
                    
                    // Reload settings and status to reflect saved data
                    await loadQuizSettings();
                    await loadQuizStatus();
                    
                    console.log('Quiz settings saved successfully - students will see updates within 5 seconds');
                } else {
                    console.error('Failed to save quiz settings:', result.message);
                    Swal.fire({
                        title: 'Error',
                        text: result.message || 'Failed to save quiz settings.',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6366f1'
                    });
                }
            } catch (error) {
                console.error('Error saving quiz settings:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'An error occurred while saving settings: ' + error.message,
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#6366f1'
                });
            }
        }

        // Clear evaluating functions quiz attempts
        async function clearEvaluatingFunctionsAttempts() {
            try {
                const result = await Swal.fire({
                    title: 'Clear Quiz Attempts',
                    text: 'This will clear all evaluating-functions quiz attempts. Are you sure?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, Clear All',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#6b7280'
                });
                
                if (result.isConfirmed) {
                    const response = await fetch('php/clear-evaluating-functions-attempts.php', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        Swal.fire({
                            title: 'Success!',
                            text: data.message,
                            icon: 'success',
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#10b981'
                        });
                        
                        // Refresh quiz statistics
                        loadQuizStatistics();
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: data.message,
                            icon: 'error',
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#ef4444'
                        });
                    }
                }
            } catch (error) {
                console.error('Error clearing attempts:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to clear quiz attempts',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#ef4444'
                });
            }
        }


        function showQuizResultsModal(quizType, results, statistics) {
            const quizTitle = getQuizTitle(quizType);
            const totalStudents = results.length;
            const averageScore = totalStudents > 0 ? Math.round(results.reduce((sum, student) => sum + parseFloat(student.percentage), 0) / totalStudents) : 0;
            const highestScore = totalStudents > 0 ? Math.max(...results.map(student => parseFloat(student.percentage))) : 0;
            
            let resultsTable = '';
            if (totalStudents > 0) {
                resultsTable = `
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2 text-left font-semibold text-gray-700">Rank</th>
                                    <th class="px-4 py-2 text-left font-semibold text-gray-700">Student</th>
                                    <th class="px-4 py-2 text-left font-semibold text-gray-700">Class</th>
                                    <th class="px-4 py-2 text-left font-semibold text-gray-700">Score</th>
                                    <th class="px-4 py-2 text-left font-semibold text-gray-700">Time</th>
                                    <th class="px-4 py-2 text-left font-semibold text-gray-700">Date</th>
                                    <th class="px-4 py-2 text-left font-semibold text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${results.map((student, index) => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-2 font-medium text-gray-900">${index + 1}</td>
                                        <td class="px-4 py-2 text-gray-900">${student.student_name}</td>
                                        <td class="px-4 py-2 text-gray-600">${student.class_name || 'N/A'}</td>
                                        <td class="px-4 py-2">
                                            <span class="font-medium">${student.score}/${student.total_questions}</span>
                                            <span class="text-gray-500 ml-1">(${student.percentage}%)</span>
                                        </td>
                                        <td class="px-4 py-2 text-gray-600">${student.formatted_time}</td>
                                        <td class="px-4 py-2 text-gray-500">${student.quiz_date}</td>
                                        <td class="px-4 py-2">
                                            <button onclick="resetStudentQuiz('${student.student_id}', '${quizType}', '${student.student_name}')" 
                                                    class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs font-medium transition-all duration-200">
                                                <i class="fas fa-redo mr-1"></i>
                                                Reset
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                resultsTable = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-chart-bar text-4xl mb-4 text-gray-300"></i>
                        <p class="text-lg">No students have completed this quiz yet</p>
                    </div>
                `;
            }

            Swal.fire({
                title: `${quizTitle} Results`,
                html: `
                    <div class="text-left">
                        <!-- Statistics -->
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold text-blue-600">${totalStudents}</div>
                                <div class="text-sm text-blue-500">Total Students</div>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold text-green-600">${averageScore}%</div>
                                <div class="text-sm text-green-500">Average Score</div>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold text-purple-600">${highestScore}%</div>
                                <div class="text-sm text-purple-500">Highest Score</div>
                            </div>
                        </div>
                        
                        <!-- Results Table -->
                        <div class="border rounded-lg overflow-hidden">
                            ${resultsTable}
                        </div>
                    </div>
                `,
                width: '900px',
                showConfirmButton: true,
                confirmButtonText: 'Close',
                confirmButtonColor: '#6366f1',
                customClass: {
                    popup: 'rounded-2xl',
                    title: 'text-slate-800',
                    content: 'text-slate-600'
                }
            });
        }

        function getQuizTitle(quizType) {
            const titles = {
                'functions': 'Functions Quiz',
                'evaluating-functions': 'Evaluating Functions Quiz',
                'operations-on-functions': 'Operations on Functions Quiz',
                'real-life-problems': 'Solving Real-Life Problems Quiz',
                'rational-functions': 'Rational Functions Quiz',
                'solving-rational-equations-inequalities': 'Solving Rational Equations and Inequalities Quiz',
                'representations-of-rational-functions': 'Representations of Rational Functions Quiz',
                'domain-range-rational-functions': 'Domain and Range of Rational Functions Quiz',
                'domain-range-inverse-functions': 'Domain and Range of Inverse Functions Quiz',
                'one-to-one-functions': 'One-to-One Functions Quiz'
            };
            return titles[quizType] || 'Quiz';
        }

        // Reset student quiz attempt
        async function resetStudentQuiz(studentId, quizType, studentName) {
            try {
                const result = await Swal.fire({
                    title: 'Reset Quiz Attempt?',
                    html: `
                        <div class="text-center">
                            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-redo text-red-500 text-2xl"></i>
                            </div>
                            <p class="text-lg text-gray-700 mb-4">Are you sure you want to reset the quiz attempt for:</p>
                            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                <div class="text-xl font-bold text-gray-800">${studentName}</div>
                                <div class="text-sm text-gray-500">${getQuizTitle(quizType)}</div>
                            </div>
                            <p class="text-sm text-gray-600">This will allow the student to retake the quiz.</p>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Yes, Reset Quiz',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#6b7280',
                    background: '#ffffff',
                    customClass: {
                        popup: 'rounded-2xl',
                        title: 'text-slate-800',
                        content: 'text-slate-600'
                    }
                });
                
                if (!result.isConfirmed) {
                    return;
                }
                
                // Show loading
                Swal.fire({
                    title: 'Resetting Quiz...',
                    text: 'Please wait while we reset the quiz attempt',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false,
                    background: '#ffffff',
                    customClass: {
                        popup: 'rounded-2xl',
                        title: 'text-slate-800',
                        content: 'text-slate-600'
                    },
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                const formData = new FormData();
                formData.append('action', 'reset_student_quiz');
                formData.append('student_id', studentId);
                formData.append('quiz_type', quizType);
                
                const response = await fetch('php/quiz-management.php', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        Swal.close();
                        Swal.fire({
                            title: 'Authentication Required',
                            text: 'Please log in again to continue.',
                            icon: 'warning',
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#6366f1'
                        }).then(() => {
                            window.location.href = 'teacher-login.html';
                        });
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Close loading
                Swal.close();
                
                if (data.success) {
                    Swal.fire({
                        title: 'Quiz Reset Successfully!',
                        text: `${studentName} can now retake the ${getQuizTitle(quizType)}.`,
                        icon: 'success',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#10b981',
                        background: '#ffffff',
                        customClass: {
                            popup: 'rounded-2xl',
                            title: 'text-slate-800',
                            content: 'text-slate-600'
                        }
                    });
                    
                    // Refresh the quiz results
                    await viewQuizResults(quizType);
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: data.message || 'Failed to reset quiz attempt',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#ef4444',
                        background: '#ffffff',
                        customClass: {
                            popup: 'rounded-2xl',
                            title: 'text-slate-800',
                            content: 'text-slate-600'
                        }
                    });
                }
            } catch (error) {
                console.error('Error resetting student quiz:', error);
                Swal.close();
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to reset quiz attempt',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#ef4444',
                    background: '#ffffff',
                    customClass: {
                        popup: 'rounded-2xl',
                        title: 'text-slate-800',
                        content: 'text-slate-600'
                    }
                });
            }
        }

        // Toggle quiz status (open/close)
        async function toggleQuizStatus(quizType) {
            try {
                // Require specific class selection
                const selectedClassElement = document.getElementById('quizClassSelector');
                const selectedClassId = selectedClassElement && selectedClassElement.value ? selectedClassElement.value : currentClassId;
                const action = document.getElementById(`${quizType.replace(/-([a-z])/g, (match, letter) => letter.toUpperCase())}QuizToggle`).textContent.includes('Close') ? 'close' : 'open';
                if (!selectedClassId) {
                    await Swal.fire({
                        title: 'Select a Class',
                        text: `Please select a class first to ${action} this quiz.`,
                        icon: 'info',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6366f1'
                    });
                    return;
                }
                currentClassId = selectedClassId;
                
                // Convert quiz type to camelCase for element IDs
                const elementId = quizType.replace(/-([a-z])/g, (match, letter) => letter.toUpperCase());
                const toggleButton = document.getElementById(`${elementId}QuizToggle`);
                const currentText = toggleButton.textContent.trim();
                const isCurrentlyOpen = currentText.includes('Close');
                
                const formData = new FormData();
                formData.append('action', 'toggle_quiz_status');
                formData.append('quiz_type', quizType);
                formData.append('is_open', isCurrentlyOpen ? '0' : '1');
                formData.append('class_id', currentClassId);

                const response = await fetch('php/quiz-management.php', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        Swal.fire({
                            title: 'Authentication Required',
                            text: 'Please log in again to continue.',
                            icon: 'warning',
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#6366f1'
                        }).then(() => {
                            window.location.href = 'teacher-login.html';
                        });
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // Handle authentication errors
                if (result.error_code === 'TEACHER_AUTH_REQUIRED') {
                    Swal.fire({
                        title: 'Authentication Required',
                        text: 'Please log in as a teacher to continue.',
                        icon: 'warning',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6366f1'
                    }).then(() => {
                        window.location.href = result.redirect || 'teacher-login.html';
                    });
                    return;
                }

                if (result.success) {
                    // Update button text and styling for all quizzes (now consistent)
                    if (isCurrentlyOpen) {
                        toggleButton.innerHTML = '<i class="fas fa-eye mr-2"></i>Open';
                        toggleButton.className = 'bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors';
                    } else {
                        toggleButton.innerHTML = '<i class="fas fa-eye-slash mr-2"></i>Close';
                        toggleButton.className = 'bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors';
                    }
                    
                    // Update status badge
                    const statusBadge = document.getElementById(`${elementId}QuizStatus`);
                    if (isCurrentlyOpen) {
                        statusBadge.textContent = 'Closed';
                        statusBadge.className = 'text-sm bg-red-100 text-red-700 px-3 py-1 rounded-full';
                    } else {
                        statusBadge.textContent = 'Open';
                        statusBadge.className = 'text-sm bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full';
                    }
                    
                    Swal.fire({
                        title: 'Quiz Status Updated!',
                        html: `
                            <div class="text-center">
                                <p class="text-gray-700 mb-3">Quiz has been ${isCurrentlyOpen ? 'closed' : 'opened'} successfully.</p>
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-3">
                                    <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                    <span class="text-sm text-blue-700">Students will see the updates within 3 seconds</span>
                                </div>
                            </div>
                        `,
                        icon: 'success',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6366f1'
                    });
                    
                    // Reload status to ensure UI is in sync
                    await loadQuizStatus();
                    
                    console.log(`Quiz ${quizType} ${isCurrentlyOpen ? 'closed' : 'opened'} - students will see updates within 3 seconds`);
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: result.message || 'Failed to update quiz status.',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6366f1'
                    });
                }
            } catch (error) {
                console.error('Error toggling quiz status:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'An error occurred while updating quiz status.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#6366f1'
                });
            }
        }

        // Global variables for class performance
        let performanceData = null;
        let filteredStudents = [];
        let currentSort = 'name';
        let currentClassFilter = 'all';
        let currentClassId = null;

        // Class Management Functions for Quiz Management
        async function loadTeacherClasses() {
            try {
                const response = await fetch('php/class-management.php?action=get_teacher_classes', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load classes');
                }

                const result = await response.json();
                
                if (result.success && result.classes) {
                    const quizClassSelector = document.getElementById('quizClassSelector');
                    quizClassSelector.innerHTML = '<option value="">Select a class...</option>';
                    
                    result.classes.forEach(classItem => {
                        const option = document.createElement('option');
                        option.value = classItem.id;
                        // Handle undefined student_count
                        const studentCount = classItem.student_count || 0;
                        option.textContent = `${classItem.class_name} (${studentCount} students)`;
                        quizClassSelector.appendChild(option);
                    });
                    
                    // Add event listener for class selection
                    quizClassSelector.addEventListener('change', function() {
                        const selectedClassId = this.value;
                        const selectedOption = this.options[this.selectedIndex];
                        
                        if (selectedClassId) {
                            updateSelectedClassInfo(selectedClassId, selectedOption.textContent);
                            currentClassId = selectedClassId;
                            // Show quiz content and hide no class message
                            showQuizContent();
                            // Refresh quiz statistics for the selected class
                            loadQuizStatistics();
                            // Load status and settings for the selected class
                            loadQuizStatus();
                            loadQuizSettings();
                        } else {
                            hideSelectedClassInfo();
                            currentClassId = null;
                            // Hide quiz content and show no class message
                            hideQuizContent();
                            // Clear quiz UI when no class is selected
                            clearQuizStatusUI();
                            clearQuizSettingsUI();
                            // Refresh quiz statistics for all classes
                            loadQuizStatistics();
                        }
                    });
                } else {
                    console.error('Failed to load classes:', result.message);
                    document.getElementById('quizClassSelector').innerHTML = '<option value="">No classes found</option>';
                }
            } catch (error) {
                console.error('Error loading classes:', error);
                document.getElementById('quizClassSelector').innerHTML = '<option value="">Error loading classes</option>';
            }
        }

        function updateSelectedClassInfo(classId, className) {
            const selectedClassInfo = document.getElementById('selectedClassInfo');
            const selectedClassName = document.getElementById('selectedClassName');
            const selectedClassStudentCount = document.getElementById('selectedClassStudentCount');
            
            // Extract student count from class name, handle undefined case
            const studentCountMatch = className.match(/\((\d+) students\)/);
            const studentCount = studentCountMatch ? studentCountMatch[1] : '0';
            
            // Clean up class name (remove student count from display)
            const cleanClassName = className.replace(/ \(\d+ students\)/, '');
            
            selectedClassName.textContent = cleanClassName;
            selectedClassStudentCount.textContent = studentCount;
            selectedClassInfo.classList.remove('hidden');
        }

        function hideSelectedClassInfo() {
            document.getElementById('selectedClassInfo').classList.add('hidden');
        }

        function showQuizContent() {
            document.getElementById('noClassSelectedMessage').classList.add('hidden');
            document.getElementById('quizContentWrapper').classList.remove('hidden');
        }

        function hideQuizContent() {
            document.getElementById('noClassSelectedMessage').classList.remove('hidden');
            document.getElementById('quizContentWrapper').classList.add('hidden');
        }

        function refreshClassData() {
            loadTeacherClasses();
        }

        // Update viewQuizResults to include class filtering
        async function viewQuizResults(quizType) {
            try {
                // Check if a class is selected
                if (!currentClassId) {
                    Swal.fire({
                        title: 'No Class Selected',
                        text: 'Please select a class first to view quiz results.',
                        icon: 'warning',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6366f1'
                    });
                    return;
                }

                // Show loading
                Swal.fire({
                    title: 'Loading Results...',
                    text: 'Please wait while we fetch the quiz results.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const response = await fetch(`php/quiz-management.php?action=get_quiz_results&quiz_type=${quizType}&class_id=${currentClassId}`, {
                    credentials: 'include',
                    cache: 'no-store'
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        Swal.close();
                        Swal.fire({
                            title: 'Authentication Required',
                            text: 'Please log in again to continue.',
                            icon: 'warning',
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#6366f1'
                        }).then(() => {
                            window.location.href = 'teacher-login.html';
                        });
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success && result.results && result.results.length > 0) {
                    const results = result.results;
                    const statistics = result.statistics || {};
                    
                    // Close loading
                    Swal.close();
                    
                    // Show results in a detailed modal
                    showQuizResultsModal(quizType, results, statistics);
                } else {
                    Swal.close();
                    Swal.fire({
                        title: 'No Results',
                        text: 'No students have completed this quiz yet.',
                        icon: 'info',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6366f1'
                    });
                }
            } catch (error) {
                console.error('Error fetching quiz results:', error);
                Swal.close();
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to load quiz results.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#6366f1'
                });
            }
        }

        // Load quiz statistics and status on page load
        // Profile Dropdown Functions
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            const icon = document.getElementById('profileDropdownIcon');
            
            if (dropdown && icon) {
                dropdown.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            // Close notification dropdown
            const notifDropdown = document.getElementById('notificationDropdown');
            const notifBtn = document.getElementById('notificationBtn');
            if (notifDropdown && notifBtn && !notifDropdown.contains(event.target) && !notifBtn.contains(event.target)) {
                notifDropdown.classList.add('hidden');
            }
            
            // Close profile dropdown
            const profileDropdown = document.getElementById('profileDropdown');
            const profileContainer = document.getElementById('profileDropdownContainer');
            if (profileDropdown && profileContainer && !profileContainer.contains(event.target)) {
                profileDropdown.classList.add('hidden');
                const icon = document.getElementById('profileDropdownIcon');
                if (icon) icon.classList.remove('rotate-180');
            }
        });

        // Notification System Variables
        let notifications = [];
        let notificationCheckInterval;

        document.addEventListener('DOMContentLoaded', async function() {
            // Show loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }
            
            // Load teacher profile info for header
            try {
                console.log('🔍 Starting teacher profile fetch...');
                const response = await fetch('php/get-teacher-profile.php', {
                    credentials: 'include'
                });
                
                console.log('📡 Response received:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('📊 Profile data:', result);
                    
                    if (result.success && result.teacher) {
                        const teacher = result.teacher;
                        console.log('👨‍🏫 Teacher found:', teacher);
                        
                        // Build name safely
                        const firstName = teacher.first_name || '';
                        const lastName = teacher.last_name || '';
                        const teacherName = firstName + ' ' + lastName;
                        console.log('✏️ Teacher name:', teacherName);
                        
                        // Update all profile elements with validation
                        const elements = {
                            'headerTeacherName': teacherName || 'Teacher',
                            'headerTeacherEmail': teacher.email || 'No email',
                            'dropdownTeacherName': teacherName || 'Teacher',
                            'dropdownTeacherEmail': teacher.email || 'No email',
                            'dropdownTeacherId': teacher.teacher_id_number || 'N/A',
                            'dropdownTeacherDept': teacher.department || 'N/A',
                            'dropdownTeacherSubject': teacher.subject || 'N/A'
                        };
                        
                        // Update each element with logging
                        for (const [id, value] of Object.entries(elements)) {
                            const element = document.getElementById(id);
                            if (element) {
                                element.textContent = value;
                                console.log(`✅ Updated ${id}:`, value);
                            } else {
                                console.error(`❌ Element not found: ${id}`);
                            }
                        }
                        
                        console.log('🎉 Teacher profile loaded successfully!');
                        
                    } else {
                        console.error('❌ Invalid teacher data in response:', result);
                        // Set default values
                        document.getElementById('headerTeacherName').textContent = 'Teacher';
                        document.getElementById('headerTeacherEmail').textContent = 'teacher@mathease.com';
                    }
                } else {
                    const errorText = await response.text();
                    console.error('❌ Server error:', response.status, errorText);
                    // Set default values
                    document.getElementById('headerTeacherName').textContent = 'Teacher';
                    document.getElementById('headerTeacherEmail').textContent = 'teacher@mathease.com';
                }
            } catch (error) {
                console.error('💥 Network error:', error.message);
                console.error('Full error:', error);
                // Set default values
                const headerName = document.getElementById('headerTeacherName');
                if (headerName) headerName.textContent = 'Teacher';
                const headerEmail = document.getElementById('headerTeacherEmail');
                if (headerEmail) headerEmail.textContent = 'teacher@mathease.com';
            }
            
            try {
                // Initialize dashboard
                showSection('dashboard');
                
                // Load class data first
                await loadTeacherClasses();
                
                // Load quiz data (will be filtered by selected class)
                await loadQuizStatistics();
                await loadQuizStatus();
                await loadQuizSettings();
                
                // Load class performance data
                await loadClassPerformanceData();
                
                // Load notifications
                await loadNotifications();
                
                // Check for new notifications every 30 seconds
                notificationCheckInterval = setInterval(loadNotifications, 30000);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            } finally {
                // Hide loading overlay after all data is loaded
                if (loadingOverlay) {
                    setTimeout(() => {
                        loadingOverlay.style.opacity = '0';
                        loadingOverlay.style.transition = 'opacity 0.3s ease-out';
                        setTimeout(() => {
                            loadingOverlay.style.display = 'none';
                        }, 300);
                    }, 500);
                }
            }
            
            // Add modal close functionality
            const modal = document.getElementById('topicManagementModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        hideTopicManagement();
                    }
                });
            }
        });

        // Notification Functions
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown) {
                dropdown.classList.toggle('hidden');
                if (!dropdown.classList.contains('hidden')) {
                    loadNotifications();
                }
            }
        }

        async function loadNotifications() {
            try {
                const response = await fetch('php/get-notifications.php', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    notifications = result.notifications || [];
                    displayNotifications(notifications);
                    updateNotificationBadge(result.unread_count || 0);
                } else {
                    console.error('Failed to load notifications:', result.message);
                    displayNotificationError();
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                displayNotificationError();
            }
        }

        function displayNotifications(notifs) {
            const list = document.getElementById('notificationList');
            if (!list) return;
            
            if (notifs.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-bell-slash text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500 text-sm">No notifications yet</p>
                        <p class="text-gray-400 text-xs mt-1">We'll notify you about class updates</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = notifs.map(notif => {
                const isUnread = notif.is_read === '0' || notif.is_read === 0;
                const timeAgo = getTimeAgo(notif.created_at);
                
                return `
                    <div class="notification-item p-4 border-b border-gray-100 hover:bg-gray-50 transition-colors cursor-pointer ${
                        isUnread ? 'bg-indigo-50' : ''
                    }" onclick="markNotificationAsRead(${notif.id})">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center ${
                                getNotificationIconBg(notif.type)
                            }">
                                <i class="${getNotificationIcon(notif.type)} text-white text-sm"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between">
                                    <p class="text-sm font-medium text-gray-900">${notif.title}</p>
                                    ${isUnread ? '<span class="flex-shrink-0 w-2 h-2 bg-indigo-600 rounded-full"></span>' : ''}
                                </div>
                                <p class="text-xs text-gray-600 mt-1">${notif.message}</p>
                                <div class="flex items-center mt-2 space-x-3">
                                    <span class="text-xs text-gray-500">
                                        <i class="fas fa-clock mr-1"></i>${timeAgo}
                                    </span>
                                    ${notif.class_name ? `
                                        <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded">
                                            <i class="fas fa-chalkboard-teacher mr-1"></i>${notif.class_name}
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayNotificationError() {
            const list = document.getElementById('notificationList');
            if (!list) return;
            
            list.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-300 mb-3"></i>
                    <p class="text-gray-500 text-sm">Failed to load notifications</p>
                    <button onclick="loadNotifications()" class="mt-3 text-xs text-indigo-600 hover:text-indigo-700 underline">
                        Try again
                    </button>
                </div>
            `;
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            if (!badge) return;
            
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function getNotificationIcon(type) {
            const icons = {
                'enrollment': 'fas fa-user-plus',
                'class_update': 'fas fa-chalkboard-teacher',
                'quiz_submitted': 'fas fa-file-alt',
                'deadline': 'fas fa-clock',
                'performance': 'fas fa-chart-line',
                'system': 'fas fa-info-circle'
            };
            return icons[type] || 'fas fa-bell';
        }

        function getNotificationIconBg(type) {
            const backgrounds = {
                'enrollment': 'bg-green-500',
                'class_update': 'bg-blue-500',
                'quiz_submitted': 'bg-purple-500',
                'deadline': 'bg-orange-500',
                'performance': 'bg-indigo-500',
                'system': 'bg-gray-500'
            };
            return backgrounds[type] || 'bg-indigo-500';
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const notifTime = new Date(timestamp);
            const diffMs = now - notifTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return notifTime.toLocaleDateString();
        }

        async function markNotificationAsRead(notificationId) {
            try {
                const response = await fetch('php/get-notifications.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    credentials: 'include',
                    body: `action=mark_read&notification_id=${notificationId}`
                });
                
                if (response.ok) {
                    await loadNotifications();
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        async function markAllAsRead() {
            try {
                const response = await fetch('php/get-notifications.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    credentials: 'include',
                    body: 'action=mark_all_read'
                });
                
                if (response.ok) {
                    await loadNotifications();
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
            }
        }

        function viewAllNotifications() {
            // Close dropdown
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
            
            // Show all notifications in a modal or separate section
            Swal.fire({
                title: 'All Notifications',
                html: '<p class="text-gray-600">Full notification history view coming soon!</p>',
                icon: 'info',
                confirmButtonText: 'OK',
                confirmButtonColor: '#6366f1'
            });
        }

        async function loadQuizStatistics() {
            try {
                // Include class ID in the request if a class is selected
                const url = currentClassId 
                    ? `php/quiz-management.php?action=get_quiz_statistics&class_id=${currentClassId}`
                    : 'php/quiz-management.php?action=get_quiz_statistics';
                
                const response = await fetch(url, {
                    credentials: 'include',
                    cache: 'no-store'
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        console.error('Authentication failed - redirecting to login');
                        window.location.href = 'teacher-login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // Handle authentication errors
                if (result.error_code === 'TEACHER_AUTH_REQUIRED') {
                    console.error('Teacher authentication required - redirecting to login');
                    window.location.href = result.redirect || 'teacher-login.html';
                    return;
                }

                if (result.success && result.statistics) {
                    const stats = result.statistics;
                    
                    // Update Functions Quiz stats
                    if (stats.functions) {
                        const statsElement = document.getElementById('functionsQuizStats');
                        if (statsElement) {
                            const classText = currentClassId ? ' (selected class)' : '';
                            statsElement.textContent = `${stats.functions.completed || 0} students completed${classText}`;
                        }
                    }
                    
                    // Update Evaluating Functions Quiz stats
                    if (stats['evaluating-functions']) {
                        const statsElement = document.getElementById('evaluatingFunctionsQuizStats');
                        if (statsElement) {
                            const classText = currentClassId ? ' (selected class)' : '';
                            statsElement.textContent = `${stats['evaluating-functions'].completed || 0} students completed${classText}`;
                        }
                    }
                    
                    // Update Operations on Functions Quiz stats
                    if (stats['operations-on-functions']) {
                        const statsElement = document.getElementById('operationsOnFunctionsQuizStats');
                        if (statsElement) {
                            const classText = currentClassId ? ' (selected class)' : '';
                            statsElement.textContent = `${stats['operations-on-functions'].completed || 0} students completed${classText}`;
                        }
                    }
                    
                    // Update Rational Functions Quiz stats
                    if (stats['rational-functions']) {
                        const statsElement = document.getElementById('rationalFunctionsQuizStats');
                        if (statsElement) {
                            statsElement.textContent = `${stats['rational-functions'].completed || 0} students completed`;
                        }
                    }
                    
                    // Update Solving Rational Equations and Inequalities Quiz stats
                    if (stats['solving-rational-equations-inequalities']) {
                        const statsElement = document.getElementById('solvingRationalEquationsInequalitiesQuizStats');
                        if (statsElement) {
                            statsElement.textContent = `${stats['solving-rational-equations-inequalities'].completed || 0} students completed`;
                        }
                    }
                    
                    // Update Representations of Rational Functions Quiz stats
                    if (stats['representations-of-rational-functions']) {
                        const statsElement = document.getElementById('representationsOfRationalFunctionsQuizStats');
                        if (statsElement) {
                            statsElement.textContent = `${stats['representations-of-rational-functions'].completed || 0} students completed`;
                        }
                    }
                    
                    // Update Domain and Range of Rational Functions Quiz stats
                    if (stats['domain-range-rational-functions']) {
                        const statsElement = document.getElementById('domainRangeRationalFunctionsQuizStats');
                        if (statsElement) {
                            statsElement.textContent = `${stats['domain-range-rational-functions'].completed || 0} students completed`;
                        }
                    }
                    
                    // Update Domain and Range of Inverse Functions Quiz stats
                    if (stats['domain-range-inverse-functions']) {
                        const statsElement = document.getElementById('domainRangeInverseFunctionsQuizStats');
                        if (statsElement) {
                            statsElement.textContent = `${stats['domain-range-inverse-functions'].completed || 0} students completed`;
                        }
                    }
                    
                    // Update One-to-One Functions Quiz stats
                    if (stats['one-to-one-functions']) {
                        const statsElement = document.getElementById('oneToOneFunctionsQuizStats');
                        if (statsElement) {
                            statsElement.textContent = `${stats['one-to-one-functions'].completed || 0} students completed`;
                        }
                    }
                    
                    // Update Solving Real-Life Problems Quiz stats
                    if (stats['real-life-problems']) {
                        const statsElement = document.getElementById('realLifeProblemsQuizStats');
                        if (statsElement) {
                            statsElement.textContent = `${stats['real-life-problems'].completed || 0} students completed`;
                        }
                    }
                } else {
                    console.warn('Quiz statistics not available:', result.message);
                }
            } catch (error) {
                console.error('Error loading quiz statistics:', error);
            }
        }

        async function loadQuizStatus() {
            try {
                if (!currentClassId) {
                    console.log('No class selected, clearing quiz status UI');
                    clearQuizStatusUI();
                    return;
                }
                
                // Include class ID in the request if a class is selected
                const url = currentClassId 
                    ? `php/quiz-management.php?action=get_quiz_status&class_id=${currentClassId}`
                    : 'php/quiz-management.php?action=get_quiz_status';
                
                const response = await fetch(url, {
                    credentials: 'include',
                    cache: 'no-store'
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        console.error('Authentication failed - redirecting to login');
                        window.location.href = 'teacher-login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success && result.status) {
                    const status = result.status;
                    console.log('Quiz status loaded for class:', currentClassId, status);
                    
                    // Update Functions Quiz status
                    if (status.functions !== undefined) {
                        updateQuizStatusFields('functions', status.functions);
                    } else {
                        clearQuizStatusFields('functions');
                    }
                    
                    // Update Evaluating Functions Quiz status
                    if (status['evaluating-functions'] !== undefined) {
                        updateQuizStatusFields('evaluating-functions', status['evaluating-functions']);
                    } else {
                        clearQuizStatusFields('evaluating-functions');
                    }
                    
                    // Update Operations on Functions Quiz status
                    if (status['operations-on-functions'] !== undefined) {
                        updateQuizStatusFields('operations-on-functions', status['operations-on-functions']);
                    } else {
                        clearQuizStatusFields('operations-on-functions');
                    }
                    
                    // Update Real-Life Problems Quiz status
                    if (status['real-life-problems'] !== undefined) {
                        updateQuizStatusFields('real-life-problems', status['real-life-problems']);
                    } else {
                        clearQuizStatusFields('real-life-problems');
                    }
                    
                    // Update Rational Functions Quiz status
                    if (status['rational-functions'] !== undefined) {
                        updateQuizStatusFields('rational-functions', status['rational-functions']);
                    } else {
                        clearQuizStatusFields('rational-functions');
                    }
                    
                    // Update Solving Rational Equations and Inequalities Quiz status
                    if (status['solving-rational-equations-inequalities'] !== undefined) {
                        updateQuizStatusFields('solving-rational-equations-inequalities', status['solving-rational-equations-inequalities']);
                    } else {
                        clearQuizStatusFields('solving-rational-equations-inequalities');
                    }
                    
                    // Update Representations of Rational Functions Quiz status
                    if (status['representations-of-rational-functions'] !== undefined) {
                        updateQuizStatusFields('representations-of-rational-functions', status['representations-of-rational-functions']);
                    } else {
                        clearQuizStatusFields('representations-of-rational-functions');
                    }
                    
                    // Update Domain and Range of Rational Functions Quiz status
                    if (status['domain-range-rational-functions'] !== undefined) {
                        updateQuizStatusFields('domain-range-rational-functions', status['domain-range-rational-functions']);
                    } else {
                        clearQuizStatusFields('domain-range-rational-functions');
                    }
                    
                    // Update Domain and Range of Inverse Functions Quiz status
                    if (status['domain-range-inverse-functions'] !== undefined) {
                        updateQuizStatusFields('domain-range-inverse-functions', status['domain-range-inverse-functions']);
                    } else {
                        clearQuizStatusFields('domain-range-inverse-functions');
                    }
                    
                    // Update One-to-One Functions Quiz status
                    if (status['one-to-one-functions'] !== undefined) {
                        updateQuizStatusFields('one-to-one-functions', status['one-to-one-functions']);
                    } else {
                        clearQuizStatusFields('one-to-one-functions');
                    }
                } else {
                    console.log('No quiz status found for class:', currentClassId);
                    clearQuizStatusUI();
                }
            } catch (error) {
                console.error('Error loading quiz status:', error);
                clearQuizStatusUI();
            }
        }
        // Helper function to update quiz status fields
        function updateQuizStatusFields(quizType, isOpen) {
            const toggleButton = document.getElementById(`${quizType.replace(/-([a-z])/g, (match, letter) => letter.toUpperCase())}QuizToggle`);
            const statusBadge = document.getElementById(`${quizType.replace(/-([a-z])/g, (match, letter) => letter.toUpperCase())}QuizStatus`);
            
            if (toggleButton && statusBadge) {
                if (isOpen) {
                    // Quiz is open
                    toggleButton.innerHTML = '<i class="fas fa-eye-slash mr-2"></i>Close';
                    toggleButton.className = 'bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors';
                    statusBadge.textContent = 'Open';
                    statusBadge.className = 'text-sm bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full';
                } else {
                    // Quiz is closed
                    toggleButton.innerHTML = '<i class="fas fa-eye mr-2"></i>Open';
                    toggleButton.className = 'bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors';
                    statusBadge.textContent = 'Closed';
                    statusBadge.className = 'text-sm bg-red-100 text-red-700 px-3 py-1 rounded-full';
                }
            }
        }
        
        // Helper function to clear quiz status fields
        function clearQuizStatusFields(quizType) {
            const statusElement = document.getElementById(`${quizType.replace(/-([a-z])/g, (match, letter) => letter.toUpperCase())}QuizStatus`);
            const toggleButton = document.getElementById(`${quizType.replace(/-([a-z])/g, (match, letter) => letter.toUpperCase())}QuizToggle`);
            
            if (statusElement) {
                statusElement.textContent = 'Not Set';
                statusElement.className = 'text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full';
            }
            if (toggleButton) {
                toggleButton.textContent = 'Open Quiz';
                toggleButton.className = 'bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors';
            }
        }
        
        // Helper function to clear all quiz status UI
        function clearQuizStatusUI() {
            const quizTypes = ['functions', 'evaluating-functions', 'operations-on-functions', 'real-life-problems', 'rational-functions', 'solving-rational-equations-inequalities', 'representations-of-rational-functions', 'domain-range-rational-functions', 'domain-range-inverse-functions', 'one-to-one-functions'];
            
            quizTypes.forEach(quizType => {
                clearQuizStatusFields(quizType);
            });
        }

        async function loadQuizSettings() {
            try {
                if (!currentClassId) {
                    console.log('No class selected, clearing quiz settings UI');
                    clearQuizSettingsUI();
                    return;
                }
                
                // Include class ID in the request if a class is selected
                const url = currentClassId 
                    ? `php/quiz-management.php?action=get_quiz_settings&class_id=${currentClassId}`
                    : 'php/quiz-management.php?action=get_quiz_settings';
                
                const response = await fetch(url, {
                    credentials: 'include',
                    cache: 'no-store'
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        console.error('Authentication failed - redirecting to login');
                        window.location.href = 'teacher-login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success && result.settings) {
                    const settings = result.settings;
                    console.log('Quiz settings loaded for class:', currentClassId, settings);
                    
                    // Update Functions Quiz settings
                    if (settings.functions && settings.functions[currentClassId]) {
                        const functionsSettings = settings.functions[currentClassId];
                        updateQuizSettingsFields('functions', functionsSettings);
                    } else {
                        clearQuizSettingsFields('functions');
                    }
                    
                    // Update Evaluating Functions Quiz settings
                    if (settings['evaluating-functions'] && settings['evaluating-functions'][currentClassId]) {
                        const evaluatingSettings = settings['evaluating-functions'][currentClassId];
                        updateQuizSettingsFields('evaluating-functions', evaluatingSettings);
                    } else {
                        clearQuizSettingsFields('evaluating-functions');
                    }
                    
                    // Update Operations on Functions Quiz settings
                    if (settings['operations-on-functions'] && settings['operations-on-functions'][currentClassId]) {
                        const operationsSettings = settings['operations-on-functions'][currentClassId];
                        updateQuizSettingsFields('operations-on-functions', operationsSettings);
                    } else {
                        clearQuizSettingsFields('operations-on-functions');
                    }
                    
                    // Update Real-Life Problems Quiz settings
                    if (settings['real-life-problems'] && settings['real-life-problems'][currentClassId]) {
                        const realLifeSettings = settings['real-life-problems'][currentClassId];
                        updateQuizSettingsFields('real-life-problems', realLifeSettings);
                    } else {
                        clearQuizSettingsFields('real-life-problems');
                    }
                    
                    // Update Rational Functions Quiz settings
                    if (settings['rational-functions'] && settings['rational-functions'][currentClassId]) {
                        const rationalSettings = settings['rational-functions'][currentClassId];
                        updateQuizSettingsFields('rational-functions', rationalSettings);
                    } else {
                        clearQuizSettingsFields('rational-functions');
                    }
                    
                    // Update Solving Rational Equations and Inequalities Quiz settings
                    if (settings['solving-rational-equations-inequalities'] && settings['solving-rational-equations-inequalities'][currentClassId]) {
                        const solvingSettings = settings['solving-rational-equations-inequalities'][currentClassId];
                        updateQuizSettingsFields('solving-rational-equations-inequalities', solvingSettings);
                    } else {
                        clearQuizSettingsFields('solving-rational-equations-inequalities');
                    }
                    
                    // Update Representations of Rational Functions Quiz settings
                    if (settings['representations-of-rational-functions'] && settings['representations-of-rational-functions'][currentClassId]) {
                        const representationsSettings = settings['representations-of-rational-functions'][currentClassId];
                        updateQuizSettingsFields('representations-of-rational-functions', representationsSettings);
                    } else {
                        clearQuizSettingsFields('representations-of-rational-functions');
                    }
                    
                    // Update Domain and Range of Rational Functions Quiz settings
                    if (settings['domain-range-rational-functions'] && settings['domain-range-rational-functions'][currentClassId]) {
                        const domainRangeSettings = settings['domain-range-rational-functions'][currentClassId];
                        updateQuizSettingsFields('domain-range-rational-functions', domainRangeSettings);
                    } else {
                        clearQuizSettingsFields('domain-range-rational-functions');
                    }
                    
                    // Update Domain and Range of Inverse Functions Quiz settings
                    if (settings['domain-range-inverse-functions'] && settings['domain-range-inverse-functions'][currentClassId]) {
                        const inverseSettings = settings['domain-range-inverse-functions'][currentClassId];
                        updateQuizSettingsFields('domain-range-inverse-functions', inverseSettings);
                    } else {
                        clearQuizSettingsFields('domain-range-inverse-functions');
                    }
                    
                    // Update One-to-One Functions Quiz settings
                    if (settings['one-to-one-functions'] && settings['one-to-one-functions'][currentClassId]) {
                        const oneToOneSettings = settings['one-to-one-functions'][currentClassId];
                        updateQuizSettingsFields('one-to-one-functions', oneToOneSettings);
                    } else {
                        clearQuizSettingsFields('one-to-one-functions');
                    }
                } else {
                    console.log('No quiz settings found for class:', currentClassId);
                    clearQuizSettingsUI();
                }
            } catch (error) {
                console.error('Error loading quiz settings:', error);
                clearQuizSettingsUI();
            }
        }
        // Helper function to update quiz settings fields
        function updateQuizSettingsFields(quizType, settings) {
            // Convert kebab-case quizType to camelCase prefix used by element IDs
            const elementId = quizType.replace(/-([a-z])/g, (match, letter) => letter.toUpperCase());
            const deadlineInput = document.getElementById(`${elementId}QuizDeadline`);
            const timeLimitInput = document.getElementById(`${elementId}QuizTimeLimit`);
            const deadlineStatus = document.getElementById(`${elementId}QuizDeadlineStatus`);
            
            if (deadlineInput && settings.deadline) {
                const convertedValue = toDatetimeLocalValueFromServer(settings.deadline);
                deadlineInput.value = convertedValue;
                
                console.log(`Loading deadline for ${quizType}:`);
                console.log(`  From server (local time): ${settings.deadline}`);
                console.log(`  Converted for input: ${convertedValue}`);
                console.log(`  Input field value after set: ${deadlineInput.value}`);
                
                // Parse deadline as local time
                const [datePart, timePart] = settings.deadline.split('T');
                const [year, month, day] = datePart.split('-').map(Number);
                const [hour, minute] = timePart.split(':').map(Number);
                const deadlineDate = new Date(year, month - 1, day, hour, minute, 0);
                
                console.log(`  Parsed deadline object: ${deadlineDate.toLocaleString()}`);
                
                updateDeadlineStatus(deadlineDate, deadlineStatus);
            }
            
            if (timeLimitInput && settings.time_limit) {
                timeLimitInput.value = settings.time_limit;
            }
        }
        
        // Helper function to clear quiz settings fields
        function clearQuizSettingsFields(quizType) {
            // Convert kebab-case quizType to camelCase prefix used by element IDs
            const elementId = quizType.replace(/-([a-z])/g, (match, letter) => letter.toUpperCase());
            const deadlineInput = document.getElementById(`${elementId}QuizDeadline`);
            const timeLimitInput = document.getElementById(`${elementId}QuizTimeLimit`);
            const deadlineStatus = document.getElementById(`${elementId}QuizDeadlineStatus`);
            
            if (deadlineInput) {
                deadlineInput.value = '';
            }
            if (timeLimitInput) {
                timeLimitInput.value = '20'; // Reset to default
            }
            if (deadlineStatus) {
                deadlineStatus.innerHTML = '<span class="text-gray-500 text-sm">No deadline set</span>';
            }
        }
        
        // Helper function to clear all quiz settings UI
        function clearQuizSettingsUI() {
            const quizTypes = ['functions', 'evaluating-functions', 'operations-on-functions', 'real-life-problems', 'rational-functions', 'solving-rational-equations-inequalities', 'representations-of-rational-functions', 'domain-range-rational-functions', 'domain-range-inverse-functions', 'one-to-one-functions'];
            
            quizTypes.forEach(quizType => {
                clearQuizSettingsFields(quizType);
            });
        }

        // Update deadline status display
        function updateDeadlineStatus(deadline, statusElement) {
            if (!statusElement) return;
            
            const now = new Date();
            const timeDiff = deadline.getTime() - now.getTime();
            
            if (timeDiff > 0) {
                // Deadline hasn't passed yet
                const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                
                let timeString = '';
                if (days > 0) {
                    timeString = `${days} day${days > 1 ? 's' : ''} remaining`;
                } else if (hours > 0) {
                    timeString = `${hours} hour${hours > 1 ? 's' : ''} remaining`;
                } else {
                    timeString = `${minutes} minute${minutes > 1 ? 's' : ''} remaining`;
                }
                
                statusElement.innerHTML = `
                    <div class="flex items-center text-green-600">
                        <i class="fas fa-clock mr-2"></i>
                        <span class="font-medium">${timeString}</span>
                    </div>
                `;
            } else {
                // Deadline has passed - quiz is in review mode
                statusElement.innerHTML = `
                    <div class="flex items-center text-orange-600">
                        <i class="fas fa-eye mr-2"></i>
                        <span class="font-medium">Review Mode Active</span>
                    </div>
                `;
            }
        }

        // Class Performance Functions
        async function loadClassPerformanceData() {
            console.log('Loading class performance data...');
            try {
                console.log('Making API call to php/independent-class-performance.php...');
                const response = await fetch('php/independent-class-performance.php?action=get_performance_data', {
                    credentials: 'include'
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    if (response.status === 401) {
                        console.log('Unauthorized - redirecting to login');
                        window.location.href = 'teacher-login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const responseText = await response.text();
                console.log('Raw response:', responseText);
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    console.error('Response was not valid JSON:', responseText);
                    throw new Error('Server returned invalid JSON response. This may indicate a PHP error.');
                }
                console.log('Performance data result:', result);

                if (result.success) {
                    console.log('API call successful, processing data...');
                    performanceData = result;
                    populateClassSelector(result.classes);
                    // Initialize the table with "Please select a class" message
                    const tableBody = document.getElementById('performanceTableBody');
                    if (tableBody) {
                        tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-gray-500">Please select a class to view student quiz scores</td></tr>';
                        console.log('Table updated with default message');
                    } else {
                        console.error('Table body not found in loadClassPerformanceData');
                    }
                    updateLastUpdatedTime();
                } else {
                    console.error('Failed to load performance data:', result.message);
                    showPerformanceError(result.message);
                }
            } catch (error) {
                console.error('Error loading class performance data:', error);
                
                // Try fallback to old system
                console.log('Trying fallback to old class-performance.php...');
                try {
                    const fallbackResponse = await fetch('php/class-performance.php?action=get_performance_data', {
                        credentials: 'include'
                    });
                    
                    if (fallbackResponse.ok) {
                        const fallbackText = await fallbackResponse.text();
                        console.log('Fallback raw response:', fallbackText);
                        
                        let fallbackResult;
                        try {
                            fallbackResult = JSON.parse(fallbackText);
                            if (fallbackResult.success) {
                                console.log('Fallback system working, using old data...');
                                performanceData = fallbackResult;
                                populateClassSelector(fallbackResult.classes);
                                const tableBody = document.getElementById('performanceTableBody');
                                if (tableBody) {
                                    tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-yellow-500"><i class="fas fa-info-circle mr-2"></i>Using fallback system - please run database migration for full features</td></tr>';
                                }
                                updateLastUpdatedTime();
                                return;
                            }
                        } catch (fallbackParseError) {
                            console.error('Fallback JSON parse error:', fallbackParseError);
                            console.error('Fallback response was not valid JSON:', fallbackText);
                        }
                    }
                } catch (fallbackError) {
                    console.error('Fallback system also failed:', fallbackError);
                }
                
                // Show a fallback message if both systems aren't working
                const tableBody = document.getElementById('performanceTableBody');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="12" class="px-4 py-8 text-center text-orange-500">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                Class Performance system is being set up. Please run the database migration first.
                                <br><br>
                                <button onclick="loadClassPerformanceData()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm">
                                    <i class="fas fa-refresh mr-2"></i>Try Again
                                </button>
                            </td>
                        </tr>
                    `;
                }
                
                showPerformanceError('Failed to load performance data');
            }
        }


        function populateClassSelector(classes) {
            console.log('populateClassSelector called with classes:', classes);
            const classSelector = document.getElementById('classSelector');
            if (!classSelector) {
                console.error('Class selector not found!');
                return;
            }

            // Clear existing options
            classSelector.innerHTML = '<option value="">Select Class</option>';
            console.log('Class selector cleared');

            classes.forEach(classData => {
                const option = document.createElement('option');
                option.value = classData.class_info.id;
                option.textContent = `${classData.class_info.class_name} (${classData.class_stats.total_students} students)`;
                classSelector.appendChild(option);
                console.log('Added class option:', classData.class_info.class_name);
            });
            
            console.log('Class selector populated with', classes.length, 'classes');
        }

        // New function to populate class selector with real-time data
        async function populateClassSelectorWithRealData() {
            console.log('Populating class selector with real-time data...');
            const classSelector = document.getElementById('classSelector');
            if (!classSelector) {
                console.error('Class selector not found!');
                return;
            }

            try {
                // Get classes from class management (same source as performance data)
                const response = await fetch('php/class-management.php?action=get_teacher_classes', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load classes');
                }

                const result = await response.json();
                
                if (result.success && result.classes) {
                    // Clear existing options
                    classSelector.innerHTML = '<option value="">Select Class</option>';
                    
                    result.classes.forEach(classItem => {
                        const option = document.createElement('option');
                        option.value = classItem.id;
                        // Use the student_count from class management
                        const studentCount = classItem.student_count || 0;
                        option.textContent = `${classItem.class_name} (${studentCount} students)`;
                        classSelector.appendChild(option);
                        console.log('Added class option with real data:', classItem.class_name, 'students:', studentCount);
                    });
                    
                    console.log('Class selector populated with real-time data:', result.classes.length, 'classes');
                } else {
                    console.error('Failed to load classes for selector');
                }
            } catch (error) {
                console.error('Error populating class selector with real data:', error);
            }
        }

        async function loadClassPerformance() {
            const classSelector = document.getElementById('classSelector');
            const tableBody = document.getElementById('performanceTableBody');
            const selectedClassInfo = document.getElementById('selectedClassInfo');
            
            if (!classSelector || !tableBody) return;
            
            const selectedClassId = classSelector.value;
            if (!selectedClassId) {
                tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-gray-500">Please select a class to view student quiz scores</td></tr>';
                // Hide summary and class info when no class is selected
                const summaryDiv = document.getElementById('classPerformanceSummary');
                if (summaryDiv) {
                    summaryDiv.classList.add('hidden');
                }
                if (selectedClassInfo) {
                    selectedClassInfo.classList.add('hidden');
                }
                return;
            }

            // Security check: Validate that the selected class ID is from the available classes
            const availableClasses = Array.from(classSelector.options).map(option => option.value).filter(value => value !== '');
            if (!availableClasses.includes(selectedClassId)) {
                console.error('Security violation: Invalid class ID selected');
                tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-red-500">Error: Invalid class selection</td></tr>';
                return;
            }

            try {
                // Show loading state
                tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>';

                // Use the same data source as quiz management - get quiz results for ALL quiz types
                const quizTypes = [
                    'functions',
                    'evaluating-functions',
                    'operations-on-functions',
                    'real-life-problems',
                    'rational-functions',
                    'solving-rational-equations-inequalities',
                    'representations-of-rational-functions',
                    'domain-range-rational-functions',
                    'domain-range-inverse-functions',
                    'one-to-one-functions'
                ];
                const allQuizResults = {};
                
                // Fetch quiz results for each quiz type
                for (const quizType of quizTypes) {
                    const response = await fetch(`php/quiz-management.php?action=get_quiz_results&quiz_type=${quizType}&class_id=${selectedClassId}`, {
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            window.location.href = 'teacher-login.html';
                            return;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.success && result.results) {
                        allQuizResults[quizType] = result.results;
                    }
                }

                // Get all enrolled students in the class
                const studentsResponse = await fetch(`php/class-management.php?action=get_class_students&class_id=${selectedClassId}`, {
                    credentials: 'include'
                });
                
                let allEnrolledStudents = [];
                if (studentsResponse.ok) {
                    const studentsResult = await studentsResponse.json();
                    if (studentsResult.success && studentsResult.students) {
                        allEnrolledStudents = studentsResult.students;
                    }
                }

                // Get class information
                const classResponse = await fetch(`php/class-management.php?action=get_class_details&class_id=${selectedClassId}`, {
                    credentials: 'include'
                });
                
                let classInfo = null;
                if (classResponse.ok) {
                    const classResult = await classResponse.json();
                    if (classResult.success && classResult.class) {
                        classInfo = classResult.class;
                    }
                }

                // Process the quiz results to create student performance data, including all enrolled students
                const studentPerformanceData = processQuizResultsToPerformanceDataWithAllStudents(allQuizResults, allEnrolledStudents, classInfo);
                
                if (studentPerformanceData.length > 0) {
                    console.log('Processed performance data:', studentPerformanceData);
                    
                    // Display selected class information
                    displaySelectedClassInfoFromQuizData(classInfo, studentPerformanceData);
                    
                    // Display the performance table
                    displayClassPerformanceTableFromQuizData(studentPerformanceData);
                } else {
                    console.log('No students found for class:', selectedClassId);
                    tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-gray-500">No students found in this class</td></tr>';
                    if (selectedClassInfo) {
                        selectedClassInfo.classList.add('hidden');
                    }
                }

            } catch (error) {
                console.error('Error loading class performance:', error);
                tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-red-500">Failed to load data</td></tr>';
            }
        }

        // Process quiz results from quiz management to create performance data, including all enrolled students
        function processQuizResultsToPerformanceDataWithAllStudents(allQuizResults, allEnrolledStudents, classInfo) {
            const studentMap = new Map();
            
            // First, add all enrolled students to the map with default values
            allEnrolledStudents.forEach(enrolledStudent => {
                studentMap.set(enrolledStudent.student_id, {
                    student_id: enrolledStudent.student_id,
                    student_name: `${enrolledStudent.first_name} ${enrolledStudent.last_name}`,
                    student_number: enrolledStudent.student_number,
                    email: enrolledStudent.email,
                    enrollment_status: enrolledStudent.enrollment_status,
                    class_id: enrolledStudent.class_id,
                    class_name: classInfo ? classInfo.class_name : 'Unknown Class',
                    functions_quiz_best_score: 0,
                    functions_quiz_status: 'NOT_ATTEMPTED',
                    evaluating_functions_quiz_best_score: 0,
                    evaluating_functions_quiz_status: 'NOT_ATTEMPTED',
                    operations_on_functions_quiz_best_score: 0,
                    operations_on_functions_quiz_status: 'NOT_ATTEMPTED',
                    real_life_problems_quiz_best_score: 0,
                    real_life_problems_quiz_status: 'NOT_ATTEMPTED',
                    rational_functions_quiz_best_score: 0,
                    rational_functions_quiz_status: 'NOT_ATTEMPTED',
                    solving_rational_equations_quiz_best_score: 0,
                    solving_rational_equations_quiz_status: 'NOT_ATTEMPTED',
                    representations_of_rational_functions_quiz_best_score: 0,
                    representations_of_rational_functions_quiz_status: 'NOT_ATTEMPTED',
                    domain_range_rational_functions_quiz_best_score: 0,
                    domain_range_rational_functions_quiz_status: 'NOT_ATTEMPTED',
                    one_to_one_functions_quiz_best_score: 0,
                    one_to_one_functions_quiz_status: 'NOT_ATTEMPTED',
                    overall_performance_status: 'POOR'
                });
            });
            
            // Then, process quiz results and update existing students
            Object.keys(allQuizResults).forEach(quizType => {
                const results = allQuizResults[quizType];
                
                results.forEach(result => {
                    const studentId = result.student_id;
                    
                    // Only update if student exists in enrolled students
                    if (studentMap.has(studentId)) {
                        const student = studentMap.get(studentId);
                        const percentage = result.percentage;
                        
                        // Update quiz-specific data based on quiz type
                        switch (quizType) {
                            case 'functions':
                                student.functions_quiz_best_score = Math.max(student.functions_quiz_best_score, percentage);
                                student.functions_quiz_status = percentage >= 70 ? 'PASSED' : 'FAILED';
                                break;
                            case 'evaluating-functions':
                                student.evaluating_functions_quiz_best_score = Math.max(student.evaluating_functions_quiz_best_score, percentage);
                                student.evaluating_functions_quiz_status = percentage >= 70 ? 'PASSED' : 'FAILED';
                                break;
                            case 'operations-on-functions':
                                student.operations_on_functions_quiz_best_score = Math.max(student.operations_on_functions_quiz_best_score, percentage);
                                student.operations_on_functions_quiz_status = percentage >= 70 ? 'PASSED' : 'FAILED';
                                break;
                            case 'real-life-problems':
                                student.real_life_problems_quiz_best_score = Math.max(student.real_life_problems_quiz_best_score, percentage);
                                student.real_life_problems_quiz_status = percentage >= 70 ? 'PASSED' : 'FAILED';
                                break;
                            case 'rational-functions':
                                student.rational_functions_quiz_best_score = Math.max(student.rational_functions_quiz_best_score, percentage);
                                student.rational_functions_quiz_status = percentage >= 70 ? 'PASSED' : 'FAILED';
                                break;
                            case 'solving-rational-equations-inequalities':
                                student.solving_rational_equations_quiz_best_score = Math.max(student.solving_rational_equations_quiz_best_score, percentage);
                                student.solving_rational_equations_quiz_status = percentage >= 70 ? 'PASSED' : 'FAILED';
                                break;
                            case 'representations-of-rational-functions':
                                student.representations_of_rational_functions_quiz_best_score = Math.max(student.representations_of_rational_functions_quiz_best_score, percentage);
                                student.representations_of_rational_functions_quiz_status = percentage >= 70 ? 'PASSED' : 'FAILED';
                                break;
                            case 'domain-range-rational-functions':
                                student.domain_range_rational_functions_quiz_best_score = Math.max(student.domain_range_rational_functions_quiz_best_score, percentage);
                                student.domain_range_rational_functions_quiz_status = percentage >= 70 ? 'PASSED' : 'FAILED';
                                break;
                            case 'one-to-one-functions':
                                student.one_to_one_functions_quiz_best_score = Math.max(student.one_to_one_functions_quiz_best_score, percentage);
                                student.one_to_one_functions_quiz_status = percentage >= 70 ? 'PASSED' : 'FAILED';
                                break;
                        }
                    }
                });
            });
            
            // Calculate overall performance status for each student
            studentMap.forEach(student => {
                const passedQuizzes = 
                    (student.functions_quiz_status === 'PASSED' ? 1 : 0) +
                    (student.evaluating_functions_quiz_status === 'PASSED' ? 1 : 0) +
                    (student.operations_on_functions_quiz_status === 'PASSED' ? 1 : 0) +
                    (student.real_life_problems_quiz_status === 'PASSED' ? 1 : 0) +
                    (student.rational_functions_quiz_status === 'PASSED' ? 1 : 0) +
                    (student.solving_rational_equations_quiz_status === 'PASSED' ? 1 : 0) +
                    (student.representations_of_rational_functions_quiz_status === 'PASSED' ? 1 : 0) +
                    (student.domain_range_rational_functions_quiz_status === 'PASSED' ? 1 : 0) +
                    (student.one_to_one_functions_quiz_status === 'PASSED' ? 1 : 0);
                
                if (passedQuizzes >= 8) {
                    student.overall_performance_status = 'EXCELLENT';
                } else if (passedQuizzes >= 6) {
                    student.overall_performance_status = 'GOOD';
                } else if (passedQuizzes >= 4) {
                    student.overall_performance_status = 'AVERAGE';
                } else if (passedQuizzes >= 1) {
                    student.overall_performance_status = 'NEEDS_IMPROVEMENT';
                } else {
                    student.overall_performance_status = 'POOR';
                }
            });
            
            return Array.from(studentMap.values());
        }

        // Process quiz results from quiz management to create performance data (legacy function)
        function processQuizResultsToPerformanceData(allQuizResults, classInfo) {
            const studentMap = new Map();
            
            // Process each quiz type's results
            Object.keys(allQuizResults).forEach(quizType => {
                const results = allQuizResults[quizType];
                
                results.forEach(result => {
                    const studentId = result.student_id;
                    
                    if (!studentMap.has(studentId)) {
                        studentMap.set(studentId, {
                            student_id: studentId,
                            student_name: result.student_name,
                            class_id: result.class_id,
                            class_name: result.class_name,
                            functions_quiz_best_score: 0,
                            functions_quiz_status: 'NOT_ATTEMPTED',
                            evaluating_functions_quiz_best_score: 0,
                            evaluating_functions_quiz_status: 'NOT_ATTEMPTED',
                            operations_on_functions_quiz_best_score: 0,
                            operations_on_functions_quiz_status: 'NOT_ATTEMPTED',
                            overall_performance_status: 'POOR'
                        });
                    }
                    
                    const student = studentMap.get(studentId);
                    const percentage = result.percentage;
                    
                    // Update quiz-specific data based on quiz type
                    switch (quizType) {
                        case 'functions':
                            student.functions_quiz_best_score = Math.max(student.functions_quiz_best_score, percentage);
                            student.functions_quiz_status = percentage >= 70 ? 'PASSED' : 'FAILED';
                            break;
                        case 'evaluating-functions':
                            student.evaluating_functions_quiz_best_score = Math.max(student.evaluating_functions_quiz_best_score, percentage);
                            student.evaluating_functions_quiz_status = percentage >= 70 ? 'PASSED' : 'FAILED';
                            break;
                        case 'operations-on-functions':
                            student.operations_on_functions_quiz_best_score = Math.max(student.operations_on_functions_quiz_best_score, percentage);
                            student.operations_on_functions_quiz_status = percentage >= 70 ? 'PASSED' : 'FAILED';
                            break;
                    }
                });
            });
            
            // Calculate overall performance status for each student
            studentMap.forEach(student => {
                const passedQuizzes = 
                    (student.functions_quiz_status === 'PASSED' ? 1 : 0) +
                    (student.evaluating_functions_quiz_status === 'PASSED' ? 1 : 0) +
                    (student.operations_on_functions_quiz_status === 'PASSED' ? 1 : 0);
                
                if (passedQuizzes === 3) {
                    student.overall_performance_status = 'EXCELLENT';
                } else if (passedQuizzes === 2) {
                    student.overall_performance_status = 'GOOD';
                } else if (passedQuizzes === 1) {
                    student.overall_performance_status = 'AVERAGE';
                } else if (student.functions_quiz_best_score > 0 || student.evaluating_functions_quiz_best_score > 0 || student.operations_on_functions_quiz_best_score > 0) {
                    student.overall_performance_status = 'NEEDS_IMPROVEMENT';
                } else {
                    student.overall_performance_status = 'POOR';
                }
            });
            
            return Array.from(studentMap.values());
        }

        // Display class information using quiz data
        function displaySelectedClassInfoFromQuizData(classInfo, studentData) {
            const selectedClassInfo = document.getElementById('selectedClassInfo');
            if (!selectedClassInfo) return;
            
            // Update class name and details
            if (classInfo) {
                document.getElementById('selectedClassName').textContent = classInfo.class_name || 'Unknown Class';
                document.getElementById('selectedClassDetails').textContent = 
                    `${classInfo.grade_level || 'N/A'} - ${classInfo.strand || 'N/A'} | ${classInfo.subject || 'N/A'} | Code: ${classInfo.class_code || 'N/A'}`;
            }
            
            // Calculate statistics from student data
            const totalStudents = studentData.length;
            const approvedStudents = totalStudents; // All students in quiz results are approved
            
            // Calculate average score
            let totalScore = 0;
            let studentsWithScores = 0;
            
            studentData.forEach(student => {
                const studentScore = (student.functions_quiz_best_score + 
                                     student.evaluating_functions_quiz_best_score + 
                                     student.operations_on_functions_quiz_best_score +
                                     (student.real_life_problems_quiz_best_score || 0) +
                                     (student.rational_functions_quiz_best_score || 0) +
                                     (student.solving_rational_equations_quiz_best_score || 0) +
                                     (student.representations_of_rational_functions_quiz_best_score || 0) +
                                     (student.domain_range_rational_functions_quiz_best_score || 0) +
                                     (student.one_to_one_functions_quiz_best_score || 0)) / 9;
                if (studentScore > 0) {
                    totalScore += studentScore;
                    studentsWithScores++;
                }
            });
            
            const averageScore = studentsWithScores > 0 ? (totalScore / studentsWithScores).toFixed(1) : '0.0';
            
            // Update statistics
            document.getElementById('selectedClassStudentCount').textContent = totalStudents;
            document.getElementById('selectedClassApprovedCount').textContent = approvedStudents;
            document.getElementById('selectedClassAvgScore').textContent = `${averageScore}%`;
            
            // Show the class info section
            selectedClassInfo.classList.remove('hidden');
        }

        // Display performance table using quiz data
        function displayClassPerformanceTableFromQuizData(students) {
            const tableBody = document.getElementById('performanceTableBody');
            if (!tableBody) return;

            if (students.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-gray-500">No students in this class</td></tr>';
                return;
            }

            let tableHTML = '';
            students.forEach((student, index) => {
                // Get all quiz scores
                const functionsScore = student.functions_quiz_best_score || 0;
                const evaluatingScore = student.evaluating_functions_quiz_best_score || 0;
                const operationsScore = student.operations_on_functions_quiz_best_score || 0;
                const realLifeScore = student.real_life_problems_quiz_best_score || 0;
                const rationalScore = student.rational_functions_quiz_best_score || 0;
                const solvingScore = student.solving_rational_equations_quiz_best_score || 0;
                const representationsScore = student.representations_of_rational_functions_quiz_best_score || 0;
                const domainRangeScore = student.domain_range_rational_functions_quiz_best_score || 0;
                const oneToOneScore = student.one_to_one_functions_quiz_best_score || 0;
                
                // Get performance status
                const performanceStatus = student.overall_performance_status || 'NEEDS_IMPROVEMENT';
                
                // Check if student has taken any quizzes
                const hasTakenQuizzes = functionsScore > 0 || evaluatingScore > 0 || operationsScore > 0 || 
                                       realLifeScore > 0 || rationalScore > 0 || solvingScore > 0 ||
                                       representationsScore > 0 || domainRangeScore > 0 || oneToOneScore > 0;
                
                // Overall status styling
                let overallStatusClass = 'bg-gray-100 text-gray-600';
                let overallStatus = 'Not Started';
                
                // If student hasn't taken any quizzes, show enrollment status
                if (!hasTakenQuizzes) {
                    if (student.enrollment_status === 'approved') {
                        overallStatusClass = 'bg-blue-100 text-blue-800';
                        overallStatus = 'Enrolled';
                    } else if (student.enrollment_status === 'pending') {
                        overallStatusClass = 'bg-yellow-100 text-yellow-800';
                        overallStatus = 'Pending';
                    } else {
                        overallStatusClass = 'bg-gray-100 text-gray-600';
                        overallStatus = 'Not Started';
                    }
                } else {
                    // Student has taken quizzes, show performance status
                    switch (performanceStatus) {
                        case 'EXCELLENT':
                            overallStatusClass = 'bg-green-100 text-green-800';
                            overallStatus = 'Excellent';
                            break;
                        case 'GOOD':
                            overallStatusClass = 'bg-blue-100 text-blue-800';
                            overallStatus = 'Good';
                            break;
                        case 'AVERAGE':
                            overallStatusClass = 'bg-yellow-100 text-yellow-800';
                            overallStatus = 'Average';
                            break;
                        case 'NEEDS_IMPROVEMENT':
                            overallStatusClass = 'bg-orange-100 text-orange-800';
                            overallStatus = 'Needs Improvement';
                            break;
                        case 'POOR':
                            overallStatusClass = 'bg-red-100 text-red-800';
                            overallStatus = 'Poor';
                            break;
                    }
                }

                // Calculate average score
                const totalScore = functionsScore + evaluatingScore + operationsScore + realLifeScore + 
                                  rationalScore + solvingScore + representationsScore + domainRangeScore + oneToOneScore;
                const avgScore = totalScore / 9;
                
                // Parse student name into last name and first name
                const nameParts = student.student_name.split(' ');
                const lastName = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';
                const firstName = nameParts.length > 1 ? nameParts.slice(0, -1).join(' ') : student.student_name;
                
                // Determine if student needs attention (highlight in yellow)
                const needsAttention = avgScore < 60 && hasTakenQuizzes;
                const rowClass = needsAttention ? 'bg-yellow-50 hover:bg-yellow-100' : 'hover:bg-gray-50';
                
                // Color coding function for quiz scores
                const getScoreClass = (score) => score >= 70 ? 'text-green-600 font-semibold' : (score > 0 ? 'text-red-600' : 'text-gray-400');
                
                // Get classes for each quiz
                const functionsClass = getScoreClass(functionsScore);
                const evaluatingClass = getScoreClass(evaluatingScore);
                const operationsClass = getScoreClass(operationsScore);
                const realLifeClass = getScoreClass(realLifeScore);
                const rationalClass = getScoreClass(rationalScore);
                const solvingClass = getScoreClass(solvingScore);
                const representationsClass = getScoreClass(representationsScore);
                const domainRangeClass = getScoreClass(domainRangeScore);
                const oneToOneClass = getScoreClass(oneToOneScore);
                const avgClass = avgScore >= 70 ? 'text-green-600 font-bold' : (avgScore > 0 ? 'text-gray-700 font-semibold' : 'text-gray-400');

                tableHTML += `
                <tr class="${rowClass} cursor-pointer transition-colors" onclick="viewStudentDetails(${student.student_id})">
                    <td class="px-3 py-3 text-sm text-gray-900 text-center border-r border-gray-200 sticky left-0 bg-inherit">${index + 1}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 border-r border-gray-200 sticky left-12 bg-inherit">
                        <div class="font-medium">${firstName} ${lastName}</div>
                        <div class="text-xs text-gray-500">${student.student_number || ''}</div>
                    </td>
                    <td class="px-3 py-3 text-sm text-center border-r border-gray-200">
                        <span class="${functionsClass}">${functionsScore > 0 ? functionsScore.toFixed(1) : '-'}</span>
                    </td>
                    <td class="px-3 py-3 text-sm text-center border-r border-gray-200">
                        <span class="${evaluatingClass}">${evaluatingScore > 0 ? evaluatingScore.toFixed(1) : '-'}</span>
                    </td>
                    <td class="px-3 py-3 text-sm text-center border-r border-gray-200">
                        <span class="${operationsClass}">${operationsScore > 0 ? operationsScore.toFixed(1) : '-'}</span>
                    </td>
                    <td class="px-3 py-3 text-sm text-center border-r border-gray-200">
                        <span class="${realLifeClass}">${realLifeScore > 0 ? realLifeScore.toFixed(1) : '-'}</span>
                    </td>
                    <td class="px-3 py-3 text-sm text-center border-r border-gray-200">
                        <span class="${rationalClass}">${rationalScore > 0 ? rationalScore.toFixed(1) : '-'}</span>
                    </td>
                    <td class="px-3 py-3 text-sm text-center border-r border-gray-200">
                        <span class="${solvingClass}">${solvingScore > 0 ? solvingScore.toFixed(1) : '-'}</span>
                    </td>
                    <td class="px-3 py-3 text-sm text-center border-r border-gray-200">
                        <span class="${representationsClass}">${representationsScore > 0 ? representationsScore.toFixed(1) : '-'}</span>
                    </td>
                    <td class="px-3 py-3 text-sm text-center border-r border-gray-200">
                        <span class="${domainRangeClass}">${domainRangeScore > 0 ? domainRangeScore.toFixed(1) : '-'}</span>
                    </td>
                    <td class="px-3 py-3 text-sm text-center border-r border-gray-300">
                        <span class="${oneToOneClass}">${oneToOneScore > 0 ? oneToOneScore.toFixed(1) : '-'}</span>
                    </td>
                    <td class="px-4 py-3 text-sm text-center bg-green-50">
                        <span class="${avgClass}">${avgScore > 0 ? avgScore.toFixed(1) : '-'}%</span>
                    </td>
                </tr>
            `;
            });

            tableBody.innerHTML = tableHTML;
        }

        function displaySelectedClassInfo(classData) {
            const selectedClassInfo = document.getElementById('selectedClassInfo');
            if (!selectedClassInfo) return;
            
            const classInfo = classData.class_info || {};
            const classStats = classData.class_stats || {};
            
            // Update class name and details with safe fallbacks
            document.getElementById('selectedClassName').textContent = classInfo.class_name || 'Unknown Class';
            document.getElementById('selectedClassDetails').textContent = 
                `${classInfo.grade_level || 'N/A'} - ${classInfo.strand || 'N/A'} | ${classInfo.subject || 'N/A'} | Code: ${classInfo.class_code || 'N/A'}`;
            
            // Update statistics with safe fallbacks
            document.getElementById('selectedClassStudentCount').textContent = classStats.total_students || 0;
            document.getElementById('selectedClassApprovedCount').textContent = classStats.approved_students || 0;
            
            // Safe handling of average score
            let averageScore = '0%';
            if (classStats.average_score !== null && classStats.average_score !== undefined) {
                const score = parseFloat(classStats.average_score);
                if (!isNaN(score)) {
                    averageScore = `${score.toFixed(1)}%`;
                }
            }
            document.getElementById('selectedClassAvgScore').textContent = averageScore;
            
            // Show the class info section
            selectedClassInfo.classList.remove('hidden');
        }

        function displayClassPerformanceTable(students) {
            const tableBody = document.getElementById('performanceTableBody');
            if (!tableBody) return;

            if (students.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-gray-500">No students in this class</td></tr>';
                return;
            }

            let tableHTML = '';
            students.forEach((student, index) => {
                // Get quiz scores from independent performance tracking
                const functionsScore = student.functions_quiz_best_score || 0;
                const evaluatingScore = student.evaluating_functions_quiz_best_score || 0;
                const operationsScore = student.operations_on_functions_quiz_best_score || 0;
                
                // Get quiz attempt counts
                const functionsAttempts = student.functions_quiz_attempts || 0;
                const evaluatingAttempts = student.evaluating_functions_quiz_attempts || 0;
                const operationsAttempts = student.operations_on_functions_quiz_attempts || 0;
                
                // Calculate total score from independent tracking
                const totalScore = student.total_score || 0;
                
                // Get performance status and engagement level
                const performanceStatus = student.overall_performance_status || 'NEEDS_IMPROVEMENT';
                const engagementLevel = student.engagement_level || 'LOW';
                
                // Color coding for quiz scores
                const functionsClass = functionsScore >= 70 ? 'bg-green-50 text-green-800' : (functionsScore > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-600');
                const evaluatingClass = evaluatingScore >= 70 ? 'bg-green-50 text-green-800' : (evaluatingScore > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-600');
                const operationsClass = operationsScore >= 70 ? 'bg-green-50 text-green-800' : (operationsScore > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-600');
                
                // Color coding for performance status
                let performanceClass = '';
                switch (performanceStatus) {
                    case 'EXCELLENT':
                        performanceClass = 'bg-green-100 text-green-800';
                        break;
                    case 'GOOD':
                        performanceClass = 'bg-blue-100 text-blue-800';
                        break;
                    case 'AVERAGE':
                        performanceClass = 'bg-yellow-100 text-yellow-800';
                        break;
                    case 'NEEDS_IMPROVEMENT':
                        performanceClass = 'bg-orange-100 text-orange-800';
                        break;
                    case 'POOR':
                        performanceClass = 'bg-red-100 text-red-800';
                        break;
                    default:
                        performanceClass = 'bg-gray-100 text-gray-600';
                }
                
                // Get enrollment status with color coding
                const enrollmentStatus = student.enrollment_status || 'unknown';
                let statusClass = '';
                let statusText = '';
                
                switch (enrollmentStatus) {
                    case 'approved':
                        statusClass = 'bg-green-100 text-green-800';
                        statusText = 'Approved';
                        break;
                    case 'pending':
                        statusClass = 'bg-yellow-100 text-yellow-800';
                        statusText = 'Pending';
                        break;
                    case 'rejected':
                        statusClass = 'bg-red-100 text-red-800';
                        statusText = 'Rejected';
                        break;
                    default:
                        statusClass = 'bg-gray-100 text-gray-600';
                        statusText = 'Unknown';
                }
                
            // Determine overall status
            let overallStatus = 'Not Started';
            let overallStatusClass = 'bg-gray-100 text-gray-600';
            
            if (functionsScore > 0 || evaluatingScore > 0 || operationsScore > 0) {
                const passedQuizzes = (functionsScore >= 70 ? 1 : 0) + (evaluatingScore >= 70 ? 1 : 0) + (operationsScore >= 70 ? 1 : 0);
                const totalQuizzes = (functionsScore > 0 ? 1 : 0) + (evaluatingScore > 0 ? 1 : 0) + (operationsScore > 0 ? 1 : 0);
                
                if (passedQuizzes === totalQuizzes && totalQuizzes > 0) {
                    overallStatus = 'Passed All';
                    overallStatusClass = 'bg-green-100 text-green-700';
                } else if (passedQuizzes > 0) {
                    overallStatus = `Passed ${passedQuizzes}/${totalQuizzes}`;
                    overallStatusClass = 'bg-yellow-100 text-yellow-700';
                } else {
                    overallStatus = 'Failed';
                    overallStatusClass = 'bg-red-100 text-red-700';
                }
            }

            tableHTML += `
                <tr class="hover:bg-gray-50 cursor-pointer" onclick="showStudentDetails(${student.student_id})">
                    <td class="px-4 py-3 text-sm text-gray-900">${index + 1}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 font-medium">${student.first_name || 'N/A'} ${student.last_name || 'N/A'}</td>
                    <td class="px-4 py-3 text-sm text-center">
                        <div class="flex flex-col items-center">
                            <span class="text-sm font-medium ${functionsScore >= 70 ? 'text-green-600' : functionsScore > 0 ? 'text-red-600' : 'text-gray-500'}">
                                ${functionsScore > 0 ? safeFormatNumber(functionsScore, 1) + '%' : 'N/A'}
                            </span>
                            <span class="text-xs ${functionsScore >= 70 ? 'text-green-600' : functionsScore > 0 ? 'text-red-600' : 'text-gray-500'}">
                                ${functionsScore >= 70 ? '✓ Passed' : functionsScore > 0 ? '✗ Failed' : 'Not taken'}
                            </span>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-center">
                        <div class="flex flex-col items-center">
                            <span class="text-sm font-medium ${evaluatingScore >= 70 ? 'text-green-600' : evaluatingScore > 0 ? 'text-red-600' : 'text-gray-500'}">
                                ${evaluatingScore > 0 ? safeFormatNumber(evaluatingScore, 1) + '%' : 'N/A'}
                            </span>
                            <span class="text-xs ${evaluatingScore >= 70 ? 'text-green-600' : evaluatingScore > 0 ? 'text-red-600' : 'text-gray-500'}">
                                ${evaluatingScore >= 70 ? '✓ Passed' : evaluatingScore > 0 ? '✗ Failed' : 'Not taken'}
                            </span>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-center">
                        <div class="flex flex-col items-center">
                            <span class="text-sm font-medium ${operationsScore >= 70 ? 'text-green-600' : operationsScore > 0 ? 'text-red-600' : 'text-gray-500'}">
                                ${operationsScore > 0 ? safeFormatNumber(operationsScore, 1) + '%' : 'N/A'}
                            </span>
                            <span class="text-xs ${operationsScore >= 70 ? 'text-green-600' : operationsScore > 0 ? 'text-red-600' : 'text-gray-500'}">
                                ${operationsScore >= 70 ? '✓ Passed' : operationsScore > 0 ? '✗ Failed' : 'Not taken'}
                            </span>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-center">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${overallStatusClass}">${overallStatus}</span>
                    </td>
                </tr>
            `;
            });

            tableBody.innerHTML = tableHTML;
            
            // Update summary statistics
        }

        function displayPerformanceData(classes) {
            // This function is now handled by loadClassPerformance()
            // Keep for compatibility but functionality moved to loadClassPerformance()
        }

        function createStudentCard(student) {
            const lastActivity = student.last_activity ? formatTimeAgo(student.last_activity) : 'Never';
            const totalQuizScore = Math.max(
                student.functions_quiz_best || 0,
                student.evaluating_functions_quiz_best || 0
            );
            
            // Calculate overall progress
            const totalLessons = 19; // 5 + 4 + 3 + 4 + 3
            const completedLessons = (student.functions_lessons_completed || 0) + 
                                   (student.evaluating_functions_lessons_completed || 0) + 
                                   (student.operations_lessons_completed || 0) + 
                                   (student.rational_functions_lessons_completed || 0) + 
                                   (student.real_life_lessons_completed || 0);
            const progressPercentage = totalLessons > 0 ? Math.round((completedLessons / totalLessons) * 100) : 0;
            
            // Determine performance level and color
            let performanceLevel = 'Beginner';
            let performanceColor = 'from-gray-400 to-gray-500';
            let scoreColor = 'text-gray-600';
            
            if (progressPercentage >= 80) {
                performanceLevel = 'Excellent';
                performanceColor = 'from-emerald-400 to-emerald-600';
                scoreColor = 'text-emerald-600';
            } else if (progressPercentage >= 60) {
                performanceLevel = 'Good';
                performanceColor = 'from-blue-400 to-blue-600';
                scoreColor = 'text-blue-600';
            } else if (progressPercentage >= 40) {
                performanceLevel = 'Average';
                performanceColor = 'from-yellow-400 to-yellow-600';
                scoreColor = 'text-yellow-600';
            } else if (progressPercentage >= 20) {
                performanceLevel = 'Needs Improvement';
                performanceColor = 'from-orange-400 to-orange-600';
                scoreColor = 'text-orange-600';
            }
            
            return `
                <div class="bg-white rounded-xl p-5 border border-gray-200 hover:shadow-lg transition-all duration-300 hover:border-indigo-300">
                    <!-- Student Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-gradient-to-br ${performanceColor} rounded-full flex items-center justify-center shadow-md">
                                <span class="text-white font-bold text-sm">${student.first_name.charAt(0)}${student.last_name.charAt(0)}</span>
                            </div>
                            <div>
                                <h5 class="font-bold text-gray-900 text-lg">${student.first_name} ${student.last_name}</h5>
                                <p class="text-sm text-gray-600">ID: ${student.student_number}</p>
                                <span class="inline-block px-2 py-1 text-xs font-medium bg-gray-100 text-gray-700 rounded-full mt-1">
                                    ${performanceLevel}
                                </span>
                            </div>
                        </div>
                        <button onclick="viewStudentDetails(${student.student_id})" 
                                class="bg-indigo-100 hover:bg-indigo-200 text-indigo-600 p-2 rounded-lg transition-colors">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">Overall Progress</span>
                            <span class="text-sm font-bold ${scoreColor}">${progressPercentage}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-gradient-to-r ${performanceColor} h-2 rounded-full transition-all duration-500" 
                                 style="width: ${progressPercentage}%"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">${completedLessons} of ${totalLessons} lessons completed</p>
                    </div>
                    
                    <!-- Performance Metrics -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs text-gray-600">Total Score</p>
                                    <p class="text-lg font-bold ${scoreColor}">${student.total_score || 0}%</p>
                                </div>
                                <i class="fas fa-chart-line text-gray-400"></i>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs text-gray-600">Quiz Average</p>
                                    <p class="text-lg font-bold ${scoreColor}">${safeFormatNumber(student.overall_quiz_average)}%</p>
                                </div>
                                <i class="fas fa-trophy text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quiz Performance Details -->
                    <div class="space-y-2 mb-4">
                        <h6 class="text-sm font-semibold text-gray-700 mb-2">Quiz Performance</h6>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-600">Functions Quiz</span>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs font-medium ${student.functions_quiz_status === 'PASSED' ? 'text-green-600' : student.functions_quiz_status === 'FAILED' ? 'text-red-600' : 'text-gray-500'}">${safeFormatNumber(student.functions_quiz_best)}%</span>
                                    <span class="text-xs px-2 py-1 rounded-full ${student.functions_quiz_status === 'PASSED' ? 'bg-green-100 text-green-700' : student.functions_quiz_status === 'FAILED' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-500'}">${student.functions_quiz_status || 'NO_ATTEMPTS'}</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-600">Evaluating Functions Quiz</span>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs font-medium ${student.evaluating_functions_quiz_status === 'PASSED' ? 'text-green-600' : student.evaluating_functions_quiz_status === 'FAILED' ? 'text-red-600' : 'text-gray-500'}">${safeFormatNumber(student.evaluating_functions_quiz_best)}%</span>
                                    <span class="text-xs px-2 py-1 rounded-full ${student.evaluating_functions_quiz_status === 'PASSED' ? 'bg-green-100 text-green-700' : student.evaluating_functions_quiz_status === 'FAILED' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-500'}">${student.evaluating_functions_quiz_status || 'NO_ATTEMPTS'}</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t border-gray-200">
                                <span class="text-xs text-gray-600">Passed Quizzes</span>
                                <span class="text-xs font-medium text-gray-700">${student.passed_quizzes_count || 0} / ${student.total_quiz_attempts || 0}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Topic Progress -->
                    <div class="space-y-2 mb-4">
                        <h6 class="text-sm font-semibold text-gray-700 mb-2">Topic Progress</h6>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-600">Functions</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-16 bg-gray-200 rounded-full h-1.5">
                                        <div class="bg-indigo-500 h-1.5 rounded-full" style="width: ${Math.round(((student.functions_lessons_completed || 0) / 5) * 100)}%"></div>
                                    </div>
                                    <span class="text-xs font-medium text-gray-700">${student.functions_lessons_completed || 0}/5</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-600">Evaluating Functions</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-16 bg-gray-200 rounded-full h-1.5">
                                        <div class="bg-orange-500 h-1.5 rounded-full" style="width: ${Math.round(((student.evaluating_functions_lessons_completed || 0) / 4) * 100)}%"></div>
                                    </div>
                                    <span class="text-xs font-medium text-gray-700">${student.evaluating_functions_lessons_completed || 0}/4</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-600">Operations</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-16 bg-gray-200 rounded-full h-1.5">
                                        <div class="bg-purple-500 h-1.5 rounded-full" style="width: ${Math.round(((student.operations_lessons_completed || 0) / 3) * 100)}%"></div>
                                    </div>
                                    <span class="text-xs font-medium text-gray-700">${student.operations_lessons_completed || 0}/3</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Last Activity -->
                    <div class="flex items-center justify-between pt-3 border-t border-gray-200">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-clock text-gray-400 text-xs"></i>
                            <span class="text-xs text-gray-600">Last Activity</span>
                        </div>
                        <span class="text-xs font-medium text-gray-700">${lastActivity}</span>
                    </div>
                </div>
            `;
        }

        function toggleClassStudents(classId) {
            const container = document.getElementById(`students-container-${classId}`);
            const icon = document.getElementById(`toggle-icon-${classId}`);
            
            if (container && icon) {
                if (container.classList.contains('hidden')) {
                    container.classList.remove('hidden');
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                } else {
                    container.classList.add('hidden');
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                }
            }
        }

        async function viewStudentDetails(studentId) {
            try {
                // Show loading
                const detailsContent = document.getElementById('studentDetailsContent');
                detailsContent.innerHTML = `
                    <div class="flex items-center justify-center py-12">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                            <p class="text-gray-600">Loading student details...</p>
                        </div>
                    </div>
                `;

                // Show the student details section
                document.getElementById('student-details-section').classList.remove('hidden');
                document.getElementById('student-details-section').scrollIntoView({ behavior: 'smooth' });

                // Fetch detailed student data
                const response = await fetch(`php/independent-class-performance.php?action=get_student_details&student_id=${studentId}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    displayStudentDetails(result);
                } else {
                    throw new Error(result.message || 'Failed to load student details');
                }

            } catch (error) {
                console.error('Error loading student details:', error);
                const detailsContent = document.getElementById('studentDetailsContent');
                detailsContent.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Error Loading Details</h3>
                        <p class="text-gray-600 mb-4">Failed to load student details. Please try again.</p>
                        <button onclick="viewStudentDetails(${studentId})" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            <i class="fas fa-redo mr-2"></i>
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        function filterByClass() {
            const quizClassSelector = document.getElementById('quizClassSelector');
            const selectedClassId = quizClassSelector.value;
            currentClassFilter = selectedClassId;

            const classCards = document.querySelectorAll('[data-class-id]');
            classCards.forEach(card => {
                if (selectedClassId === 'all' || card.getAttribute('data-class-id') === selectedClassId) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function sortStudents() {
            const sortSelector = document.getElementById('sortSelector');
            currentSort = sortSelector.value;
            
            // Re-display data with new sorting
            if (performanceData && performanceData.classes) {
                const sortedClasses = sortClassesData(performanceData.classes);
                displayPerformanceData(sortedClasses);
            }
        }

        function sortClassesData(classes) {
            return classes.map(classData => {
                const sortedStudents = [...classData.students].sort((a, b) => {
                    switch (currentSort) {
                        case 'name':
                            return (a.first_name + ' ' + a.last_name).localeCompare(b.first_name + ' ' + b.last_name);
                        case 'score':
                            return (b.total_score || 0) - (a.total_score || 0);
                        case 'lessons':
                            return (b.completed_lessons || 0) - (a.completed_lessons || 0);
                        case 'quiz':
                            const aQuizScore = Math.max(a.functions_quiz_best || 0, a.evaluating_functions_quiz_best || 0);
                            const bQuizScore = Math.max(b.functions_quiz_best || 0, b.evaluating_functions_quiz_best || 0);
                            return bQuizScore - aQuizScore;
                        case 'activity':
                            if (!a.last_activity && !b.last_activity) return 0;
                            if (!a.last_activity) return 1;
                            if (!b.last_activity) return -1;
                            return new Date(b.last_activity) - new Date(a.last_activity);
                        default:
                            return 0;
                    }
                });
                
                return {
                    ...classData,
                    students: sortedStudents
                };
            });
        }

        function searchStudents() {
            const searchInput = document.getElementById('studentSearch');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                // If search is empty, show all data
                if (performanceData && performanceData.classes) {
                    displayPerformanceData(performanceData.classes);
                }
                return;
            }
            
            // Filter students based on search term
            if (performanceData && performanceData.classes) {
                const filteredClasses = performanceData.classes.map(classData => {
                    const filteredStudents = classData.students.filter(student => {
                        const fullName = (student.first_name + ' ' + student.last_name).toLowerCase();
                        const studentId = (student.student_number || '').toLowerCase();
                        const email = (student.email || '').toLowerCase();
                        
                        return fullName.includes(searchTerm) || 
                               studentId.includes(searchTerm) || 
                               email.includes(searchTerm);
                    });
                    
                    return {
                        ...classData,
                        students: filteredStudents
                    };
                }).filter(classData => classData.students.length > 0); // Only show classes with matching students
                
                displayPerformanceData(filteredClasses);
            }
        }

        function clearFilters() {
            document.getElementById('quizClassSelector').value = 'all';
            document.getElementById('sortSelector').value = 'name';
            document.getElementById('studentSearch').value = '';
            
            currentClassFilter = 'all';
            currentSort = 'name';
            
            filterByClass();
        }

        function syncPerformanceData() {
            const classSelector = document.getElementById('classSelector');
            const selectedClassId = classSelector ? classSelector.value : null;
            
            // Show loading state
            const tableBody = document.getElementById('performanceTableBody');
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-blue-500"><i class="fas fa-spinner fa-spin mr-2"></i>Syncing performance data...</td></tr>';
            }
            
            // Show confirmation dialog
            const confirmSync = confirm(
                'This will sync all performance data from the main quiz system to ensure accuracy.\n\n' +
                'This may take a few moments. Continue?'
            );
            
            if (!confirmSync) {
                // Restore previous state
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-gray-500">Please select a class to view student quiz scores</td></tr>';
                }
                return;
            }
            
            // Make sync request
            const syncUrl = selectedClassId ? 
                `php/independent-class-performance.php?action=sync_performance_data&class_id=${selectedClassId}` :
                'php/independent-class-performance.php?action=sync_performance_data';
            
            fetch(syncUrl, {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Show success message
                    if (tableBody) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="12" class="px-4 py-8 text-center text-green-600">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    ${result.message}
                                    <br><br>
                                    <button onclick="refreshPerformanceData()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm">
                                        <i class="fas fa-refresh mr-2"></i>Refresh Data
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                    
                    // Show success notification
                    showNotification('Data synced successfully!', 'success');
                    
                    // Auto-refresh after 2 seconds
                    setTimeout(() => {
                        refreshPerformanceData();
                        if (selectedClassId) {
                            loadClassPerformance();
                        }
                    }, 2000);
                    
                } else {
                    // Show error message
                    if (tableBody) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="12" class="px-4 py-8 text-center text-red-500">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    Sync failed: ${result.message}
                                    <br><br>
                                    <button onclick="syncPerformanceData()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm">
                                        <i class="fas fa-retry mr-2"></i>Try Again
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                    
                    showNotification('Sync failed: ' + result.message, 'error');
                }
            })
            .catch(error => {
                console.error('Sync error:', error);
                
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="12" class="px-4 py-8 text-center text-red-500">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                Sync failed: ${error.message}
                                <br><br>
                                <button onclick="syncPerformanceData()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm">
                                    <i class="fas fa-retry mr-2"></i>Try Again
                                </button>
                            </td>
                        </tr>
                    `;
                }
                
                showNotification('Sync failed: ' + error.message, 'error');
            });
        }

        function refreshPerformanceData() {
            // Show loading state
            const tableBody = document.getElementById('performanceTableBody');
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Refreshing data...</td></tr>';
            }
            
            // Refresh the class selector with real-time data
            populateClassSelectorWithRealData();
            
            // If a class is selected, reload the performance table using quiz data
            const classSelector = document.getElementById('classSelector');
            if (classSelector && classSelector.value) {
                loadClassPerformance();
            }
        }



        function showPerformanceError(message) {
            const container = document.getElementById('performanceDataContainer');
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Error Loading Data</h3>
                        <p class="text-gray-600 mb-4">${message}</p>
                        <button onclick="loadClassPerformanceData()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        function formatTimeAgo(isoString) {
            if (!isoString) return 'Never';
            const then = new Date(isoString);
            const now = new Date();
            const diff = Math.max(0, (now - then) / 1000);
            
            if (diff < 60) return 'Just now';
            const mins = Math.floor(diff / 60);
            if (mins < 60) return `${mins}m ago`;
            const hours = Math.floor(mins / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d ago`;
            return then.toLocaleDateString();
        }

        function updateLastUpdatedTime() {
            const lastUpdatedElement = document.getElementById('lastUpdated');
            if (lastUpdatedElement) {
                const now = new Date();
                lastUpdatedElement.textContent = now.toLocaleString();
            }
        }

        function safeFormatNumber(value, decimals = 2) {
            const num = parseFloat(value || 0);
            return isNaN(num) ? '0.00' : num.toFixed(decimals);
        }

        function displayStudentDetails(data) {
            const { student, quiz_attempts, quiz_statistics, lesson_completions } = data;
            const detailsContent = document.getElementById('studentDetailsContent');
            
            // Calculate performance metrics
            const totalLessons = 19; // 5 + 4 + 3 + 4 + 3
            const completedLessons = (student.functions_lessons_completed || 0) + 
                                   (student.evaluating_functions_lessons_completed || 0) + 
                                   (student.operations_lessons_completed || 0) + 
                                   (student.rational_functions_lessons_completed || 0) + 
                                   (student.real_life_lessons_completed || 0);
            const progressPercentage = totalLessons > 0 ? Math.round((completedLessons / totalLessons) * 100) : 0;
            
            // Determine performance level
            let performanceLevel = 'Beginner';
            let performanceColor = 'from-gray-400 to-gray-500';
            
            if (progressPercentage >= 80) {
                performanceLevel = 'Excellent';
                performanceColor = 'from-emerald-400 to-emerald-600';
            } else if (progressPercentage >= 60) {
                performanceLevel = 'Good';
                performanceColor = 'from-blue-400 to-blue-600';
            } else if (progressPercentage >= 40) {
                performanceLevel = 'Average';
                performanceColor = 'from-yellow-400 to-yellow-600';
            } else if (progressPercentage >= 20) {
                performanceLevel = 'Needs Improvement';
                performanceColor = 'from-orange-400 to-orange-600';
            }

            detailsContent.innerHTML = `
                <!-- Student Header -->
                <div class="bg-gradient-to-r ${performanceColor} p-6 rounded-lg text-white mb-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <span class="text-white font-bold text-xl">${student.first_name.charAt(0)}${student.last_name.charAt(0)}</span>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold">${student.first_name} ${student.last_name}</h2>
                                <p class="text-white text-opacity-90">Student ID: ${student.student_number}</p>
                                <p class="text-white text-opacity-90">Email: ${student.email}</p>
                                <span class="inline-block px-3 py-1 bg-white bg-opacity-20 rounded-full text-sm font-medium mt-2">
                                    ${performanceLevel}
                                </span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold">${progressPercentage}%</div>
                            <div class="text-white text-opacity-90">Overall Progress</div>
                        </div>
                    </div>
                </div>

                <!-- Performance Overview -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-blue-600">Total Score</p>
                                <p class="text-2xl font-bold text-blue-900">${student.total_score || 0}%</p>
                            </div>
                            <i class="fas fa-chart-line text-blue-500 text-2xl"></i>
                        </div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-green-600">Lessons Completed</p>
                                <p class="text-2xl font-bold text-green-900">${completedLessons}/${totalLessons}</p>
                            </div>
                            <i class="fas fa-book text-green-500 text-2xl"></i>
                        </div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-purple-600">Quiz Average</p>
                                <p class="text-2xl font-bold text-purple-900">${safeFormatNumber(student.overall_quiz_average)}%</p>
                            </div>
                            <i class="fas fa-trophy text-purple-500 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Quiz Performance -->
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Quiz Performance</h3>
                    ${quiz_statistics && quiz_statistics.length > 0 ? `
                        <div class="space-y-4">
                            ${quiz_statistics.map(quiz => `
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="font-semibold text-gray-900 capitalize">${quiz.quiz_type.replace('-', ' ')} Quiz</h4>
                                        <span class="px-3 py-1 rounded-full text-sm font-medium ${quiz.pass_rate >= 70 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                            ${quiz.pass_rate}% Pass Rate
                                        </span>
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div class="text-center">
                                            <p class="text-2xl font-bold text-indigo-600">${quiz.total_attempts}</p>
                                            <p class="text-xs text-gray-600">Total Attempts</p>
                                        </div>
                                        <div class="text-center">
                                            <p class="text-2xl font-bold text-green-600">${safeFormatNumber(quiz.best_score)}%</p>
                                            <p class="text-xs text-gray-600">Best Score</p>
                                        </div>
                                        <div class="text-center">
                                            <p class="text-2xl font-bold text-blue-600">${safeFormatNumber(quiz.average_score)}%</p>
                                            <p class="text-xs text-gray-600">Average Score</p>
                                        </div>
                                        <div class="text-center">
                                            <p class="text-2xl font-bold text-purple-600">${quiz.passed_attempts}</p>
                                            <p class="text-xs text-gray-600">Passed</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-clipboard-list text-3xl mb-2"></i>
                            <p>No quiz attempts recorded</p>
                        </div>
                    `}
                </div>

                <!-- Lesson Progress -->
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Lesson Progress</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700">Functions</span>
                            <div class="flex items-center space-x-3">
                                <div class="w-32 bg-gray-200 rounded-full h-2">
                                    <div class="bg-indigo-500 h-2 rounded-full" style="width: ${Math.round(((student.functions_lessons_completed || 0) / 5) * 100)}%"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">${student.functions_lessons_completed || 0}/5</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700">Evaluating Functions</span>
                            <div class="flex items-center space-x-3">
                                <div class="w-32 bg-gray-200 rounded-full h-2">
                                    <div class="bg-orange-500 h-2 rounded-full" style="width: ${Math.round(((student.evaluating_functions_lessons_completed || 0) / 4) * 100)}%"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">${student.evaluating_functions_lessons_completed || 0}/4</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700">Operations on Functions</span>
                            <div class="flex items-center space-x-3">
                                <div class="w-32 bg-gray-200 rounded-full h-2">
                                    <div class="bg-purple-500 h-2 rounded-full" style="width: ${Math.round(((student.operations_lessons_completed || 0) / 3) * 100)}%"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">${student.operations_lessons_completed || 0}/3</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700">Rational Functions</span>
                            <div class="flex items-center space-x-3">
                                <div class="w-32 bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: ${Math.round(((student.rational_functions_lessons_completed || 0) / 4) * 100)}%"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">${student.rational_functions_lessons_completed || 0}/4</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700">Solving Real-Life Problems</span>
                            <div class="flex items-center space-x-3">
                                <div class="w-32 bg-gray-200 rounded-full h-2">
                                    <div class="bg-red-500 h-2 rounded-full" style="width: ${Math.round(((student.real_life_lessons_completed || 0) / 4) * 100)}%"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">${student.real_life_lessons_completed || 0}/4</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Activity</h3>
                    ${lesson_completions && lesson_completions.length > 0 ? `
                        <div class="space-y-3">
                            ${lesson_completions.slice(0, 5).map(lesson => `
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-check-circle text-green-500"></i>
                                        <div>
                                            <p class="font-medium text-gray-900">${lesson.topic.replace('-', ' ')} - Lesson ${lesson.lesson_number}</p>
                                            <p class="text-sm text-gray-600">Completed on ${new Date(lesson.completed_at).toLocaleDateString()}</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-history text-3xl mb-2"></i>
                            <p>No recent activity recorded</p>
                        </div>
                    `}
                </div>
            `;
        }

        async function showStudentDetails(studentId) {
            const modal = document.getElementById('studentDetailsModal');
            const content = document.getElementById('studentDetailsContent');
            const title = document.getElementById('studentDetailsTitle');
            const subtitle = document.getElementById('studentDetailsSubtitle');
            
            if (!modal || !content) return;
            
            // Show loading state
            content.innerHTML = `
                <div class="flex items-center justify-center py-12">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                        <p class="text-gray-600">Loading student details...</p>
                    </div>
                </div>
            `;
            
            // Show modal
            modal.classList.remove('hidden');
            
            try {
                // Fetch detailed student data
                const response = await fetch(`php/independent-class-performance.php?action=get_student_details&student_id=${studentId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.student) {
                    const student = result.student;
                    const topicPerformance = result.topic_performance || {};
                    
                    // Update modal title
                    title.textContent = `${student.first_name} ${student.last_name}`;
                    subtitle.textContent = `${student.student_number} | ${student.class_name || 'Unknown Class'}`;
                    
                    // Create comprehensive student details content
                    content.innerHTML = `
                        <!-- Student Overview -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-6">
                                <div class="flex items-center">
                                    <div class="p-3 bg-blue-500 rounded-full">
                                        <i class="fas fa-user text-white"></i>
                                    </div>
                                    <div class="ml-4">
                                        <h4 class="text-lg font-semibold text-gray-900">Student Info</h4>
                                        <p class="text-sm text-gray-600">${student.email}</p>
                                        <p class="text-sm text-gray-600">Status: <span class="font-medium ${student.enrollment_status === 'approved' ? 'text-green-600' : 'text-yellow-600'}">${student.enrollment_status}</span></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-6">
                                <div class="flex items-center">
                                    <div class="p-3 bg-green-500 rounded-full">
                                        <i class="fas fa-chart-line text-white"></i>
                                    </div>
                                    <div class="ml-4">
                                        <h4 class="text-lg font-semibold text-gray-900">Overall Performance</h4>
                                        <p class="text-2xl font-bold text-green-600">${student.total_score || 0}%</p>
                                        <p class="text-sm text-gray-600">Status: <span class="font-medium text-blue-600">${student.overall_performance_status || 'NEEDS_IMPROVEMENT'}</span></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-6">
                                <div class="flex items-center">
                                    <div class="p-3 bg-purple-500 rounded-full">
                                        <i class="fas fa-fire text-white"></i>
                                    </div>
                                    <div class="ml-4">
                                        <h4 class="text-lg font-semibold text-gray-900">Engagement</h4>
                                        <p class="text-2xl font-bold text-purple-600">${student.engagement_level || 'LOW'}</p>
                                        <p class="text-sm text-gray-600">Lessons Completed: ${student.total_lessons_completed || 0}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quiz Performance Details -->
                        <div class="mb-8">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Quiz Performance Details</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${createQuizPerformanceCard('Functions Quiz', topicPerformance.functions || {}, 'blue')}
                                ${createQuizPerformanceCard('Evaluating Functions Quiz', topicPerformance['evaluating-functions'] || {}, 'green')}
                                ${createQuizPerformanceCard('Operations on Functions Quiz', topicPerformance['operations-on-functions'] || {}, 'purple')}
                                ${createQuizPerformanceCard('Rational Functions Quiz', topicPerformance['rational-functions'] || {}, 'orange')}
                                ${createQuizPerformanceCard('Real-Life Problems Quiz', topicPerformance['solving-real-life-problems'] || {}, 'red')}
                            </div>
                        </div>
                        
                        <!-- Performance History -->
                        ${result.performance_history && result.performance_history.length > 0 ? `
                        <div class="mb-8">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Performance History</h4>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="space-y-3">
                                    ${result.performance_history.map(history => `
                                        <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                                            <div>
                                                <p class="font-medium text-gray-900">${history.overall_performance_status}</p>
                                                <p class="text-sm text-gray-600">${history.change_reason || 'Performance update'}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-sm font-medium text-gray-900">${history.total_score}%</p>
                                                <p class="text-xs text-gray-500">${new Date(history.recorded_at).toLocaleDateString()}</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Actions -->
                        <div class="flex justify-end space-x-3">
                            <button onclick="closeStudentDetails()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                                Close
                            </button>
                            <button onclick="exportStudentReport(${studentId})" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-download mr-2"></i>
                                Export Report
                            </button>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Error Loading Student Details</h3>
                            <p class="text-gray-600 mb-4">${result.message || 'Failed to load student information'}</p>
                            <button onclick="closeStudentDetails()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                                Close
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading student details:', error);
                content.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Error Loading Student Details</h3>
                        <p class="text-gray-600 mb-4">An error occurred while loading student information.</p>
                        <button onclick="closeStudentDetails()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                            Close
                        </button>
                    </div>
                `;
            }
        }
        
        function createQuizPerformanceCard(title, data, color) {
            const score = data.quiz_best_score || 0;
            const attempts = data.quiz_attempts || 0;
            const status = data.quiz_status || 'NOT_ATTEMPTED';
            const lessonsCompleted = data.lessons_completed || 0;
            
            const colorClasses = {
                blue: 'from-blue-50 to-blue-100 border-blue-200',
                green: 'from-green-50 to-green-100 border-green-200',
                purple: 'from-purple-50 to-purple-100 border-purple-200',
                orange: 'from-orange-50 to-orange-100 border-orange-200',
                red: 'from-red-50 to-red-100 border-red-200'
            };
            
            const statusColors = {
                'PASSED': 'text-green-600 bg-green-100',
                'FAILED': 'text-red-600 bg-red-100',
                'NOT_ATTEMPTED': 'text-gray-600 bg-gray-100'
            };
            
            return `
                <div class="bg-gradient-to-br ${colorClasses[color]} rounded-lg p-6 border">
                    <div class="flex items-center justify-between mb-4">
                        <h5 class="font-semibold text-gray-900">${title}</h5>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[status]}">${status}</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Best Score:</span>
                            <span class="font-medium">${score > 0 ? safeFormatNumber(score, 1) + '%' : 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Attempts:</span>
                            <span class="font-medium">${attempts}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Lessons:</span>
                            <span class="font-medium">${lessonsCompleted}</span>
                        </div>
                        ${data.quiz_last_attempt ? `
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Last Attempt:</span>
                            <span class="font-medium text-xs">${new Date(data.quiz_last_attempt).toLocaleDateString()}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function closeStudentDetails() {
            const modal = document.getElementById('studentDetailsModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        function exportStudentReport(studentId) {
            // Create a simple CSV export for the student
            const link = document.createElement('a');
            link.href = `php/independent-class-performance.php?action=export_performance&student_id=${studentId}&format=csv`;
            link.download = `student_report_${studentId}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>

    <script src="js/create-class-modal.js"></script>

    <!-- Topic Management Modal -->
    <div id="topicManagementModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col mx-4">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-book-open text-white text-lg"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900" id="topicManagementTitle">Topic Management</h2>
                        <p class="text-sm text-gray-600" id="topicManagementSubtitle">Control which topics students can access for the selected class</p>
                    </div>
                </div>
                <button onclick="hideTopicManagement()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 p-2 rounded-lg transition-all duration-200">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <div class="space-y-4" id="topicManagementList">
                    <!-- Topic management will be populated by JavaScript -->
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                        <span id="topicCount">0</span> topics available for management
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="lockAllTopics()" class="bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                            <i class="fas fa-lock mr-2"></i>
                            Lock All
                        </button>
                        <button onclick="unlockAllTopics()" class="bg-green-100 hover:bg-green-200 text-green-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                            <i class="fas fa-unlock mr-2"></i>
                            Unlock All
                        </button>
                        <button onclick="lockFirstQuarter()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                            <i class="fas fa-lock mr-2"></i>
                            Lock 1st Q
                        </button>
                        <button onclick="lockSecondQuarter()" class="bg-emerald-100 hover:bg-emerald-200 text-emerald-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                            <i class="fas fa-lock mr-2"></i>
                            Lock 2nd Q
                        </button>
                        <button onclick="hideTopicManagement()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                            <i class="fas fa-check mr-2"></i>
                            Done
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
