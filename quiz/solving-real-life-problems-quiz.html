<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solving Real-Life Problems Quiz - MathEase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#667eea',
                        'secondary': '#764ba2',
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .question-card {
            transition: all 0.3s ease;
        }
        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.15);
        }
        .option-selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .option-correct {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #10b981;
        }
        .option-incorrect {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-color: #ef4444;
        }
        .option-review {
            pointer-events: none;
            opacity: 0.8;
        }
        .review-mode .option {
            pointer-events: none;
        }
        .review-mode .option input {
            pointer-events: none;
        }
        .review-mode .option input[type="number"] {
            pointer-events: none;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .question-card {
            animation: slideInUp 0.6s ease-out;
        }
        .option {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .option:hover::before {
            left: 100%;
        }
        .option:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .virtual-aid {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Anti-cheating styles */
        .leaderboard-entry.cheating-entry {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left: 4px solid #ef4444;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.1);
        }
        
        .leaderboard-entry.cheating-entry .leaderboard-name {
            color: #dc2626;
            font-weight: 600;
        }
        
        .leaderboard-entry.cheating-entry .leaderboard-points {
            color: #dc2626;
            font-weight: bold;
        }
        
        /* Advanced Podium Styles */
        .podium-block {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .podium-block:hover {
            transform: translateY(-5px);
        }
        
        .podium-1 {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            width: 120px;
            height: 140px;
            border-radius: 12px 12px 0 0;
            position: relative;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
        
        .podium-2 {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            width: 100px;
            height: 110px;
            border-radius: 12px 12px 0 0;
            position: relative;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }
        
        .podium-3 {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            width: 100px;
            height: 80px;
            border-radius: 12px 12px 0 0;
            position: relative;
            box-shadow: 0 6px 15px rgba(245, 158, 11, 0.3);
        }
        
        .podium-rank {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .podium-rank-1 {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        .podium-rank-2 {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .podium-rank-3 {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .podium-avatar {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 3px solid white;
        }
        
        .podium-crown {
            position: absolute;
            top: -45px;
            right: -5px;
            color: #fbbf24;
            font-size: 16px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .podium-info {
            margin-top: 20px;
            text-align: center;
        }
        
        .podium-name {
            font-weight: bold;
            color: #374151;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .podium-points {
            font-size: 16px;
            font-weight: bold;
            color: #1f2937;
        }
        
        /* Badge notification styles */
        .badge-notification {
            border-radius: 20px !important;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1) !important;
        }
        
        .badge-notification .swal2-html-container {
            margin: 0 !important;
        }
        
        .badge-notification .swal2-title {
            color: #10b981 !important;
            font-size: 2rem !important;
            margin-bottom: 1rem !important;
        }
        
        /* Character animations */
        .tips-character {
            animation: float 3s ease-in-out infinite;
        }
        
        .results-character {
            transition: all 0.5s ease;
        }
        
        .results-character.motivate {
            animation: bounce 1s ease-in-out infinite;
        }
        
        .results-character.celebrate {
            animation: celebrate 2s ease-in-out infinite;
        }
        
        .results-character.sad {
            animation: shake 0.5s ease-in-out;
        }
        
        .results-character.happy {
            animation: wiggle 1s ease-in-out infinite;
        }
        
        .warning-character {
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        
        @keyframes celebrate {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            75% { transform: scale(1.1) rotate(5deg); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0px); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-3deg); }
            75% { transform: rotate(3deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .podium-block {
                margin: 0 8px;
            }
            
            .podium-1 {
                width: 100px;
                height: 120px;
            }
            
            .podium-2 {
                width: 85px;
                height: 95px;
            }
            
            .podium-3 {
                width: 85px;
                height: 70px;
            }
            
            .podium-avatar {
                width: 40px;
                height: 40px;
                top: -30px;
            }
            
            .podium-rank {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            
            .podium-name {
                font-size: 12px;
            }
            
            .podium-points {
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .podium-block {
                margin: 0 4px;
            }
            
            .podium-1 {
                width: 80px;
                height: 100px;
            }
            
            .podium-2 {
                width: 70px;
                height: 80px;
            }
            
            .podium-3 {
                width: 70px;
                height: 60px;
            }
            
            .podium-avatar {
                width: 35px;
                height: 35px;
                top: -25px;
            }
            
            .podium-rank {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
            
            .podium-name {
                font-size: 11px;
            }
            
            .podium-points {
                font-size: 12px;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="../index.html" class="flex items-center space-x-2">
                        <img src="../css/nav-logo/nav-logo.png" alt="MathEase Logo" class="h-8 w-8">
                        <span class="text-xl font-bold text-primary">MathEase</span>
                    </a>
                </div>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="../dashboard.html" class="text-gray-700 hover:text-primary transition-colors">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </a>
                    <a href="../topics.html" class="text-primary font-semibold">
                        <i class="fas fa-book mr-2"></i>Topics
                    </a>
                    <span class="text-gray-600">
                        <i class="fas fa-user mr-2"></i><span id="userName">Student</span>
                    </span>
                    <a href="../php/logout.php" class="text-gray-700 hover:text-red-600 transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header class="gradient-bg text-white py-12">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <div class="inline-flex items-center bg-white/20 backdrop-blur-sm rounded-full px-6 py-2 mb-6">
                <i class="fas fa-calculator mr-2"></i>
                <span class="font-semibold">General Mathematics 11</span>
            </div>
            <h1 class="text-3xl md:text-5xl font-bold mb-4">Solving Real-Life Problems Quiz</h1>
            <p class="text-lg md:text-xl text-white/90 mb-6">
                Test your understanding of applying functions to real-world scenarios
            </p>
            <div class="flex justify-center space-x-4">
                <div class="bg-white/20 backdrop-blur-sm rounded-full px-6 py-2">
                    <span class="font-semibold">10 Multiple Choice</span>
                </div>
                <div class="bg-white/20 backdrop-blur-sm rounded-full px-6 py-2">
                    <span class="font-semibold">1 Problem Solving</span>
                </div>
                <div class="bg-white/20 backdrop-blur-sm rounded-full px-6 py-2">
                    <span class="font-semibold">30 Minutes</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Quiz Instructions -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
            <div class="text-center mb-6">
                <div class="w-32 h-32 mx-auto mb-6 flex items-center justify-center relative">
                    <img src="../Img/Character/tips_approved-removebg-preview.png" 
                         alt="Tips Approved Character" 
                         class="w-full h-full object-contain tips-character"
                         style="filter: drop-shadow(0 15px 30px rgba(0,0,0,0.15));">
                    
                    <!-- Floating elements around the character -->
                    <div class="absolute -top-2 -right-2 w-6 h-6 bg-yellow-400 rounded-full animate-ping"></div>
                    <div class="absolute -bottom-2 -left-2 w-4 h-4 bg-green-400 rounded-full animate-pulse"></div>
                    <div class="absolute top-1/2 -right-4 w-3 h-3 bg-blue-400 rounded-full animate-bounce"></div>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Quiz Instructions</h2>
                <p class="text-gray-600">Read the instructions carefully before starting the quiz</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-blue-50 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-800 mb-2">
                        <i class="fas fa-clock text-blue-500 mr-2"></i>Time Limit
                    </h3>
                    <p class="text-blue-700 text-sm">You have 30 minutes to complete this quiz</p>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <h3 class="font-semibold text-green-800 mb-2">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>Passing Score
                    </h3>
                    <p class="text-green-700 text-sm">You need 70% (8 out of 11 questions) to pass</p>
                </div>
                <div class="bg-purple-50 rounded-lg p-4">
                    <h3 class="font-semibold text-purple-800 mb-2">
                        <i class="fas fa-question-circle text-purple-500 mr-2"></i>Question Types
                    </h3>
                    <p class="text-purple-700 text-sm">10 multiple choice + 1 problem solving</p>
                </div>
                <div class="bg-orange-50 rounded-lg p-4">
                    <h3 class="font-semibold text-orange-800 mb-2">
                        <i class="fas fa-exclamation-triangle text-orange-500 mr-2"></i>Important
                    </h3>
                    <p class="text-orange-700 text-sm">You can only take this quiz once</p>
                </div>
            </div>
            
            <div class="text-center">
                <button id="startQuizBtn" class="bg-primary text-white px-8 py-3 rounded-lg hover:bg-secondary transition-colors font-semibold text-lg">
                    <i class="fas fa-play mr-2"></i>Start Quiz
                </button>
            </div>
        </div>
    </div>

    <!-- Progress Bar and Timer - Sticky -->
    <div id="progressTimerContainer" class="bg-white shadow-md border-b border-gray-200 sticky top-0 z-40 hidden">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-6">
                    <div class="flex items-center bg-indigo-50 rounded-lg px-3 py-2">
                        <i class="fas fa-tasks text-indigo-600 mr-2"></i>
                        <span class="text-sm font-medium text-gray-700">Progress:</span>
                        <span class="text-sm font-bold text-indigo-600 ml-2" id="progressText">0/11</span>
                    </div>
                    <div class="flex items-center bg-purple-50 rounded-lg px-3 py-2">
                        <i class="fas fa-clock text-purple-600 mr-2"></i>
                        <span class="text-sm font-medium text-gray-700">Time:</span>
                        <span class="text-lg font-bold text-purple-600 ml-2" id="quizTimer">00:00</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg px-3 py-2 border border-green-200">
                        <i class="fas fa-play-circle text-green-600 mr-2"></i>
                        <span class="text-xs text-gray-600">Started at</span>
                        <span class="text-sm font-semibold text-green-600 ml-1" id="startTime">--:--</span>
                    </div>
                </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 shadow-inner">
                <div class="bg-gradient-to-r from-primary to-secondary h-3 rounded-full progress-bar transition-all duration-300" id="progressBar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Quiz Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="quizContainer" class="hidden">
            <!-- Question 1 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="1">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 1 of 11</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        A taxi company charges ₱40 for the first kilometer and ₱15 for each additional kilometer. What function models the total fare f(x) for x kilometers?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q1" value="a" class="mr-3">
                            <span>f(x) = 40 + 15x</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q1" value="b" class="mr-3">
                            <span>f(x) = 40 + 15(x - 1)</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q1" value="c" class="mr-3">
                            <span>f(x) = 40x + 15</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q1" value="d" class="mr-3">
                            <span>f(x) = 15x + 40</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 2 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="2">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 2 of 11</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        A mobile phone plan charges ₱500 monthly with ₱2 per minute for calls beyond the included 100 minutes. What is the function for the total cost C(x) where x is the total minutes used?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q2" value="a" class="mr-3">
                            <span>C(x) = 500 + 2x</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q2" value="b" class="mr-3">
                            <span>C(x) = 500 + 2(x - 100)</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q2" value="c" class="mr-3">
                            <span>C(x) = 500x + 2</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q2" value="d" class="mr-3">
                            <span>C(x) = 500 + 2(x + 100)</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 3 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="3">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 3 of 11</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        An electricity company charges ₱8 per kWh for the first 100 kWh and ₱12 per kWh for consumption above 100 kWh. What type of function is this?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q3" value="a" class="mr-3">
                            <span>Linear function</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q3" value="b" class="mr-3">
                            <span>Quadratic function</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q3" value="c" class="mr-3">
                            <span>Piecewise function</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q3" value="d" class="mr-3">
                            <span>Exponential function</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 4 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="4">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 4 of 11</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        A company's profit function is P(x) = 7,000x - 50,000, where x is the number of units sold. What does the break-even point represent?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q4" value="a" class="mr-3">
                            <span>The point where profit is maximum</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q4" value="b" class="mr-3">
                            <span>The point where revenue equals cost</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q4" value="c" class="mr-3">
                            <span>The point where cost is minimum</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q4" value="d" class="mr-3">
                            <span>The point where revenue is maximum</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 5 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="5">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 5 of 11</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        The temperature conversion from Celsius to Fahrenheit is given by F(C) = (9/5)C + 32. What is F(25)?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q5" value="a" class="mr-3">
                            <span>77°F</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q5" value="b" class="mr-3">
                            <span>45°F</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q5" value="c" class="mr-3">
                            <span>57°F</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q5" value="d" class="mr-3">
                            <span>32°F</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 6 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 6 of 11</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        A population grows according to P(t) = 100,000 × e^(0.02t), where t is time in years. What does the coefficient 0.02 represent?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q6" value="a" class="mr-3">
                            <span>Initial population</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q6" value="b" class="mr-3">
                            <span>Growth rate (2% per year)</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q6" value="c" class="mr-3">
                            <span>Time period</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q6" value="d" class="mr-3">
                            <span>Final population</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 7 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="7">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 7 of 11</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        Newton's Law of Cooling is modeled by T(t) = Tₐ + (T₀ - Tₐ)e^(-kt). What does Tₐ represent?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q7" value="a" class="mr-3">
                            <span>Initial temperature</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q7" value="b" class="mr-3">
                            <span>Ambient temperature</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q7" value="c" class="mr-3">
                            <span>Final temperature</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q7" value="d" class="mr-3">
                            <span>Cooling constant</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 8 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 8 of 11</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        A projectile's height is modeled by h(t) = h₀ + v₀t - ½gt². What does the term -½gt² represent?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q8" value="a" class="mr-3">
                            <span>Initial velocity effect</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q8" value="b" class="mr-3">
                            <span>Initial height effect</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q8" value="c" class="mr-3">
                            <span>Gravity effect (pulling down)</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q8" value="d" class="mr-3">
                            <span>Air resistance effect</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 9 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="9">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 9 of 11</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        A credit card charges 2% monthly interest on outstanding balances. If you have a balance of ₱10,000, what is the interest charge?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q9" value="a" class="mr-3">
                            <span>₱200</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q9" value="b" class="mr-3">
                            <span>₱20</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q9" value="c" class="mr-3">
                            <span>₱2,000</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q9" value="d" class="mr-3">
                            <span>₱2</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 10 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="10">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 10 of 11</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        A store offers bulk discounts: ₱100 per item for 1-10 items, ₱90 per item for 11-50 items, ₱80 per item for 50+ items. What type of function best describes this pricing?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q10" value="a" class="mr-3">
                            <span>Linear function</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q10" value="b" class="mr-3">
                            <span>Quadratic function</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q10" value="c" class="mr-3">
                            <span>Piecewise function</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q10" value="d" class="mr-3">
                            <span>Exponential function</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Problem Solving Question -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="11">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Problem Solving Question</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">5 points</span>
                </div>
                <div class="mb-6">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 mb-6">
                        <h4 class="text-lg font-semibold text-blue-800 mb-3">
                            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Problem Statement
                        </h4>
                        <p class="text-lg text-gray-700 mb-4">
                            A company's profit function is <span class="font-mono bg-gray-100 px-2 py-1 rounded">P(x) = -2x² + 100x - 800</span>, where:
                        </p>
                        <ul class="text-gray-700 space-y-2 mb-4">
                            <li><strong>x</strong> = number of units sold</li>
                            <li><strong>P(x)</strong> = profit in thousands of pesos</li>
                        </ul>
                        <p class="text-lg font-semibold text-blue-800">
                            Find the maximum profit (in thousands of pesos).
                        </p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-6 mb-6">
                        <h4 class="text-lg font-semibold text-green-800 mb-3">
                            <i class="fas fa-clipboard-list text-green-600 mr-2"></i>Step-by-Step Guide
                        </h4>
                        <div class="space-y-3 text-gray-700">
                            <div class="flex items-start">
                                <span class="bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 mt-0.5">1</span>
                                <div>
                                    <strong>Find the vertex:</strong> For a quadratic function ax² + bx + c, the vertex is at x = -b/(2a)
                                </div>
                            </div>
                            <div class="flex items-start">
                                <span class="bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 mt-0.5">2</span>
                                <div>
                                    <strong>Calculate x-coordinate:</strong> x = -100/(2×(-2)) = -100/(-4) = 25
                                </div>
                            </div>
                            <div class="flex items-start">
                                <span class="bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 mt-0.5">3</span>
                                <div>
                                    <strong>Substitute x = 25:</strong> P(25) = -2(25)² + 100(25) - 800
                                </div>
                            </div>
                            <div class="flex items-start">
                                <span class="bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 mt-0.5">4</span>
                                <div>
                                    <strong>Calculate:</strong> P(25) = -2(625) + 2500 - 800 = -1250 + 2500 - 800 = 450
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-6 shadow-sm border-2 border-gray-200">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calculator text-primary mr-2"></i>Enter your answer (in thousands of pesos):
                        </label>
                        <input type="number" id="ps-answer" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none text-lg" placeholder="Enter maximum profit (e.g., 450)">
                        <p class="text-sm text-gray-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>Hint: The answer should be a positive number between 400-500
                        </p>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center mb-8" id="submitButtonContainer">
                <button onclick="submitQuiz()" class="bg-gradient-to-r from-primary to-secondary text-white px-12 py-4 rounded-2xl font-bold text-lg shadow-2xl hover:shadow-3xl transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-check-circle mr-3"></i>
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Results Container -->
        <div id="resultsContainer" class="hidden">
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
                <div class="text-center mb-8">
                    <div id="resultsCharacter" class="w-24 h-24 mx-auto mb-4 flex items-center justify-center">
                        <img src="../Img/Character/tips_approved-removebg-preview.png" 
                             alt="Results Character" 
                             class="w-full h-full object-contain results-character"
                             style="filter: drop-shadow(0 10px 20px rgba(0,0,0,0.15));">
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Quiz Complete!</h2>
                    <p class="text-lg text-gray-600">Here's how you performed</p>
                </div>

                <!-- Score Summary -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-blue-600 mb-2" id="totalScore">0/15</div>
                        <div class="text-sm text-gray-600">Total Score</div>
                    </div>
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-green-600 mb-2" id="correctAnswers">0</div>
                        <div class="text-sm text-gray-600">Points Earned</div>
                    </div>
                    <div class="bg-gradient-to-r from-red-50 to-pink-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-red-600 mb-2" id="incorrectAnswers">0</div>
                        <div class="text-sm text-gray-600">Points Lost</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-purple-600 mb-2" id="completionTime">0:00</div>
                        <div class="text-sm text-gray-600">Completion Time</div>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-yellow-600 mb-2" id="studentRank">--</div>
                        <div class="text-sm text-gray-600">Your Rank</div>
                    </div>
                </div>

                <!-- Detailed Performance Analysis -->
                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6 mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">
                        <i class="fas fa-chart-line text-indigo-500 mr-2"></i>Performance Analysis
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">Multiple Choice Questions</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Questions:</span>
                                    <span class="font-semibold">10</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Points per question:</span>
                                    <span class="font-semibold">1 point</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total possible:</span>
                                    <span class="font-semibold">10 points</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">Problem Solving</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Questions:</span>
                                    <span class="font-semibold">1</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Points per question:</span>
                                    <span class="font-semibold">5 points</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total possible:</span>
                                    <span class="font-semibold">5 points</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 bg-white rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Overall Grade:</span>
                            <span class="text-2xl font-bold text-indigo-600" id="overallGrade">0%</span>
                        </div>
                        <div class="mt-2">
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-indigo-500 h-3 rounded-full transition-all duration-1000" id="gradeProgress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="showLeaderboard()" class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-8 py-3 rounded-xl font-semibold hover:shadow-lg transition-all duration-300">
                        <i class="fas fa-trophy mr-2"></i>
                        View Leaderboard
                    </button>
                    <button onclick="goToDashboard()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-3 rounded-xl font-semibold hover:shadow-lg transition-all duration-300">
                        <i class="fas fa-home mr-2"></i>
                        Back to Dashboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Leaderboard Container -->
        <div id="leaderboardContainer" class="hidden">
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-gradient-to-r from-yellow-500 to-orange-500 text-white rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-trophy text-3xl"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Class Leaderboard</h2>
                    <p class="text-lg text-gray-600">Top performers in your class ranked by score and speed</p>
                    <p class="text-sm text-gray-500 mt-2">Showing only students from your class and teacher</p>
                </div>

                <!-- Podium Section -->
                <div class="mb-12 mt-8">
                    <div class="flex justify-center items-end space-x-4 mb-8" id="podiumContainer">
                        <!-- Podium will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Leaderboard Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-blue-600 mb-2" id="totalParticipants">0</div>
                        <div class="text-sm text-gray-600">Total Participants</div>
                    </div>
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-green-600 mb-2" id="averageScore">0%</div>
                        <div class="text-sm text-gray-600">Average Score</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-purple-600 mb-2" id="fastestTime">0:00</div>
                        <div class="text-sm text-gray-600">Fastest Time</div>
                    </div>
                </div>

                <!-- Detailed Leaderboard -->
                <div class="bg-gray-50 rounded-xl overflow-hidden">
                    <div class="bg-gray-100 px-6 py-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-800">Detailed Rankings</h3>
                            <div class="flex items-center space-x-2 text-gray-600">
                                <span class="text-sm font-semibold">Points</span>
                                <i class="fas fa-info-circle text-xs"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-b-xl overflow-hidden" id="detailedLeaderboard">
                        <!-- Detailed leaderboard entries will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8">
                    <button onclick="hideLeaderboard()" class="bg-gradient-to-r from-primary to-secondary text-white px-8 py-3 rounded-xl font-semibold hover:shadow-lg transition-all duration-300">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Results
                    </button>
                    <button onclick="goToDashboard()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-3 rounded-xl font-semibold hover:shadow-lg transition-all duration-300">
                        <i class="fas fa-home mr-2"></i>
                        Back to Dashboard
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p>&copy; 2024 MathEase. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Timer variables
        let quizStartTime;
        let timerInterval;
        let quizDuration = 0; // in seconds
        let currentAttemptId = null;
        let isReviewMode = false;
        let quizDeadline = null;
        let quizStarted = false; // Track if quiz has been started
        
        // Anti-cheating variables
        let isQuizActive = false;
        let focusLostTime = null;
        let tabSwitchCount = 0;
        let isPageVisible = true;
        let hasExitedQuiz = false;
        let hasLoggedOut = false;
        let heartbeatInterval = null;
        let lastHeartbeat = null;
        
        // Anti-cheating limits
        const maxAllowedTabSwitches = 2; // Allow 2 tab switches before termination
        const maxAllowedFocusLoss = 30000; // 30 seconds focus loss limit

        // Quiz data with correct answers
        const quizData = {
            answers: {
                q1: 'b', // f(x) = 40 + 15(x-1)
                q2: 'b', // C(x) = 500 + 2(x-100)
                q3: 'c', // Piecewise function
                q4: 'b', // The point where revenue equals cost
                q5: 'a', // 77°F
                q6: 'b', // Growth rate (2% per year)
                q7: 'b', // Ambient temperature
                q8: 'c', // Gravity effect (pulling down)
                q9: 'a', // ₱200
                q10: 'c' // Piecewise function
            },
            problemSolving: {
                answer: 450 // Maximum profit: P(25) = -2(25)² + 100(25) - 800 = 450
            }
        };

        // Initialize quiz
        document.addEventListener('DOMContentLoaded', function() {
            // Check student authentication first
            checkStudentAuthentication();
            
            // Load user information
            loadUserInfo();
            
            // Check if student has already completed this quiz
            checkQuizCompletion();
            
            // Start quiz button
            document.getElementById('startQuizBtn').addEventListener('click', startQuiz);
            
            // Add event listeners to options
            addOptionListeners();
        });

        // Add event listeners to all options
        function addOptionListeners() {
            const options = document.querySelectorAll('.option');
            options.forEach(option => {
                option.addEventListener('click', function() {
                    if (!isReviewMode) {
                        const radio = this.querySelector('input[type="radio"]');
                        if (radio) {
                            radio.checked = true;
                            updateOptionStyles();
                            updateProgress(); // Update progress when option is selected
                        }
                    }
                });
            });
            
            // Add event listener for problem solving input
            const psInput = document.getElementById('ps-answer');
            if (psInput) {
                psInput.addEventListener('input', function() {
                    updateProgress(); // Update progress when typing in problem solving
                });
            }
        }

        // Update option styles when selected
        function updateOptionStyles() {
            const options = document.querySelectorAll('.option');
            options.forEach(option => {
                const radio = option.querySelector('input[type="radio"]');
                if (radio && radio.checked) {
                    option.classList.add('option-selected');
                } else {
                    option.classList.remove('option-selected');
                }
            });
        }

        // Start quiz function
        async function startQuiz() {
            try {
                // First, start the quiz attempt on the server
                const startResult = await startQuizAttempt();
                if (!startResult) {
                    return; // Error already handled in startQuizAttempt
                }
                
                // Set quiz started flag
                quizStarted = true;
                
                // Hide instructions container
                const instructionsContainer = document.querySelector('.max-w-4xl.mx-auto.px-4.sm\\:px-6.lg\\:px-8.py-8');
                if (instructionsContainer) {
                    instructionsContainer.style.display = 'none';
                }
                
                // Show progress timer container
                const progressTimerContainer = document.getElementById('progressTimerContainer');
                if (progressTimerContainer) {
                    progressTimerContainer.classList.remove('hidden');
                }
                
                // Show quiz container
                const quizContainer = document.getElementById('quizContainer');
                if (quizContainer) {
                    quizContainer.classList.remove('hidden');
                }
                
                // Start the timer
            startTimer();
                
                // Initialize anti-cheating system
                initializeAntiCheating();
                
                // Initialize quiz
                initializeQuiz();
            } catch (error) {
                console.error('Error starting quiz:', error);
                Swal.fire({
                    title: 'Quiz Start Error',
                    text: 'There was an error starting the quiz. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#667eea'
                });
            }
        }

        // Start quiz attempt on server
        async function startQuizAttempt() {
            try {
                const response = await fetch('../php/quiz-management.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=start_quiz&quiz_type=real-life-problems`,
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    Swal.fire({
                        title: 'Authentication Required',
                        text: 'Your session has expired. Please log in again to start the quiz.',
                        icon: 'warning',
                        confirmButtonText: 'Go to Login',
                        confirmButtonColor: '#667eea'
                    }).then(() => {
                        window.location.href = '../login.html';
                    });
                    return false;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    currentAttemptId = result.attempt_id;
                    console.log('Quiz attempt started with ID:', currentAttemptId);
                    return true;
                } else {
                    console.error('Error starting quiz attempt:', result.message);
                    Swal.fire({
                        title: 'Quiz Start Error',
                        text: result.message || 'Failed to start quiz. Please try again.',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#667eea'
                    });
                    return false;
                }
            } catch (error) {
                console.error('Error starting quiz attempt:', error);
                Swal.fire({
                    title: 'Connection Error',
                    text: 'Unable to start the quiz. Please check your internet connection and try again.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#667eea'
                });
                return false;
            }
        }

        // Start timer
        function startTimer() {
            quizStartTime = new Date();
            const startTimeString = quizStartTime.toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit'
            });
            document.getElementById('startTime').textContent = startTimeString;
            
            timerInterval = setInterval(updateTimer, 1000);
        }

        // Update timer display
        function updateTimer() {
            const now = new Date();
            const elapsed = Math.floor((now - quizStartTime) / 1000);
            quizDuration = elapsed;
            
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('quizTimer').textContent = timeString;
            
            // Update progress
            updateProgress();
        }

        // Update progress bar and text
        function updateProgress() {
            let answered = 0;
            
            // Count answered multiple choice questions
            for (let i = 1; i <= 10; i++) {
                if (document.querySelector(`input[name="q${i}"]:checked`)) {
                    answered++;
                }
            }
            
            // Check problem solving question
            const psAnswer = document.getElementById('ps-answer').value.trim();
            if (psAnswer) answered++;
            
            // Update progress text
            document.getElementById('progressText').textContent = `${answered}/11`;
            
            // Update progress bar
            const progressPercentage = (answered / 11) * 100;
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = `${progressPercentage}%`;
            }
        }

        // Update timer display from saved time
        function updateTimerDisplay() {
            const minutes = Math.floor(quizDuration / 60);
            const seconds = quizDuration % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('quizTimer').textContent = timeString;
        }

        // Stop timer
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                console.log('Timer stopped');
                
                // Update timer display to show it's stopped
                const timerElement = document.getElementById('quizTimer');
                if (timerElement) {
                    timerElement.textContent = 'STOPPED';
                    timerElement.classList.add('text-red-500');
                }
            }
        }

        // Initialize quiz
        function initializeQuiz() {
            // Add any initialization logic here
            console.log('Quiz initialized');
        }

        // Submit quiz function with confirmation
        async function submitQuiz() {
            try {
                // Check if quiz attempt ID exists
                if (!currentAttemptId) {
                    console.error('❌ No quiz attempt ID found');
                    Swal.fire({
                        title: 'Quiz Error',
                        text: 'Quiz session not properly initialized. Please refresh the page and try again.',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#667eea'
                    });
                    return;
                }
                
                // Check if all questions are answered
                const totalQuestions = 11; // 10 multiple choice + 1 problem solving question
                let answered = 0;
                
                for (let i = 1; i <= 10; i++) {
                    if (document.querySelector(`input[name="q${i}"]:checked`)) {
                        answered++;
                    }
                }
                
                const psAnswer = document.getElementById('ps-answer').value.trim();
                if (psAnswer) answered++;
                
                // Show confirmation dialog
                const result = await Swal.fire({
                    title: 'Submit Quiz?',
                    html: `
                        <div class="text-center">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-paper-plane text-blue-500 text-2xl"></i>
                            </div>
                            <p class="text-lg text-gray-700 mb-4">Are you ready to submit your quiz?</p>
                            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                <div class="text-2xl font-bold text-blue-600">${answered}/${totalQuestions}</div>
                                <div class="text-sm text-gray-500">Questions Answered</div>
                            </div>
                            <p class="text-sm text-gray-600">You cannot change your answers after submission.</p>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Yes, Submit Quiz',
                    cancelButtonText: 'Continue Quiz',
                    confirmButtonColor: '#10b981',
                    cancelButtonColor: '#6b7280',
                    background: '#ffffff',
                    customClass: {
                        popup: 'rounded-2xl',
                        title: 'text-slate-800',
                        content: 'text-slate-600'
                    }
                });
                
                if (!result.isConfirmed) {
                    return; // User cancelled submission
                }
                
                // Stop the timer
                stopTimer();
                
                // Stop anti-cheating monitoring
                stopAntiCheating();
                
                // Show loading
                Swal.fire({
                    title: 'Submitting Quiz...',
                    text: 'Please wait while we process your answers',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false,
                    background: '#ffffff',
                    customClass: {
                        popup: 'rounded-2xl',
                        title: 'text-slate-800',
                        content: 'text-slate-600'
                    },
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
            
                // Get student answers
            const answers = getStudentAnswers();
                
                // Calculate score
            const score = calculateScore(answers);
                const totalPossiblePoints = 15; // 10 multiple choice (1pt each) + 1 problem solving (5pts)
                const percentage = Math.round((score / totalPossiblePoints) * 100);
            
            // Save quiz attempt
            const attemptId = await saveQuizAttempt(answers, score, percentage);
                
                // Close loading dialog
                Swal.close();
            
            if (attemptId) {
                    currentAttemptId = attemptId;
                // Show results
                showResults(score, percentage, answers);
            } else {
                    Swal.fire({
                        title: 'Error',
                        text: 'There was an error saving your quiz. Please try again.',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#667eea'
                    });
                }
            } catch (error) {
                console.error('Error submitting quiz:', error);
                Swal.close(); // Close any open loading dialog
                Swal.fire({
                    title: 'Submission Error',
                    text: 'There was an error submitting your quiz. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#667eea'
                });
            }
        }

        // Get student answers
        function getStudentAnswers() {
            const answers = {};
            
            // Multiple choice questions
            for (let i = 1; i <= 10; i++) {
                const selected = document.querySelector(`input[name="q${i}"]:checked`);
                answers[`q${i}`] = selected ? selected.value : null;
            }
            
            // Problem solving question
            const psAnswer = document.getElementById('ps-answer').value;
            answers['q11'] = psAnswer;
            
            return answers;
        }

        // Calculate score
        function calculateScore(answers) {
            let score = 0;
            
            // Check multiple choice questions (1 point each)
            for (let i = 1; i <= 10; i++) {
                const questionKey = `q${i}`;
                const studentAnswer = answers[questionKey];
                const correctAnswer = quizData.answers[questionKey];
                
                if (studentAnswer && studentAnswer.toString().toLowerCase() === correctAnswer.toString().toLowerCase()) {
                    score++;
                }
            }
            
            // Check problem solving question (5 points)
            const psAnswer = answers['q11'];
            const psCorrect = quizData.problemSolving.answer;
            
            if (psAnswer && psAnswer.toString().toLowerCase() === psCorrect.toString().toLowerCase()) {
                score += 5; // 5 points for problem solving
            }
            
            return score;
        }

        // Save quiz attempt
        async function saveQuizAttempt(answers, score, percentage) {
            try {
                if (!currentAttemptId) {
                    console.error('No attempt ID available for submission');
                    Swal.fire({
                        title: 'Submission Error',
                        text: 'No quiz attempt found. Please start the quiz again.',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#667eea'
                    });
                    return null;
                }
                
                const response = await fetch('../php/quiz-management.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=submit_quiz&attempt_id=${currentAttemptId}&answers=${encodeURIComponent(JSON.stringify(answers))}&completion_time=${quizDuration}`,
                    credentials: 'include'
                });
                
                // Check for authentication errors
                if (response.status === 401) {
                    Swal.fire({
                        title: 'Authentication Required',
                        text: 'Your session has expired. Please log in again to save your quiz.',
                        icon: 'warning',
                        confirmButtonText: 'Go to Login',
                        confirmButtonColor: '#667eea'
                    }).then(() => {
                        window.location.href = '../login.html';
                    });
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('Quiz submitted successfully, attempt ID:', currentAttemptId);
                    return currentAttemptId; // Return the existing attempt ID
                } else {
                    console.error('Error saving quiz:', result.message);
                    
                    // Show specific error message to user
                    if (result.message && result.message.includes('authentication')) {
                        Swal.fire({
                            title: 'Authentication Error',
                            text: 'Your session has expired. Please log in again.',
                            icon: 'error',
                            confirmButtonText: 'Go to Login',
                            confirmButtonColor: '#667eea'
                        }).then(() => {
                            window.location.href = '../login.html';
                        });
                    } else {
                        Swal.fire({
                            title: 'Save Error',
                            text: result.message || 'Failed to save your quiz. Please try again.',
                            icon: 'error',
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#667eea'
                        });
                    }
                    return null;
                }
            } catch (error) {
                console.error('Error saving quiz:', error);
                Swal.fire({
                    title: 'Connection Error',
                    text: 'Unable to save your quiz. Please check your internet connection and try again.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#667eea'
                });
                return null;
            }
        }

        // Show results
        async function showResults(score, percentage, answers) {
            try {
                // Show results
                const quizContainer = document.getElementById('quizContainer');
                const resultsContainer = document.getElementById('resultsContainer');
                
                if (quizContainer) quizContainer.classList.add('hidden');
                if (resultsContainer) resultsContainer.classList.remove('hidden');
                
                const totalQuestions = 11; // 10 multiple choice + 1 problem solving question
                const totalPoints = 15; // 10 multiple choice (1pt each) + 1 problem solving (5pts)
                
                // Update score displays
                const totalScoreEl = document.getElementById('totalScore');
                const correctAnswersEl = document.getElementById('correctAnswers');
                const incorrectAnswersEl = document.getElementById('incorrectAnswers');
                const completionTimeEl = document.getElementById('completionTime');
                
                if (totalScoreEl) totalScoreEl.textContent = `${score}/${totalPoints}`;
                if (correctAnswersEl) correctAnswersEl.textContent = score;
                if (incorrectAnswersEl) incorrectAnswersEl.textContent = totalPoints - score;
                if (completionTimeEl) completionTimeEl.textContent = formatTime(quizDuration);
                
                // Update overall grade
                const overallGradeEl = document.getElementById('overallGrade');
                const gradeProgressEl = document.getElementById('gradeProgress');
                
                if (overallGradeEl) overallGradeEl.textContent = `${percentage}%`;
                if (gradeProgressEl) {
                    gradeProgressEl.style.width = `${percentage}%`;
                    
                    // Change progress bar color based on grade
                    if (percentage >= 80) {
                        gradeProgressEl.className = 'bg-green-500 h-3 rounded-full transition-all duration-1000';
                    } else if (percentage >= 60) {
                        gradeProgressEl.className = 'bg-yellow-500 h-3 rounded-full transition-all duration-1000';
                    } else {
                        gradeProgressEl.className = 'bg-red-500 h-3 rounded-full transition-all duration-1000';
                    }
                }

                // Get and display student's rank (with small delay to ensure database is updated)
                setTimeout(async () => {
                    await displayStudentRank();
                    
                    // If rank is still not found, try again after a longer delay
                    setTimeout(async () => {
                        const rankEl = document.getElementById('studentRank');
                        if (rankEl && rankEl.textContent === '--') {
                            console.log('Rank still not found, trying again...');
                            await displayStudentRank();
                        }
                    }, 3000);
                }, 1000);

                // Update character based on performance
                updateResultsCharacter(percentage);

                // Check and award badges only if quiz is successfully completed
                if (score > 0) {
                    await checkAndAwardBadges({
                        score: score,
                        total_questions: totalPoints,
                        percentage: percentage
                    });
                } else {
                    console.log('Skipping badge check - score is 0');
                }

                // Scroll to results
                if (resultsContainer) {
                    resultsContainer.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error('Error showing results:', error);
                Swal.fire({
                    title: 'Results Error',
                    text: 'Unable to display quiz results. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#667eea'
                });
            }
        }

        // Format time in MM:SS format
        function formatTime(seconds) {
            // Handle undefined, null, or non-numeric values
            if (seconds === undefined || seconds === null || isNaN(seconds)) {
                return '0:00';
            }
            
            // Ensure seconds is a number
            const numSeconds = Number(seconds);
            if (isNaN(numSeconds) || numSeconds < 0) {
                return '0:00';
            }
            
            const minutes = Math.floor(numSeconds / 60);
            const remainingSeconds = numSeconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Display student's rank
        async function displayStudentRank() {
            try {
                console.log('Fetching student rank...');
                const response = await fetch('../php/quiz-management.php?action=get_leaderboard&quiz_type=real-life-problems&limit=50&same_class_only=true', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Leaderboard response:', result);
                
                if (result.success && result.leaderboard) {
                    console.log('Leaderboard data:', result.leaderboard);
                    
                    // Find the current student in the leaderboard using is_current_user flag
                    let currentStudent = result.leaderboard.find(student => student.is_current_user == 1 || student.is_current_user === true);
                    console.log('Current student found by is_current_user:', currentStudent);
                    
                    // Fallback: try to find by attempt_id if is_current_user doesn't work
                    if (!currentStudent && currentAttemptId) {
                        currentStudent = result.leaderboard.find(student => student.attempt_id == currentAttemptId);
                        console.log('Current student found by attempt_id:', currentStudent);
                    }
                    
                    // Fallback: try to find by position in array (if it's the most recent attempt)
                    if (!currentStudent && result.leaderboard.length > 0) {
                        // If no specific identification works, assume the first entry is the current user
                        // This is a last resort and might not be accurate
                        console.log('Using fallback: assuming first entry is current user');
                        currentStudent = result.leaderboard[0];
                    }
                    
                    if (currentStudent) {
                        const rankElement = document.getElementById('studentRank');
                        const rank = currentStudent.rank_position;
                        console.log('Student rank position:', rank);
                        console.log('Student data:', currentStudent);
                        
                        if (rankElement) {
                            if (rank && rank > 0) {
                                rankElement.textContent = `#${rank}`;
                                console.log('Updated rank display to:', `#${rank}`);
                            } else {
                                rankElement.textContent = '--';
                                console.log('No valid rank found, showing --');
                            }
                        }
                    } else {
                        console.log('Current student not found in leaderboard');
                        console.log('Available students:', result.leaderboard.map(s => ({ 
                            name: s.student_name, 
                            is_current_user: s.is_current_user, 
                            attempt_id: s.attempt_id 
                        })));
                        const rankElement = document.getElementById('studentRank');
                        if (rankElement) {
                            rankElement.textContent = '--';
                        }
                    }
                } else {
                    console.log('No leaderboard data available:', result.message);
                    const rankElement = document.getElementById('studentRank');
                    if (rankElement) {
                        rankElement.textContent = '--';
                    }
                }
            } catch (error) {
                console.error('Error getting student rank:', error);
                const rankElement = document.getElementById('studentRank');
                if (rankElement) {
                    rankElement.textContent = '--';
                }
            }
        }

        // Load leaderboard
        async function loadLeaderboard() {
            const podiumContainer = document.getElementById('podiumContainer');
            const detailedLeaderboard = document.getElementById('detailedLeaderboard');
            
            try {
                console.log('Loading leaderboard...');
                
                // Show loading state
                podiumContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl mb-4 text-blue-500"></i>
                        <p class="text-lg text-gray-500">Loading leaderboard...</p>
                    </div>
                `;
                
                detailedLeaderboard.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2 text-blue-500"></i>
                        <p class="text-sm text-gray-500">Loading details...</p>
                    </div>
                `;
                
                const response = await fetch('../php/quiz-management.php?action=get_leaderboard&quiz_type=real-life-problems&limit=50&same_class_only=true', {
                    credentials: 'include'
                });
                
                // Check for authentication errors
                if (response.status === 401) {
                    console.warn('Authentication required for leaderboard - user may not be logged in');
                    podiumContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-lock text-4xl mb-4"></i>
                            <p class="text-lg">Authentication required</p>
                        </div>
                    `;
                    detailedLeaderboard.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-lock text-2xl mb-2"></i>
                            <p class="text-sm">Authentication required</p>
                        </div>
                    `;
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.leaderboard) {
                    console.log('Leaderboard data received:', result.leaderboard);
                    updateLeaderboardStats(result.leaderboard);
                    createPodium(result.leaderboard.slice(0, 3));
                    createDetailedLeaderboard(result.leaderboard);
                } else {
                    console.warn('Failed to load leaderboard:', result.message);
                    podiumContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p class="text-lg">Failed to load leaderboard</p>
                        </div>
                    `;
                    detailedLeaderboard.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p class="text-sm">Failed to load details</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                podiumContainer.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p class="text-lg">Error loading leaderboard</p>
                        <p class="text-sm">Please try again later</p>
                    </div>
                `;
                detailedLeaderboard.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p class="text-sm">Error loading details</p>
                    </div>
                `;
            }
        }

        // Update leaderboard statistics
        function updateLeaderboardStats(leaderboard) {
            console.log('Updating leaderboard stats with data:', leaderboard);
            
            const totalParticipants = leaderboard.length;
            const averageScore = leaderboard.length > 0 ? 
                Math.round(leaderboard.reduce((sum, entry) => sum + (entry.percentage || 0), 0) / leaderboard.length) : 0;
            const fastestTime = leaderboard.length > 0 ? 
                Math.min(...leaderboard.map(entry => entry.completion_time || entry.time_taken || 0)) : 0;
            
            document.getElementById('totalParticipants').textContent = totalParticipants;
            document.getElementById('averageScore').textContent = `${averageScore}%`;
            document.getElementById('fastestTime').textContent = formatTime(fastestTime);
            
            console.log('Leaderboard stats updated - Participants:', totalParticipants, 'Average:', averageScore, 'Fastest:', fastestTime);
        }

        // Create podium for top 3 students
        function createPodium(topThree) {
            const podiumContainer = document.getElementById('podiumContainer');
            
            if (topThree.length === 0) {
                podiumContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-trophy text-4xl mb-4 text-gray-300"></i>
                        <p class="text-lg">No participants yet</p>
                    </div>
                `;
                return;
            }
            
            // Ensure we have at least 3 positions, fill with empty if needed
            const podiumData = [
                topThree[0] || null,
                topThree[1] || null,
                topThree[2] || null
            ];
            
            podiumContainer.innerHTML = '';
            
            // Create podium blocks (2nd, 1st, 3rd order for visual effect)
            const podiumOrder = [1, 0, 2]; // 2nd place, 1st place, 3rd place
            
            podiumOrder.forEach((index, position) => {
                const student = podiumData[index];
                const podiumBlock = document.createElement('div');
                podiumBlock.className = 'podium-block';
                
                if (student) {
                    const isCurrentStudent = student.is_current_user == 1 || student.is_current_user === true;
                    const rank = student.rank_position;
                    
                    // Get initials from student_name
                    const initials = student.student_name ? student.student_name.split(' ').map(n => n[0]).join('').toUpperCase() : 'US';
                    
                    podiumBlock.innerHTML = `
                        <div class="podium-${rank}">
                            <div class="podium-rank podium-rank-${rank}">${rank}</div>
                            <div class="podium-avatar ${isCurrentStudent ? 'ring-4 ring-blue-300' : ''}" style="background: ${isCurrentStudent ? 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)' : 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)'};">
                                <span class="text-white text-lg font-bold">${initials}</span>
                            </div>
                            ${rank === 1 ? '<div class="podium-crown">👑</div>' : ''}
                        </div>
                        <div class="podium-info">
                            <div class="podium-name">${student.student_name || 'Unknown Student'}</div>
                            <div class="podium-points">${student.score}/${student.total_questions || 15} points</div>
                            <div class="text-xs text-gray-500 mt-1">${formatTime(student.completion_time || student.time_taken)}</div>
                        </div>
                    `;
                } else {
                    podiumBlock.innerHTML = `
                        <div class="podium-${index + 1}" style="background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);">
                            <div class="podium-rank podium-rank-${index + 1}" style="background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);">${index + 1}</div>
                            <div class="podium-avatar" style="background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);">
                                <i class="fas fa-user text-gray-400"></i>
                            </div>
                        </div>
                        <div class="podium-info">
                            <div class="podium-name text-gray-400">--</div>
                            <div class="podium-points text-gray-400">--</div>
                            <div class="text-xs text-gray-400 mt-1">--</div>
                        </div>
                    `;
                }
                
                podiumContainer.appendChild(podiumBlock);
            });
        }
        
        // Create detailed leaderboard list
        function createDetailedLeaderboard(leaderboardData) {
            const detailedLeaderboard = document.getElementById('detailedLeaderboard');
            
            if (leaderboardData.length === 0) {
                detailedLeaderboard.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-trophy text-2xl mb-2 text-gray-300"></i>
                        <p class="text-sm">No participants yet</p>
                    </div>
                `;
                return;
            }
            
            detailedLeaderboard.innerHTML = '';
            
            // Separate cheating students from regular students
            const cheatingStudents = leaderboardData.filter(student => 
                student.cheating_reason && student.cheating_reason !== null
            );
            const regularStudents = leaderboardData.filter(student => 
                !student.cheating_reason || student.cheating_reason === null
            );
            
            // Show top 5 regular students
            const topFive = regularStudents.slice(0, 5);
            
            topFive.forEach((student, index) => {
                const entry = createLeaderboardEntry(student, index + 1, false);
                detailedLeaderboard.appendChild(entry);
            });
            
            // Add cheating students section if there are any
            if (cheatingStudents.length > 0) {
                // Add separator
                const separator = document.createElement('div');
                separator.className = 'border-t border-red-200 my-4';
                detailedLeaderboard.appendChild(separator);
                
                // Add cheating section header
                const cheatingHeader = document.createElement('div');
                cheatingHeader.className = 'text-center py-2';
                cheatingHeader.innerHTML = `
                    <div class="flex items-center justify-center text-red-600 font-medium">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Students with Academic Integrity Violations
                    </div>
                `;
                detailedLeaderboard.appendChild(cheatingHeader);
                
                // Add cheating students
                cheatingStudents.forEach((student, index) => {
                    const entry = createLeaderboardEntry(student, 0, true);
                    detailedLeaderboard.appendChild(entry);
                });
            }
        }
        
        // Create individual leaderboard entry
        function createLeaderboardEntry(student, rank, isCheating) {
            console.log('Creating leaderboard entry for student:', student, 'rank:', rank, 'isCheating:', isCheating);
            
            const entry = document.createElement('div');
            const isCurrentStudent = student.is_current_user == 1 || student.is_current_user === true;
            
            // Ensure we have valid student data
            const studentName = student.student_name || 'Unknown Student';
            const initials = studentName.split(' ').map(n => n[0]).join('').toUpperCase();
            const timeTaken = student.completion_time || student.time_taken || 0;
            const score = student.score || 0;
            const totalQuestions = student.total_questions || 15; // Total points, not questions
            const quizDate = student.quiz_date || new Date().toISOString();
            
            if (isCheating) {
                entry.className = `bg-red-50 border-l-4 border-red-400 p-4 ${isCurrentStudent ? 'ring-2 ring-red-300' : ''}`;
            } else {
                entry.className = `bg-white border-l-4 border-blue-400 p-4 ${isCurrentStudent ? 'ring-2 ring-blue-300' : ''}`;
            }
            
            entry.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            ${rank > 0 ? `<span class="text-lg font-bold ${isCheating ? 'text-red-600' : 'text-blue-600'}">#${rank}</span>` : ''}
                            ${isCheating ? '<i class="fas fa-exclamation-triangle text-red-500"></i>' : ''}
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 ${isCheating ? 'bg-red-500' : 'bg-blue-500'} rounded-full flex items-center justify-center">
                                <span class="text-white text-sm font-bold">${initials}</span>
                            </div>
                            <div>
                                <div class="font-semibold ${isCheating ? 'text-red-600' : 'text-gray-800'}">${studentName}</div>
                                <div class="text-sm text-gray-500">${formatTime(timeTaken)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold ${isCheating ? 'text-red-600' : 'text-blue-600'}">${isCheating ? '0' : score}/${totalQuestions}</div>
                        <div class="text-sm text-gray-500">${new Date(quizDate).toLocaleDateString()}</div>
                        ${isCurrentStudent ? '<span class="ml-2 bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">You</span>' : ''}
                    </div>
                </div>
            `;
            
            return entry;
        }


        // Show leaderboard
        function showLeaderboard() {
            document.getElementById('resultsContainer').classList.add('hidden');
            document.getElementById('leaderboardContainer').classList.remove('hidden');
            loadLeaderboard();
            
            // Scroll to leaderboard
            document.getElementById('leaderboardContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // Hide leaderboard
        function hideLeaderboard() {
            document.getElementById('leaderboardContainer').classList.add('hidden');
            document.getElementById('resultsContainer').classList.remove('hidden');
        }

        // Go to dashboard
        function goToDashboard() {
            window.location.href = '../dashboard.html';
        }

        // ==================== ANTI-CHEATING SYSTEM ====================
        
        // Initialize anti-cheating monitoring
        function initializeAntiCheating() {
            console.log('🔧 Initializing anti-cheating system...');
            
            // Stop any existing anti-cheating first
            stopAntiCheating();
            
            // Reset variables
            tabSwitchCount = 0;
            focusLostTime = null;
            isPageVisible = true;
            hasExitedQuiz = false;
            hasLoggedOut = false;
            isQuizActive = true; // Ensure quiz is marked as active
            
            // Start heartbeat monitoring
            startHeartbeat();
            
            // Monitor page visibility - CRITICAL for tab switch detection
            document.addEventListener('visibilitychange', handleVisibilityChange);
            console.log('✅ Visibility change listener attached');
            
            // Monitor window focus
            window.addEventListener('focus', handleWindowFocus);
            window.addEventListener('blur', handleWindowBlur);
            console.log('✅ Focus/blur listeners attached');
            
            // Monitor beforeunload (page exit)
            window.addEventListener('beforeunload', handleBeforeUnload);
            
            // Monitor page unload (logout, close tab)
            window.addEventListener('unload', handlePageUnload);
            
            // Monitor new tab/window opening
            window.addEventListener('beforeunload', handleNewTab);
            
            // Monitor keyboard shortcuts for new tab
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            console.log('✅ Anti-cheating system initialized');
            console.log('📊 Initial state - Tab switches: 0, Quiz active: true');
            console.log('🔍 Event listeners attached for visibility, focus, blur, keyboard');
            
            // Test the visibility change detection immediately
            console.log('🧪 Testing visibility change detection...');
            setTimeout(() => {
                console.log('🔍 Current document.hidden:', document.hidden);
                console.log('🔍 Current isQuizActive:', isQuizActive);
            }, 100);
        }
        
        // Stop anti-cheating monitoring
        function stopAntiCheating() {
            console.log('Stopping anti-cheating system...');
            
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
            
            // Remove event listeners
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            window.removeEventListener('focus', handleWindowFocus);
            window.removeEventListener('blur', handleWindowBlur);
            window.removeEventListener('beforeunload', handleBeforeUnload);
            window.removeEventListener('unload', handlePageUnload);
            document.removeEventListener('keydown', handleKeyboardShortcuts);
            
            isQuizActive = false;
            console.log('Anti-cheating system stopped');
        }
        
        // Start heartbeat monitoring
        function startHeartbeat() {
            lastHeartbeat = Date.now();
            
            heartbeatInterval = setInterval(async () => {
                if (!isQuizActive) return;
                
                try {
                    // Send heartbeat to server
                    const response = await fetch('../php/quiz-management.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `action=heartbeat&attempt_id=${currentAttemptId}`,
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (!result.success) {
                            console.warn('Heartbeat failed:', result.message);
                        }
                    }
                } catch (error) {
                    console.error('Heartbeat error:', error);
                }
                
                lastHeartbeat = Date.now();
            }, 10000); // Send heartbeat every 10 seconds
        }
        
        // Handle page visibility changes
        function handleVisibilityChange() {
            console.log('🔍 Visibility change detected - isQuizActive:', isQuizActive, 'document.hidden:', document.hidden);
            console.log('🔍 Current tab switch count:', tabSwitchCount);
            console.log('🔍 Max allowed tab switches:', maxAllowedTabSwitches);
            
            if (!isQuizActive) {
                console.log('❌ Quiz not active - ignoring visibility change');
                return;
            }
            
            if (document.hidden) {
                console.log('👁️ Page became hidden - potential cheating detected');
                focusLostTime = Date.now();
                isPageVisible = false;
                
                // Only increment tab switch count if this is a real tab switch
                // Add a small delay to avoid counting rapid visibility changes
                setTimeout(() => {
                    if (document.hidden && isQuizActive) {
                        tabSwitchCount++;
                        
                        console.log(`📊 Tab switch count: ${tabSwitchCount}/${maxAllowedTabSwitches}`);
                        console.log(`📊 Will trigger cheating on: ${maxAllowedTabSwitches} switches`);
                        
                        // Check if too many tab switches (trigger on 2nd switch)
                        if (tabSwitchCount >= maxAllowedTabSwitches) {
                            console.log('🚨 MAXIMUM TAB SWITCHES EXCEEDED - TERMINATING QUIZ WITH 0 SCORE');
                            console.log(`Student switched tabs ${tabSwitchCount} times (limit: ${maxAllowedTabSwitches})`);
                            
                            // Stop the quiz immediately
                            isQuizActive = false;
                            stopTimer();
                            
                            // Mark as cheating
                            markAsCheating('excessive_tab_switches');
                            return;
                        }
                        
                        // Show warning for first switch
                        if (tabSwitchCount === 1) {
                            console.log('⚠️ First tab switch - showing warning');
                            showCheatingWarning('Tab Switch Detected', 
                                `You have switched tabs ${tabSwitchCount}/${maxAllowedTabSwitches} times. 
                                ${maxAllowedTabSwitches - tabSwitchCount} more switch will result in automatic submission with zero score.`);
                        }
                    }
                }, 100); // 100ms delay to avoid rapid counting
            } else {
                console.log('👁️ Page became visible');
                isPageVisible = true;
                
                // Check if focus was lost for too long
                if (focusLostTime) {
                    const focusLossDuration = Date.now() - focusLostTime;
                    console.log(`⏱️ Focus was lost for ${focusLossDuration}ms (limit: ${maxAllowedFocusLoss}ms)`);
                    if (focusLossDuration > maxAllowedFocusLoss) {
                        console.log('🚨 Focus lost for too long - marking as cheating');
                        markAsCheating('excessive_focus_loss');
                        return;
                    }
                }
                
                focusLostTime = null;
            }
        }
        
        // Handle window focus
        function handleWindowFocus() {
            if (!isQuizActive) return;
            
            console.log('Window focused');
            isPageVisible = true;
            focusLostTime = null;
        }
        
        // Handle window blur
        function handleWindowBlur() {
            if (!isQuizActive) return;
            
            console.log('Window blurred - potential cheating detected');
            focusLostTime = Date.now();
            isPageVisible = false;
        }
        
        // Handle before page unload
        function handleBeforeUnload(event) {
            if (!isQuizActive) return;
            
            console.log('Page is about to unload - potential cheating detected');
            hasExitedQuiz = true;
            
            // Mark as cheating immediately
            markAsCheating('page_exit');
            
            // Show warning message
            event.preventDefault();
            event.returnValue = 'Are you sure you want to leave? This will result in a zero score.';
            return 'Are you sure you want to leave? This will result in a zero score.';
        }
        
        // Handle page unload (logout, close tab)
        function handlePageUnload() {
            if (!isQuizActive) return;
            
            console.log('Page unloaded - marking as cheating');
            hasExitedQuiz = true;
            markAsCheating('page_unload');
        }
        
        // Handle new tab detection
        function handleNewTab(event) {
            if (!isQuizActive) return;
            
            // This is a simplified detection - in practice, you'd need more sophisticated methods
            console.log('Potential new tab/window opened');
        }
        
        // Handle keyboard shortcuts for new tab
        function handleKeyboardShortcuts(event) {
            if (!isQuizActive) return;
            
            // Detect Ctrl+T (new tab) or Ctrl+N (new window)
            if ((event.ctrlKey || event.metaKey) && (event.key === 't' || event.key === 'n')) {
                console.log('New tab/window shortcut detected - potential cheating');
                event.preventDefault();
                showCheatingWarning('Shortcut Blocked', 
                    'Opening new tabs or windows during the quiz is not allowed and will result in a zero score.');
            }
        }
        
        // Mark attempt as cheating
        async function markAsCheating(reason) {
            if (!currentAttemptId) {
                console.log('❌ No current attempt ID - trying to get current attempt...');
                
                // Try to get the current attempt ID
                try {
                    const response = await fetch('../php/quiz-management.php?action=check_existing_attempt&quiz_type=real-life-problems', {
                        credentials: 'include'
                    });
                    const result = await response.json();
                    
                    if (result.success && result.attempt) {
                        currentAttemptId = result.attempt.id;
                        console.log('✅ Retrieved current attempt ID:', currentAttemptId);
                    } else {
                        console.log('❌ No current attempt found - cannot mark as cheating');
                        // Still show the cheating notification even without database update
                        showCheatingNotification(reason);
                        stopQuizDueToCheating();
                        return;
                    }
                } catch (error) {
                    console.error('❌ Error getting current attempt:', error);
                    // Still show the cheating notification even without database update
                    showCheatingNotification(reason);
                    stopQuizDueToCheating();
                    return;
                }
            }
            
            console.log(`🚨 Marking attempt ${currentAttemptId} as cheating - reason: ${reason}`);
            
            // Stop the quiz immediately to prevent further interaction
            isQuizActive = false;
            stopTimer();
            stopAntiCheating();
            
            try {
                const response = await fetch('../php/quiz-management.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=mark_cheating&attempt_id=${currentAttemptId}&reason=${reason}`,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log('✅ Successfully marked as cheating');
                        
                        // Show cheating notification
                        showCheatingNotification(reason);
                        
                        // Stop the quiz completely
                        stopQuizDueToCheating();
                    } else {
                        console.log('❌ Failed to mark as cheating:', result.message);
                        showCheatingNotification(reason);
                        stopQuizDueToCheating();
                    }
                } else {
                    console.log('❌ Failed to mark as cheating - server error');
                    showCheatingNotification(reason);
                    stopQuizDueToCheating();
                }
            } catch (error) {
                console.error('❌ Error marking as cheating:', error);
                showCheatingNotification(reason);
                stopQuizDueToCheating();
            }
        }
        
        // Show cheating warning
        function showCheatingWarning(title, message) {
            Swal.fire({
                title: title,
                html: `
                    <div class="text-center">
                        <div class="w-24 h-24 mx-auto mb-4 flex items-center justify-center">
                            <img src="../Img/Character/warning_example-removebg-preview.png" 
                                 alt="Warning Character" 
                                 class="w-full h-full object-contain warning-character"
                                 style="filter: drop-shadow(0 10px 20px rgba(0,0,0,0.15));">
                        </div>
                        <p class="text-slate-600 text-lg leading-relaxed">${message}</p>
                    </div>
                `,
                confirmButtonText: 'I Understand',
                confirmButtonColor: '#f59e0b',
                background: '#ffffff',
                customClass: {
                    popup: 'rounded-2xl',
                    title: 'text-slate-800',
                    content: 'text-slate-600'
                },
                allowOutsideClick: false,
                allowEscapeKey: false
            });
        }
        
        // Show cheating notification
        function showCheatingNotification(reason) {
            let reasonText = '';
            switch(reason) {
                case 'excessive_tab_switches':
                    reasonText = 'Excessive tab switching detected';
                    break;
                case 'excessive_focus_loss':
                    reasonText = 'Focus lost for too long';
                    break;
                case 'page_exit':
                    reasonText = 'Attempted to leave the quiz page';
                    break;
                case 'page_unload':
                    reasonText = 'Quiz page was closed or refreshed';
                    break;
                default:
                    reasonText = 'Suspicious activity detected';
            }
            
            // Update character to show sad/cheating state
            const characterImg = document.querySelector('#resultsCharacter img');
            if (characterImg) {
                characterImg.src = '../Img/Character/sad-removebg-preview.png';
                characterImg.alt = 'Sad Character - Cheating Detected';
                characterImg.classList.add('sad');
                console.log('😢 Showing sad character for cheating incident');
            }
            
            Swal.fire({
                title: 'Quiz Terminated',
                html: `
                    <div class="text-center">
                        <div class="w-24 h-24 mx-auto mb-4 flex items-center justify-center">
                            <img src="../Img/Character/sad-removebg-preview.png" 
                                 alt="Sad Character" 
                                 class="w-full h-full object-contain results-character sad"
                                 style="filter: drop-shadow(0 10px 20px rgba(0,0,0,0.15));">
                        </div>
                        <p class="text-lg text-gray-700 mb-4">Your quiz has been terminated due to:</p>
                        <div class="bg-red-50 rounded-lg p-4 mb-4">
                            <p class="text-red-800 font-semibold">${reasonText}</p>
                        </div>
                        <p class="text-sm text-gray-600">Your score will be recorded as 0/15 (0%)</p>
                    </div>
                `,
                icon: 'error',
                confirmButtonText: 'Back to Dashboard',
                confirmButtonColor: '#ef4444',
                background: '#ffffff',
                customClass: {
                    popup: 'rounded-2xl',
                    title: 'text-slate-800',
                    content: 'text-slate-600'
                },
                allowOutsideClick: false,
                allowEscapeKey: false
            }).then(() => {
                window.location.href = '../dashboard.html';
            });
        }
        
        // Stop quiz due to cheating
        function stopQuizDueToCheating() {
            // Hide quiz container
            const quizContainer = document.getElementById('quizContainer');
            if (quizContainer) {
                quizContainer.style.display = 'none';
            }
            
            // Disable all quiz interactions
            const options = document.querySelectorAll('.option');
            options.forEach(option => {
                option.style.pointerEvents = 'none';
                option.style.opacity = '0.5';
            });
            
            // Disable submit button
            const submitButton = document.querySelector('[onclick="submitQuiz()"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = 'Quiz Terminated';
            }
            
            // Stop anti-cheating
            stopAntiCheating();
        }
        
        // Check if page was refreshed (allow continuation)
        function isPageRefresh() {
            // Check if the page was refreshed by looking at performance navigation
            if (performance.navigation && performance.navigation.type === 1) {
                return true; // Page was refreshed
            }
            
            // Check if the page was refreshed by looking at performance timing
            if (performance.timing && performance.timing.navigationStart) {
                const now = Date.now();
                const navigationStart = performance.timing.navigationStart;
                const timeSinceNavigation = now - navigationStart;
                
                // If less than 5 seconds since navigation, likely a refresh
                return timeSinceNavigation < 5000;
            }
            
            return false;
        }

        // Load user information
        async function loadUserInfo() {
            try {
                const response = await fetch('../php/user.php', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.user) {
                        document.getElementById('userName').textContent = result.user.first_name + ' ' + result.user.last_name;
                    }
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                // Don't show error to user as this is not critical
            }
        }

        // Check student authentication
        async function checkStudentAuthentication() {
            try {
                const response = await fetch('../php/quiz-management.php?action=check_existing_attempt&quiz_type=real-life-problems', {
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    // Authentication required
                    Swal.fire({
                        title: 'Authentication Required',
                        html: `
                            <div class="text-center">
                                <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-lock text-red-500 text-3xl"></i>
                                </div>
                                <p class="text-lg text-gray-700 mb-4">You need to be logged in to take this quiz</p>
                                <p class="text-sm text-gray-600">Please log in with your student account to continue.</p>
                            </div>
                        `,
                        icon: 'warning',
                        confirmButtonText: 'Go to Login',
                        confirmButtonColor: '#667eea',
                        background: '#ffffff',
                        customClass: {
                            popup: 'rounded-2xl',
                            title: 'text-slate-800',
                            content: 'text-slate-600'
                        },
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = '../login.html';
                        }
                    });
                    return false;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.error_code === 'AUTH_REQUIRED') {
                    // Authentication required
                    Swal.fire({
                        title: 'Authentication Required',
                        html: `
                            <div class="text-center">
                                <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-lock text-red-500 text-3xl"></i>
                                </div>
                                <p class="text-lg text-gray-700 mb-4">You need to be logged in to take this quiz</p>
                                <p class="text-sm text-gray-600">Please log in with your student account to continue.</p>
                            </div>
                        `,
                        icon: 'warning',
                        confirmButtonText: 'Go to Login',
                        confirmButtonColor: '#667eea',
                        background: '#ffffff',
                        customClass: {
                            popup: 'rounded-2xl',
                            title: 'text-slate-800',
                            content: 'text-slate-600'
                        },
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = '../login.html';
                        }
                    });
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Error checking authentication:', error);
                Swal.fire({
                    title: 'Connection Error',
                    text: 'Unable to verify your authentication. Please check your internet connection and try again.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#667eea'
                });
                return false;
            }
        }

        // Check if student has already completed this quiz
        async function checkQuizCompletion() {
            try {
                const response = await fetch('../php/quiz-management.php?action=get_student_history&quiz_type=real-life-problems', {
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success && result.attempts && result.attempts.length > 0) {
                    const latestAttempt = result.attempts[0];
                    
                    Swal.fire({
                        title: 'Quiz Already Completed',
                        html: `
                            <div class="text-center">
                                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-check-circle text-blue-500 text-3xl"></i>
                                </div>
                                <p class="text-lg text-gray-700 mb-4">You have already completed this quiz!</p>
                                <div class="bg-blue-50 rounded-lg p-4 mb-4">
                                    <div class="text-2xl font-bold text-blue-600">${latestAttempt.score}/${latestAttempt.total_questions}</div>
                                    <div class="text-sm text-blue-500">Score: ${latestAttempt.percentage}%</div>
                                    <div class="text-xs text-gray-500 mt-1">Completed on ${latestAttempt.quiz_date}</div>
                                </div>
                                <p class="text-sm text-gray-600">You cannot retake this quiz.</p>
                            </div>
                        `,
                        icon: 'info',
                        confirmButtonText: 'Back to Quizzes',
                        confirmButtonColor: '#6366f1',
                        background: '#ffffff',
                        customClass: {
                            popup: 'rounded-2xl',
                            title: 'text-slate-800',
                            content: 'text-slate-600'
                        },
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = '../quizzes.html';
                        }
                    });
                    
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('Error checking quiz completion:', error);
                return false;
            }
        }

        // Get current user ID
        async function getCurrentUserId() {
            try {
                const response = await fetch('../php/user.php', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.user) {
                        return result.user.id;
                    }
                }
                return null;
            } catch (error) {
                console.error('Error getting user ID:', error);
                return null;
            }
        }

        // Check and award badges for quiz completion
        async function checkAndAwardBadges(result) {
            try {
                console.log('🏆 Checking for badge eligibility...');
                console.log('Quiz result:', result);
                
                // Only check for badges if student scored 60% or higher
                const percentage = Math.round((result.score / result.total_questions) * 100);
                if (percentage < 60) {
                    console.log(`❌ Score too low for badge eligibility: ${percentage}% (minimum: 60%)`);
                    return;
                }
                
                const userId = await getCurrentUserId();
                if (!userId) {
                    console.log('❌ No user ID available for badge checking');
                    return;
                }
                
                console.log('User ID:', userId);
                console.log('Attempt ID:', currentAttemptId);
                console.log(`✅ Score eligible for badges: ${percentage}%`);
                
                const formData = new FormData();
                formData.append('action', 'check_and_award_badges');
                formData.append('student_id', userId);
                formData.append('quiz_type', 'real-life-problems');
                formData.append('score', result.score);
                formData.append('total_questions', result.total_questions);
                formData.append('attempt_id', currentAttemptId);
                
                console.log('Sending badge check request...');
                const response = await fetch('../php/badge-management.php', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                console.log('Badge check response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Badge check result:', data);
                    
                    if (data.success && data.awarded_badges && data.awarded_badges.length > 0) {
                        console.log('✅ Badges awarded:', data.awarded_badges);
                        // Validate badge data before showing notification
                        const validBadges = data.awarded_badges.filter(badge => {
                            const isValid = badge && (badge.name || badge.icon_url || badge.description);
                            if (!isValid) {
                                console.warn('Invalid badge data found:', badge);
                            }
                            return isValid;
                        });
                        
                        if (validBadges.length > 0) {
                            showBadgeNotification(validBadges);
                        } else {
                            console.log('No valid badges to display');
                        }
                    } else {
                        console.log('No badges awarded or empty badge array');
                    }
                } else {
                    console.error('❌ Failed to check badges:', response.status);
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                }
            } catch (error) {
                console.error('❌ Error checking badges:', error);
            }
        }

        // Update results character based on score
        function updateResultsCharacter(percentage) {
            const characterImg = document.querySelector('#resultsCharacter img');
            if (!characterImg) return;
            
            // Remove existing animation classes
            characterImg.classList.remove('sad', 'happy', 'motivate', 'celebrate');
            
            if (percentage < 60) {
                // Low score - show motivate character
                characterImg.src = '../Img/Character/motivate-removebg-preview.png';
                characterImg.alt = 'Motivate Character - Keep Going!';
                characterImg.classList.add('motivate');
                console.log('💪 Showing motivate character for low score:', percentage + '%');
            } else if (percentage >= 80) {
                // High score - show celebrate character
                characterImg.src = '../Img/Character/celebrate-removebg-preview.png';
                characterImg.alt = 'Celebrate Character - Excellent Work!';
                characterImg.classList.add('celebrate');
                console.log('🎉 Showing celebrate character for high score:', percentage + '%');
            } else {
                // Medium score - show happy character
                characterImg.src = '../Img/Character/happy__1_-removebg-preview.png';
                characterImg.alt = 'Happy Character - Good Job!';
                characterImg.classList.add('happy');
                console.log('😊 Showing happy character for medium score:', percentage + '%');
            }
        }

        // Show badge notification
        function showBadgeNotification(badges) {
            if (!badges || badges.length === 0) {
                console.log('No badges to display');
                return;
            }
            
            const badge = badges[0]; // Show the first badge
            
            // Validate badge data and provide fallbacks for null/undefined values
            const badgeIcon = badge.icon_url || '🏆'; // Default trophy emoji if icon_url is null
            const badgeName = badge.name || 'New Badge'; // Default name if null
            const badgeDescription = badge.description || 'Congratulations on earning this badge!'; // Default description if null
            
            console.log('Displaying badge:', {
                icon: badgeIcon,
                name: badgeName,
                description: badgeDescription
            });
            
            Swal.fire({
                title: '🎉 Congratulations!',
                html: `
                    <div class="text-center">
                        <div class="text-6xl mb-4">${badgeIcon}</div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">${badgeName}</h3>
                        <p class="text-gray-600 mb-4">${badgeDescription}</p>
                        <p class="text-sm text-gray-500">You've earned a new badge!</p>
                    </div>
                `,
                icon: 'success',
                confirmButtonText: 'Awesome!',
                confirmButtonColor: '#10b981',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showCloseButton: false,
                customClass: {
                    popup: 'badge-notification'
                }
            });
        }
    </script>
</body>
</html>
