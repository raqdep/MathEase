<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Functions Quiz - MathEase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#667eea',
                        'secondary': '#764ba2',
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .question-card {
            transition: all 0.3s ease;
        }
        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.15);
        }
        .option-selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .option-correct {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #10b981;
        }
        .option-incorrect {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-color: #ef4444;
        }
        .option-review {
            pointer-events: none;
            opacity: 0.8;
        }
        .review-mode .option {
            pointer-events: none;
        }
        .review-mode .option input {
            pointer-events: none;
        }
        .review-mode .option input[type="number"] {
            pointer-events: none;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .question-card {
            animation: slideInUp 0.6s ease-out;
        }
        .option {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .option:hover::before {
            left: 100%;
        }
        .option:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Tips Character Animations */
        .tips-character {
            animation: tipsFloat 3s ease-in-out infinite, tipsWiggle 2s ease-in-out infinite;
            transition: all 0.3s ease;
        }
        
        .tips-character:hover {
            transform: scale(1.1) rotate(5deg);
            animation-play-state: paused;
        }
        
        @keyframes tipsFloat {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
            }
            25% {
                transform: translateY(-8px) rotate(1deg);
            }
            50% {
                transform: translateY(-4px) rotate(0deg);
            }
            75% {
                transform: translateY(-12px) rotate(-1deg);
            }
        }
        
        @keyframes tipsWiggle {
            0%, 100% {
                transform: rotate(0deg);
            }
            25% {
                transform: rotate(2deg);
            }
            75% {
                transform: rotate(-2deg);
            }
        }
        
        /* Floating elements animations */
        .tips-character + div {
            animation-delay: 0.5s;
        }
        
        .tips-character + div + div {
            animation-delay: 1s;
        }
        
        .tips-character + div + div + div {
            animation-delay: 1.5s;
        }
        
        /* Warning Character Animations */
        .warning-character {
            animation: warningShake 0.5s ease-in-out infinite, warningPulse 2s ease-in-out infinite;
            transition: all 0.3s ease;
        }
        
        @keyframes warningShake {
            0%, 100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-3px);
            }
            75% {
                transform: translateX(3px);
            }
        }
        
        @keyframes warningPulse {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 10px 20px rgba(0,0,0,0.15));
            }
            50% {
                transform: scale(1.05);
                filter: drop-shadow(0 15px 30px rgba(239, 68, 68, 0.3));
            }
        }
        
        /* Results Character Animations */
        .results-character {
            animation: resultsFloat 3s ease-in-out infinite;
            transition: all 0.3s ease;
        }
        
        .results-character.sad {
            animation: sadBounce 2s ease-in-out infinite, sadWiggle 1.5s ease-in-out infinite;
        }
        
        .results-character.happy {
            animation: happyBounce 2s ease-in-out infinite, happyWiggle 1.5s ease-in-out infinite;
        }
        
        .results-character.motivate {
            animation: motivatePump 1.5s ease-in-out infinite, motivateShake 2s ease-in-out infinite;
        }
        
        .results-character.celebrate {
            animation: celebrateBounce 1s ease-in-out infinite, celebrateSpin 3s ease-in-out infinite;
        }
        
        @keyframes resultsFloat {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-5px);
            }
        }
        
        @keyframes sadBounce {
            0%, 100% {
                transform: translateY(0px) scale(1);
            }
            25% {
                transform: translateY(-3px) scale(0.98);
            }
            50% {
                transform: translateY(-6px) scale(0.96);
            }
            75% {
                transform: translateY(-3px) scale(0.98);
            }
        }
        
        @keyframes sadWiggle {
            0%, 100% {
                transform: rotate(0deg);
            }
            25% {
                transform: rotate(-1deg);
            }
            75% {
                transform: rotate(1deg);
            }
        }
        
        @keyframes happyBounce {
            0%, 100% {
                transform: translateY(0px) scale(1);
            }
            50% {
                transform: translateY(-8px) scale(1.05);
            }
        }
        
        @keyframes happyWiggle {
            0%, 100% {
                transform: rotate(0deg);
            }
            25% {
                transform: rotate(2deg);
            }
            75% {
                transform: rotate(-2deg);
            }
        }
        
        @keyframes motivatePump {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        @keyframes motivateShake {
            0%, 100% {
                transform: translateX(0px);
            }
            25% {
                transform: translateX(-2px);
            }
            75% {
                transform: translateX(2px);
            }
        }
        
        @keyframes celebrateBounce {
            0%, 100% {
                transform: translateY(0px) scale(1);
            }
            25% {
                transform: translateY(-10px) scale(1.05);
            }
            50% {
                transform: translateY(-15px) scale(1.1);
            }
            75% {
                transform: translateY(-10px) scale(1.05);
            }
        }
        
        @keyframes celebrateSpin {
            0%, 100% {
                transform: rotate(0deg);
            }
            25% {
                transform: rotate(5deg);
            }
            50% {
                transform: rotate(0deg);
            }
            75% {
                transform: rotate(-5deg);
            }
        }
        
        /* Podium Styles */
        .podium-block {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .podium-block:hover {
            transform: translateY(-5px);
        }
        
        .podium-1 {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            width: 120px;
            height: 140px;
            border-radius: 12px 12px 0 0;
            position: relative;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
        
        .podium-2 {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            width: 100px;
            height: 110px;
            border-radius: 12px 12px 0 0;
            position: relative;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }
        
        .podium-3 {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            width: 100px;
            height: 80px;
            border-radius: 12px 12px 0 0;
            position: relative;
            box-shadow: 0 6px 15px rgba(245, 158, 11, 0.3);
        }
        
        .podium-rank {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .podium-rank-1 {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        .podium-rank-2 {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .podium-rank-3 {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .podium-avatar {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 3px solid white;
        }
        
        .podium-crown {
            position: absolute;
            top: -45px;
            right: -5px;
            color: #fbbf24;
            font-size: 16px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .podium-info {
            margin-top: 20px;
            text-align: center;
        }
        
        .podium-name {
            font-weight: bold;
            color: #374151;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .podium-points {
            font-size: 16px;
            font-weight: bold;
            color: #1f2937;
        }
        
        /* Detailed Leaderboard Styles */
        .leaderboard-entry {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        
        .leaderboard-entry:hover {
            background-color: #f9fafb;
        }
        
        .leaderboard-entry:last-child {
            border-bottom: none;
        }
        
        .leaderboard-entry.you {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-radius: 8px;
            margin: 4px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        
        .leaderboard-rank {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
            min-width: 30px;
        }
        
        .leaderboard-entry.you .leaderboard-rank {
            color: white;
        }
        
        .leaderboard-student {
            display: flex;
            align-items: center;
            flex: 1;
            margin-left: 12px;
        }
        
        .leaderboard-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            margin-right: 12px;
        }
        
        .leaderboard-name {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }
        
        .leaderboard-entry.you .leaderboard-name {
            color: white;
        }
        
        
        .leaderboard-points {
            font-weight: bold;
            color: #3b82f6;
            font-size: 16px;
        }
        
        .leaderboard-entry.you .leaderboard-points {
            color: white;
        }
        
        /* Cheating entry styling */
        .leaderboard-entry.cheating-entry {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left: 4px solid #ef4444;
            border-radius: 8px;
            margin: 4px 0;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.1);
        }
        
        .leaderboard-entry.cheating-entry .leaderboard-name {
            color: #dc2626;
            font-weight: 600;
        }
        
        
        .leaderboard-entry.cheating-entry .leaderboard-points {
            color: #dc2626;
            font-weight: bold;
        }
        
        /* Badge notification styles */
        .badge-notification {
            border-radius: 20px !important;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1) !important;
        }
        
        .badge-notification .swal2-html-container {
            margin: 0 !important;
        }
        
        .badge-notification .swal2-title {
            color: #10b981 !important;
            font-size: 2rem !important;
            margin-bottom: 1rem !important;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .podium-block {
                margin: 0 8px;
            }
            
            .podium-1 {
                width: 100px;
                height: 120px;
            }
            
            .podium-2 {
                width: 85px;
                height: 95px;
            }
            
            .podium-3 {
                width: 85px;
                height: 70px;
            }
            
            .podium-avatar {
                width: 40px;
                height: 40px;
                top: -30px;
            }
            
            .podium-rank {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            
            .podium-name {
                font-size: 12px;
            }
            
            .podium-points {
                font-size: 14px;
            }
            
            .leaderboard-entry {
                padding: 10px 12px;
            }
            
            .leaderboard-avatar {
                width: 28px;
                height: 28px;
                font-size: 10px;
                margin-right: 8px;
            }
            
            .leaderboard-name {
                font-size: 13px;
            }
            
            
            .leaderboard-points {
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .podium-block {
                margin: 0 4px;
            }
            
            .podium-1 {
                width: 80px;
                height: 100px;
            }
            
            .podium-2 {
                width: 70px;
                height: 80px;
            }
            
            .podium-3 {
                width: 70px;
                height: 60px;
            }
            
            .podium-avatar {
                width: 35px;
                height: 35px;
                top: -25px;
            }
            
            .podium-rank {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
            
            .podium-name {
                font-size: 11px;
            }
            
            .podium-points {
                font-size: 12px;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="../dashboard.html" class="flex items-center space-x-2">
                        <img src="../css/nav-logo/nav-logo.png" alt="MathEase Logo" class="h-8 w-8">
                        <span class="text-xl font-bold text-primary">MathEase</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-600">
                        <i class="fas fa-user mr-2"></i><span id="userName">Student</span>
                    </span>
                    <a href="../php/logout.php" class="text-gray-700 hover:text-red-600 transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Review Mode Banner -->
    <div id="reviewModeBanner" class="hidden bg-gradient-to-r from-orange-500 to-red-500 text-white py-4">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-center space-x-3">
                <i class="fas fa-eye text-2xl"></i>
                <div class="text-center">
                    <h2 class="text-xl font-bold">Review Mode</h2>
                    <p class="text-sm text-orange-100">Quiz deadline has passed. You can review your answers but cannot submit.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Header -->
    <header class="gradient-bg text-white py-12">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <div class="inline-flex items-center bg-white/20 backdrop-blur-sm rounded-full px-6 py-2 mb-6">
                    <i class="fas fa-question-circle mr-2"></i>
                    <span class="font-semibold">Functions Quiz</span>
                </div>
                <h1 class="text-4xl md:text-5xl font-bold mb-4" id="quizTitle">Test Your Knowledge</h1>
                <p class="text-xl text-white/90 mb-6" id="quizDescription">
                    10 Multiple Choice Questions + 1 Easy Application
                </p>
                <div class="flex justify-center space-x-6 text-sm">
                    <div class="flex items-center">
                        <i class="fas fa-clock mr-2"></i>
                        <span id="timeLimit">20 minutes</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-star mr-2"></i>
                        <span>Easy Level</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-trophy mr-2"></i>
                        <span>15 points total</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar and Timer - Sticky -->
    <div class="bg-white shadow-md border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-6">
                    <div class="flex items-center bg-indigo-50 rounded-lg px-3 py-2">
                        <i class="fas fa-tasks text-indigo-600 mr-2"></i>
                        <span class="text-sm font-medium text-gray-700">Progress:</span>
                        <span class="text-sm font-bold text-indigo-600 ml-2" id="progressText">0/11</span>
                    </div>
                    <div class="flex items-center bg-purple-50 rounded-lg px-3 py-2">
                        <i class="fas fa-clock text-purple-600 mr-2"></i>
                        <span class="text-sm font-medium text-gray-700">Time:</span>
                        <span class="text-lg font-bold text-purple-600 ml-2" id="quizTimer">00:00</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg px-3 py-2 border border-green-200">
                        <i class="fas fa-play-circle text-green-600 mr-2"></i>
                        <span class="text-xs text-gray-600">Started at</span>
                        <span class="text-sm font-semibold text-green-600 ml-1" id="startTime">--:--</span>
                    </div>
                </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 shadow-inner">
                <div class="bg-gradient-to-r from-primary to-secondary h-3 rounded-full progress-bar transition-all duration-300" id="progressBar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Tips Section -->
    <div id="tipsContainer" class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <div class="text-center mb-8 relative">
                <div class="w-32 h-32 mx-auto mb-6 flex items-center justify-center relative">
                    <img src="../Img/Character/tips_approved-removebg-preview.png" 
                         alt="Tips Approved Character" 
                         class="w-full h-full object-contain tips-character"
                         style="filter: drop-shadow(0 15px 30px rgba(0,0,0,0.15));">
                    
                    <!-- Floating elements around the character -->
                    <div class="absolute -top-2 -right-2 w-6 h-6 bg-yellow-400 rounded-full animate-ping"></div>
                    <div class="absolute -bottom-2 -left-2 w-4 h-4 bg-green-400 rounded-full animate-pulse"></div>
                    <div class="absolute top-1/2 -right-4 w-3 h-3 bg-blue-400 rounded-full animate-bounce"></div>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Quiz Tips & Guidelines</h2>
                <p class="text-lg text-gray-600">Read these tips before starting your Functions Quiz</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-clock text-blue-500 mr-3"></i>Time Management
                    </h3>
                    <ul class="space-y-2 text-gray-700">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            <span>Take your time to read each question carefully</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            <span>Don't rush through the problem solving section</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            <span>Review your answers before submitting</span>
                        </li>
                    </ul>
                </div>

                <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-calculator text-green-500 mr-3"></i>Easy Application
                    </h3>
                    <ul class="space-y-2 text-gray-700">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            <span>Show your work step by step</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            <span>Use the vertex formula for maximum/minimum problems</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            <span>Check your calculations carefully</span>
                        </li>
                    </ul>
                </div>

                <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-question-circle text-purple-500 mr-3"></i>Multiple Choice
                    </h3>
                    <ul class="space-y-2 text-gray-700">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            <span>Eliminate obviously wrong answers first</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            <span>Remember function notation f(x)</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            <span>Think about domain and range restrictions</span>
                        </li>
                    </ul>
                </div>

                <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-exclamation-triangle text-yellow-500 mr-3"></i>Important Notes
                    </h3>
                    <ul class="space-y-2 text-gray-700">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            <span>Quiz has 11 total questions (10 MC + 1 PS)</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            <span>MC questions: 1 point each, PS question: 5 points</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            <span>Timer starts when you click "Start Quiz"</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="text-center">
                <button onclick="startQuiz()" class="bg-gradient-to-r from-primary to-secondary text-white px-12 py-4 rounded-xl font-semibold text-lg hover:shadow-lg transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-play mr-3"></i>
                    Start Quiz
                </button>
            </div>
        </div>
    </div>

    <!-- Quiz Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="quizContainer" class="hidden">
            <!-- Question 1 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="1">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 1 of 10</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        What is a function in mathematics?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q1" value="a" class="mr-3">
                            <span>A relationship where each input has exactly one output</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q1" value="b" class="mr-3">
                            <span>A relationship where each input can have multiple outputs</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q1" value="c" class="mr-3">
                            <span>A mathematical equation with variables</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q1" value="d" class="mr-3">
                            <span>A graph that shows relationships</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 2 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="2">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 2 of 10</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        How do you read the function notation f(x) = 2x + 1?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q2" value="a" class="mr-3">
                            <span>f times x equals 2x plus 1</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q2" value="b" class="mr-3">
                            <span>f of x equals 2x plus 1</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q2" value="c" class="mr-3">
                            <span>f divided by x equals 2x plus 1</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q2" value="d" class="mr-3">
                            <span>f plus x equals 2x plus 1</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 3 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="3">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 3 of 10</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        If f(x) = 3x - 2, what is f(4)?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q3" value="a" class="mr-3">
                            <span>10</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q3" value="b" class="mr-3">
                            <span>14</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q3" value="c" class="mr-3">
                            <span>12</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q3" value="d" class="mr-3">
                            <span>8</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 4 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="4">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 4 of 10</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        What is the domain of f(x) = √(x - 3)?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q4" value="a" class="mr-3">
                            <span>All real numbers</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q4" value="b" class="mr-3">
                            <span>x ≥ 3</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q4" value="c" class="mr-3">
                            <span>x ≤ 3</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q4" value="d" class="mr-3">
                            <span>x ≠ 3</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 5 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="5">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 5 of 10</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        What is the range of f(x) = x²?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q5" value="a" class="mr-3">
                            <span>All real numbers</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q5" value="b" class="mr-3">
                            <span>y ≥ 0</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q5" value="c" class="mr-3">
                            <span>y ≤ 0</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q5" value="d" class="mr-3">
                            <span>y > 0</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 6 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 6 of 10</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        If f(x) = 2x + 1 and g(x) = x - 3, what is (f + g)(x)?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q6" value="a" class="mr-3">
                            <span>3x - 2</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q6" value="b" class="mr-3">
                            <span>x + 4</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q6" value="c" class="mr-3">
                            <span>2x² - 5x - 3</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q6" value="d" class="mr-3">
                            <span>3x + 4</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 7 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="7">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 7 of 10</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        If f(x) = 2x and g(x) = x + 3, what is (f · g)(x)?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q7" value="a" class="mr-3">
                            <span>2x + 6</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q7" value="b" class="mr-3">
                            <span>2x² + 6x</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q7" value="c" class="mr-3">
                            <span>3x + 3</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q7" value="d" class="mr-3">
                            <span>2x + 3</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 8 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 8 of 10</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        What is the domain of f(x) = 1/(x - 2)?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q8" value="a" class="mr-3">
                            <span>All real numbers</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q8" value="b" class="mr-3">
                            <span>x ≠ 2</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q8" value="c" class="mr-3">
                            <span>x ≥ 2</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q8" value="d" class="mr-3">
                            <span>x ≤ 2</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 9 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="9">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 9 of 10</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        If f(x) = 2x + 1 and g(x) = x - 3, what is (f ∘ g)(x)?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q9" value="a" class="mr-3">
                            <span>2x - 5</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q9" value="b" class="mr-3">
                            <span>2x - 2</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q9" value="c" class="mr-3">
                            <span>2x + 4</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q9" value="d" class="mr-3">
                            <span>2x - 1</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 10 -->
            <div class="question-card bg-white rounded-2xl shadow-lg p-8 mb-6" data-question="10">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Question 10 of 10</h3>
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">1 point</span>
                </div>
                <div class="mb-6">
                    <p class="text-lg text-gray-700 mb-4">
                        What is the inverse of f(x) = 3x - 2?
                    </p>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q10" value="a" class="mr-3">
                            <span>f⁻¹(x) = (x + 2)/3</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q10" value="b" class="mr-3">
                            <span>f⁻¹(x) = (x - 2)/3</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q10" value="c" class="mr-3">
                            <span>f⁻¹(x) = 3x + 2</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors option">
                            <input type="radio" name="q10" value="d" class="mr-3">
                            <span>f⁻¹(x) = x/3 + 2</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Problem Solving Question -->
            <div class="question-card bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl shadow-lg p-8 mb-6 border-2 border-purple-200" data-question="11">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Easy Application</h3>
                    <span class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-1 rounded-full text-sm font-medium">5 points</span>
                </div>
                <div class="mb-6">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                        <h4 class="font-semibold text-blue-800 mb-2">📚 Real-Life Example:</h4>
                        <p class="text-blue-700 text-sm">
                            Imagine you run a small business selling cupcakes. As you sell more boxes, your profit first increases, then starts to decrease due to rising costs. There is a sweet spot where profit is highest!
                        </p>
                    </div>
                    
                    <p class="text-lg text-gray-700 mb-6">
                        <strong>Your Cupcake Business:</strong> 
                        <br>• You sell cupcakes in boxes of 50
                        <br>• Your profit formula is: <strong>P(x) = -2x² + 80x - 500</strong>
                        <br>• Where x = number of boxes sold (each box = 50 cupcakes)
                        <br>• P(x) = your profit in thousands of pesos
                    </p>
                    
                    <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-6">
                        <h4 class="font-semibold text-green-800 mb-2">💡 What we need to find:</h4>
                        <p class="text-green-700">
                            What is the <strong>maximum profit</strong> (in thousands of pesos)?
                        </p>
                        <p class="text-green-600 text-sm mt-2">
                            <strong>Hint:</strong> This is like finding the highest point on a hill! 🏔️
                        </p>
                    </div>
                    
                    <div class="bg-white rounded-lg p-6 mb-6 border-2 border-purple-200">
                        <h4 class="font-semibold text-gray-800 mb-4">🎯 Your Answer:</h4>
                        <div class="space-y-3">
                            <p class="text-gray-700">What is the maximum profit (in thousands of pesos)?</p>
                            <div class="flex items-center space-x-2">
                                <span class="text-gray-600">Answer:</span>
                                <input type="number" id="ps-answer" placeholder="Enter your answer here" class="w-32 px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none">
                                <span class="text-gray-500 text-sm">thousand pesos</span>
                            </div>
                            <p class="text-xs text-gray-500">💡 Don't worry if you're not sure - just try your best!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center mb-8" id="submitButtonContainer">
                <button onclick="submitQuiz()" class="bg-gradient-to-r from-primary to-secondary text-white px-12 py-4 rounded-2xl font-bold text-lg shadow-2xl hover:shadow-3xl transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-check-circle mr-3"></i>
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Results Container -->
        <div id="resultsContainer" class="hidden">
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
                <div class="text-center mb-8">
                    <div id="resultsCharacter" class="w-24 h-24 mx-auto mb-4 flex items-center justify-center">
                        <img src="../Img/Character/tips_approved-removebg-preview.png" 
                             alt="Results Character" 
                             class="w-full h-full object-contain results-character"
                             style="filter: drop-shadow(0 10px 20px rgba(0,0,0,0.15));">
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Quiz Complete!</h2>
                    <p class="text-lg text-gray-600">Here's how you performed</p>
                </div>

                <!-- Score Summary -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-blue-600 mb-2" id="totalScore">0/11</div>
                        <div class="text-sm text-gray-600">Total Score</div>
                    </div>
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-green-600 mb-2" id="correctAnswers">0</div>
                        <div class="text-sm text-gray-600">Correct Answers</div>
                    </div>
                    <div class="bg-gradient-to-r from-red-50 to-pink-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-red-600 mb-2" id="incorrectAnswers">0</div>
                        <div class="text-sm text-gray-600">Incorrect Answers</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-purple-600 mb-2" id="completionTime">0:00</div>
                        <div class="text-sm text-gray-600">Completion Time</div>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-yellow-600 mb-2" id="studentRank">--</div>
                        <div class="text-sm text-gray-600">Your Rank</div>
                    </div>
                </div>

                <!-- Detailed Performance Analysis -->
                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6 mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">
                        <i class="fas fa-chart-line text-indigo-500 mr-2"></i>Performance Analysis
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">Multiple Choice Questions</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Questions:</span>
                                    <span class="font-semibold">10</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Points per question:</span>
                                    <span class="font-semibold">1 point</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total possible:</span>
                                    <span class="font-semibold">10 points</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">Easy Application</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Questions:</span>
                                    <span class="font-semibold">1</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Points per question:</span>
                                    <span class="font-semibold">5 points</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total possible:</span>
                                    <span class="font-semibold">5 points</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 bg-white rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Overall Grade:</span>
                            <span class="text-2xl font-bold text-indigo-600" id="overallGrade">0%</span>
                        </div>
                        <div class="mt-2">
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-indigo-500 h-3 rounded-full transition-all duration-1000" id="gradeProgress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="showLeaderboard()" class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-8 py-3 rounded-xl font-semibold hover:shadow-lg transition-all duration-300">
                        <i class="fas fa-trophy mr-2"></i>
                        View Leaderboard
                    </button>
                    <button onclick="goToDashboard()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-3 rounded-xl font-semibold hover:shadow-lg transition-all duration-300">
                        <i class="fas fa-home mr-2"></i>
                        Back to Dashboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Leaderboard Container -->
        <div id="leaderboardContainer" class="hidden">
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-gradient-to-r from-yellow-500 to-orange-500 text-white rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-trophy text-3xl"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Class Leaderboard</h2>
                    <p class="text-lg text-gray-600">Top performers in your class ranked by score and speed</p>
                    <p class="text-sm text-gray-500 mt-2">Showing only students from your class and teacher</p>
                </div>

                <!-- Podium Section -->
                <div class="mb-12 mt-8">
                    <div class="flex justify-center items-end space-x-4 mb-8" id="podiumContainer">
                        <!-- Podium will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Leaderboard Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-blue-600 mb-2" id="totalParticipants">0</div>
                        <div class="text-sm text-gray-600">Total Participants</div>
                    </div>
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-green-600 mb-2" id="averageScore">0%</div>
                        <div class="text-sm text-gray-600">Average Score</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-purple-600 mb-2" id="fastestTime">0:00</div>
                        <div class="text-sm text-gray-600">Fastest Time</div>
                    </div>
                </div>

                <!-- Detailed Leaderboard List -->
                <div class="mb-8">
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-t-xl p-4">
                        <div class="flex justify-between items-center text-white">
                            <div class="flex items-center space-x-4">
                                <span class="text-sm font-semibold">Rank</span>
                                <span class="text-sm font-semibold">Students</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-semibold">Points</span>
                                <i class="fas fa-info-circle text-xs"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-b-xl overflow-hidden" id="detailedLeaderboard">
                        <!-- Detailed leaderboard entries will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="hideLeaderboard()" class="bg-gradient-to-r from-primary to-secondary text-white px-8 py-3 rounded-xl font-semibold hover:shadow-lg transition-all duration-300">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Results
                    </button>
                    <button onclick="goToDashboard()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-3 rounded-xl font-semibold hover:shadow-lg transition-all duration-300">
                        <i class="fas fa-home mr-2"></i>
                        Back to Dashboard
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Timer variables
        let quizStartTime;
        let timerInterval;
        let quizDuration = 0; // in seconds
        let currentAttemptId = null;
        let isReviewMode = false;
        let quizDeadline = null;
        let quizStarted = false; // Track if quiz has been started
        
        // Anti-cheating variables
        let isQuizActive = false;
        let focusLostTime = null;
        let tabSwitchCount = 0;
        let maxAllowedTabSwitches = 2; // Maximum allowed tab switches
        let maxAllowedFocusLoss = 30000; // 30 seconds max focus loss
        let heartbeatInterval = null;
        let lastHeartbeat = null;
        let isPageVisible = true;
        let hasLoggedOut = false;
        let hasExitedQuiz = false;

        // Quiz data with correct answers
        const quizData = {
            answers: {
                q1: 'a', // A relationship where each input has exactly one output
                q2: 'b', // f of x equals 2x plus 1
                q3: 'a', // 10 (f(4) = 3(4) - 2 = 12 - 2 = 10)
                q4: 'b', // x ≥ 3
                q5: 'b', // y ≥ 0
                q6: 'a', // 3x - 2 ((2x + 1) + (x - 3) = 3x - 2)
                q7: 'b', // 2x² + 6x ((2x)(x + 3) = 2x² + 6x)
                q8: 'b', // x ≠ 2
                q9: 'a', // 2x - 5 (f(g(x)) = f(x-3) = 2(x-3) + 1 = 2x - 6 + 1 = 2x - 5)
                q10: 'a' // f⁻¹(x) = (x + 2)/3
            },
            problemSolving: {
                answer: 300 // Maximum profit: P(20) = -2(20)² + 80(20) - 500 = -800 + 1600 - 500 = 300
            }
        };


        // Update progress with animations
        function updateProgress() {
            const totalQuestions = 11; // 10 multiple choice + 1 problem solving question
            let answered = 0;
            
            // Count answered multiple choice questions
            for (let i = 1; i <= 10; i++) {
                if (document.querySelector(`input[name="q${i}"]:checked`)) {
                    answered++;
                }
            }
            
            // Count answered problem solving question
            const psAnswerElement = document.getElementById('ps-answer');
            if (psAnswerElement && psAnswerElement.value.trim() !== '') {
                answered++;
            }
            
            const progress = (answered / totalQuestions) * 100;
            const progressBar = document.getElementById('progressBar');
            
            // Animate progress bar
            if (progressBar) {
                progressBar.style.transition = 'width 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
                progressBar.style.width = progress + '%';
            }
            
            const progressText = document.getElementById('progressText');
            if (progressText) {
                progressText.textContent = `${answered}/${totalQuestions}`;
            }
            
            console.log(`Progress: ${answered}/${totalQuestions} (${Math.round(progress)}%)`);
            
            // All questions answered
            if (answered === totalQuestions) {
                // Quiz is complete
                console.log('✅ All questions answered');
            }
        }

        // Start quiz function
        async function startQuiz() {
            try {
                // Set quiz started flag
                quizStarted = true;
                isQuizActive = true;
                
                // Hide tips container
                const tipsContainer = document.getElementById('tipsContainer');
                if (tipsContainer) {
                    tipsContainer.classList.add('hidden');
                }
                
                // Show quiz container
                const quizContainer = document.getElementById('quizContainer');
                if (quizContainer) {
                    quizContainer.classList.remove('hidden');
                }
                
                // Initialize quiz FIRST (this creates the attempt in database)
                await initializeQuiz();
                
                // Only start timer and anti-cheating if quiz was successfully initialized
                if (currentAttemptId) {
                    // Start the timer
                    startTimer();
                    
                    // Initialize anti-cheating system
                    initializeAntiCheating();
                    
                    // Start periodic warning reminders
                    showPeriodicWarning();
                } else {
                    throw new Error('Failed to initialize quiz - no attempt ID');
                }
            } catch (error) {
                console.error('Error starting quiz:', error);
                Swal.fire({
                    title: 'Quiz Start Error',
                    text: 'Unable to start the quiz. Please refresh the page and try again.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#6366f1'
                });
                
                // Reset quiz state
                quizStarted = false;
                isQuizActive = false;
                document.getElementById('tipsContainer')?.classList.remove('hidden');
                document.getElementById('quizContainer')?.classList.add('hidden');
            }
        }

        // Initialize quiz functionality
        async function initializeQuiz() {
            // Check if there's an existing attempt in database
            const existingAttempt = await checkExistingQuizAttempt();
            
            if (existingAttempt) {
                // Set current attempt ID for existing attempt
                currentAttemptId = existingAttempt.attempt_id;
                console.log('✅ Resuming existing quiz with attempt ID:', currentAttemptId);
                
                // Load saved answers
                await loadSavedAnswers();
                
                // Resume timer from saved time
                if (existingAttempt.completion_time > 0) {
                    quizDuration = existingAttempt.completion_time;
                    updateTimerDisplay();
                }
                
                // Show quiz container if quiz was started
                const tipsContainer = document.getElementById('tipsContainer');
                const quizContainer = document.getElementById('quizContainer');
                if (tipsContainer) tipsContainer.classList.add('hidden');
                if (quizContainer) quizContainer.classList.remove('hidden');
                
                // Note: Timer will be started by startQuiz() function, not here
            } else {
                // Start new quiz in database
                await startQuizInDatabase();
            }
            
            // Ensure we have a currentAttemptId - if not, try to start quiz
            if (!currentAttemptId) {
                console.log('⚠️ No attempt ID found - attempting to start new quiz...');
                await startQuizInDatabase();
            }
            
            // Final check - if still no attempt ID, throw error
            if (!currentAttemptId) {
                throw new Error('Failed to create quiz attempt in database');
            }
            
            // Check if quiz is already completed
            const completionCheck = await checkQuizCompletion();
            if (completionCheck) {
                isQuizActive = false;
                return; // Stop execution if quiz is completed
            }
            
            // Add event listeners for progress tracking
            addEventListeners();
            
            // Initialize progress
            updateProgress();
        }

        // Start timer
        function startTimer() {
            // Prevent starting timer if quiz is not active or already completed
            if (!isQuizActive) {
                console.log('⚠️ Cannot start timer - quiz is not active');
                return;
            }
            
            // Clear any existing timer first
            if (timerInterval) {
                clearInterval(timerInterval);
                console.log('🔄 Clearing existing timer before starting new one');
            }
            
            quizStartTime = new Date();
            const startTimeString = quizStartTime.toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('startTime').textContent = startTimeString;
            
            timerInterval = setInterval(updateTimer, 1000);
            console.log('✅ Timer started');
        }

        // Update timer display
        function updateTimer() {
            // Stop timer if quiz is not active
            if (!isQuizActive) {
                console.log('🛑 Timer stopped - quiz is not active');
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                return;
            }
            
            const now = new Date();
            const elapsed = Math.floor((now - quizStartTime) / 1000);
            quizDuration = elapsed;
            
            updateTimerDisplay();
        }

        // Update timer display from saved time
        function updateTimerDisplay() {
            const minutes = Math.floor(quizDuration / 60);
            const seconds = quizDuration % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const timerElement = document.getElementById('quizTimer');
            if (timerElement) {
                timerElement.textContent = timeString;
            }
        }

        // Save quiz state to localStorage - DISABLED
        function saveQuizStateToLocalStorage() {
            // localStorage save functionality has been disabled
            // All quiz state is now managed through the database only
            console.log('localStorage save disabled - using database only');
        }

        // Restore quiz state from localStorage - DISABLED
        function restoreQuizStateFromLocalStorage() {
            // localStorage restore functionality has been disabled
            // All quiz state is now managed through the database only
            console.log('localStorage restore disabled - using database only');
            return false;
        }

        // Clear quiz state from localStorage - DISABLED
        function clearQuizStateFromLocalStorage() {
            // localStorage clear functionality has been disabled
            console.log('localStorage clear disabled - no action needed');
        }

        // Auto-save answers
        async function autoSaveAnswers() {
            // Save to database only (localStorage disabled)
            if (!currentAttemptId) {
                console.log('No attempt ID - skipping auto-save to database');
                return;
            }
            
            try {
                const answers = {};
                
                // Collect multiple choice answers
                for (let i = 1; i <= 10; i++) {
                    const selected = document.querySelector(`input[name="q${i}"]:checked`);
                    if (selected) {
                        answers[`q${i}`] = selected.value;
                    }
                }
                
                // Collect problem solving answer
                const psInput = document.getElementById('ps-answer');
                if (psInput) {
                    answers['ps-answer'] = psInput.value.trim();
                }
                
                const formData = new FormData();
                formData.append('action', 'save_quiz_progress');
                formData.append('attempt_id', currentAttemptId);
                formData.append('completion_time', quizDuration);
                
                // Add answers to form data
                for (const [key, value] of Object.entries(answers)) {
                    formData.append(`answers[${key}]`, value);
                }
                
                const response = await fetch('../php/quiz-management.php', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('✅ Answers auto-saved successfully');
                } else {
                    console.warn('⚠️ Auto-save failed:', result.message);
                }
            } catch (error) {
                console.error('❌ Error auto-saving answers:', error);
                // Don't show error to user for auto-save failures
            }
        }

        // Stop timer
        function stopTimer() {
            console.log('🛑 Stopping timer...');
            console.log('Current timerInterval:', timerInterval);
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null; // Set to null to prevent restart
                console.log('✅ Timer interval cleared');
            } else {
                console.log('⚠️ No timer interval to clear');
            }
            
            // Update timer display to show it's stopped
            const timerElement = document.getElementById('quizTimer');
            if (timerElement) {
                timerElement.textContent = 'STOPPED';
                timerElement.classList.add('text-red-500');
                console.log('✅ Timer display updated to STOPPED');
            }
            
            // Stop anti-cheating monitoring
            stopAntiCheating();
            
            // Ensure quiz is marked as inactive
            isQuizActive = false;
            console.log('✅ Quiz marked as inactive');
        }

        // Get formatted time
        function getFormattedTime() {
            const minutes = Math.floor(quizDuration / 60);
            const seconds = quizDuration % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Check for existing quiz attempt
        async function checkExistingQuizAttempt() {
            try {
                const response = await fetch('../php/quiz-management.php?action=check_existing_attempt&quiz_type=functions', {
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success && result.attempt) {
                    return result.attempt;
                }
                return null;
            } catch (error) {
                console.error('Error checking existing attempt:', error);
                return null;
            }
        }

        // Load saved answers
        async function loadSavedAnswers() {
            try {
                const response = await fetch(`../php/quiz-management.php?action=get_quiz_answers&attempt_id=${currentAttemptId}`, {
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success && result.answers) {
                    // Restore multiple choice answers
                    for (let i = 1; i <= 10; i++) {
                        const answer = result.answers[`q${i}`];
                        if (answer) {
                            const input = document.querySelector(`input[name="q${i}"][value="${answer}"]`);
                            if (input) {
                                input.checked = true;
                            }
                        }
                    }
                    
                    // Restore problem solving answer
                    if (result.answers['ps-answer']) {
                        document.getElementById('ps-answer').value = result.answers['ps-answer'];
                    }
                    
                    console.log('Saved answers loaded successfully');
                }
            } catch (error) {
                console.error('Error loading saved answers:', error);
            }
        }

        // Start quiz in database
        async function startQuizInDatabase() {
            try {
                console.log('Starting quiz in database...');
                const formData = new FormData();
                formData.append('action', 'start_quiz');
                formData.append('quiz_type', 'functions');
                
                const response = await fetch('../php/quiz-management.php', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                console.log('Start quiz response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Start quiz result:', result);
                
                if (result.success) {
                    currentAttemptId = result.attempt_id;
                    console.log('✅ Quiz started successfully with attempt ID:', currentAttemptId);
                } else {
                    console.error('❌ Failed to start quiz:', result.message);
                    if (result.message.includes('already exists')) {
                        // Show message that quiz is already in progress
                        Swal.fire({
                            title: 'Quiz Already in Progress',
                            text: 'You already have a quiz attempt in progress. Please complete it first.',
                            icon: 'warning',
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#6366f1'
                        });
                    } else {
                        // Show generic error
                        Swal.fire({
                            title: 'Quiz Start Error',
                            text: 'Unable to start the quiz. Please refresh the page and try again.',
                            icon: 'error',
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#6366f1'
                        });
                    }
                }
            } catch (error) {
                console.error('❌ Error starting quiz:', error);
                Swal.fire({
                    title: 'Connection Error',
                    text: 'Unable to connect to the server. Please check your internet connection and try again.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#6366f1'
                });
            }
        }

        // Submit quiz to database
        async function submitQuizToDatabase(answers, completionTime) {
            try {
                console.log('Submitting quiz to database...');
                console.log('Attempt ID:', currentAttemptId);
                console.log('Completion Time:', completionTime);
                console.log('Answers:', answers);
                
                const formData = new FormData();
                formData.append('action', 'submit_quiz');
                formData.append('attempt_id', currentAttemptId);
                formData.append('completion_time', completionTime);
                
                // Add answers to form data
                for (const [key, value] of Object.entries(answers)) {
                    formData.append(`answers[${key}]`, value);
                }
                
                console.log('Sending request to quiz-management.php...');
                const response = await fetch('../php/quiz-management.php', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Database response:', result);
                
                if (result.success) {
                    console.log('✅ Quiz submitted successfully to database:', result);
                    console.log('Score:', result.score, 'Total Questions:', result.total_questions);
                    return result;
                } else {
                    console.error('❌ Failed to submit quiz to database:', result.message);
                    // Show error to user
                    Swal.fire({
                        title: 'Submission Error',
                        text: 'Failed to save your quiz to the database. Please try again.',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6366f1'
                    });
                    return null;
                }
            } catch (error) {
                console.error('❌ Error submitting quiz to database:', error);
                // Show error to user
                Swal.fire({
                    title: 'Connection Error',
                    text: 'Unable to connect to the server. Please check your internet connection and try again.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#6366f1'
                });
                return null;
            }
        }

        // Get leaderboard from database (same class/teacher only)
        async function getLeaderboardFromDatabase() {
            try {
                console.log('Fetching leaderboard from database (same class only)...');
                const response = await fetch('../php/quiz-management.php?action=get_leaderboard&quiz_type=functions&limit=20&same_class_only=true', {
                    credentials: 'include'
                });
                
                console.log('Leaderboard response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Leaderboard result:', result);
                
                if (result.success) {
                    console.log('Leaderboard data received:', result.leaderboard.length, 'records');
                    console.log('Students in same class:', result.leaderboard.map(s => s.student_name + ' (Class: ' + s.class_name + ')'));
                    return result.leaderboard;
                } else {
                    console.error('Failed to get leaderboard:', result.message);
                    // Show user-friendly error message
                    Swal.fire({
                        title: 'Leaderboard Error',
                        text: 'Unable to load leaderboard data. Please try again later.',
                        icon: 'warning',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6366f1'
                    });
                    return [];
                }
            } catch (error) {
                console.error('Error getting leaderboard:', error);
                // Show user-friendly error message
                Swal.fire({
                    title: 'Connection Error',
                    text: 'Unable to connect to the server. Please check your internet connection and try again.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#6366f1'
                });
                return [];
            }
        }

        // Get quiz statistics from database (same class only)
        async function getQuizStatisticsFromDatabase() {
            try {
                const response = await fetch('../php/quiz-management.php?action=get_statistics&quiz_type=functions&same_class_only=true', {
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    return result.statistics;
                } else {
                    console.error('Failed to get statistics:', result.message);
                    return null;
                }
            } catch (error) {
                console.error('Error getting statistics:', error);
                return null;
            }
        }

        // Add event listeners for progress tracking
        function addEventListeners() {
            // Multiple choice questions without answer feedback
            for (let i = 1; i <= 10; i++) {
                const inputs = document.querySelectorAll(`input[name="q${i}"]`);
                inputs.forEach(input => {
                    input.addEventListener('change', (e) => {
                        // Add visual feedback for selection only
                        const label = e.target.closest('label');
                        
                        // Remove option-selected class from all labels for this question
                        const allLabels = document.querySelectorAll(`input[name="q${i}"]`);
                        allLabels.forEach(inp => {
                            inp.closest('label').classList.remove('option-selected');
                        });
                        
                        // Add option-selected class to the selected label
                        label.classList.add('option-selected');
                        
                        updateProgress();
                        // Auto-save after a short delay
                        setTimeout(autoSaveAnswers, 1000);
                    });
                });
            }
            
            // Problem solving inputs
            const psAnswerInput = document.getElementById('ps-answer');
            if (psAnswerInput) {
                psAnswerInput.addEventListener('input', () => {
                    updateProgress();
                    // Auto-save after a short delay
                    setTimeout(autoSaveAnswers, 1000);
                });
            } else {
                console.error('Problem solving answer input not found');
            }
        }

        // Submit quiz with confirmation
        async function submitQuiz() {
            // Prevent submission in review mode
            if (isReviewMode) {
                Swal.fire({
                    title: 'Review Mode',
                    text: 'You cannot submit the quiz in review mode. The deadline has passed.',
                    icon: 'info',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#6366f1'
                });
                return;
            }
            
            // Check if quiz attempt ID exists
            if (!currentAttemptId) {
                console.error('❌ No quiz attempt ID found - trying to get current attempt...');
                
                // Try to get the current attempt ID
                try {
                    const response = await fetch('../php/quiz-management.php?action=check_existing_attempt&quiz_type=functions', {
                        credentials: 'include'
                    });
                    const result = await response.json();
                    
                    if (result.success && result.attempt) {
                        currentAttemptId = result.attempt.attempt_id;
                        console.log('✅ Retrieved current attempt ID:', currentAttemptId);
                    } else {
                        console.error('❌ No current attempt found - trying to start new quiz...');
                        
                        // Try to start a new quiz attempt
                        try {
                            await startQuizInDatabase();
                            if (currentAttemptId) {
                                console.log('✅ Started new quiz attempt:', currentAttemptId);
                                // Continue with submission
                            } else {
                                throw new Error('Failed to start new quiz');
                            }
                        } catch (error) {
                            console.error('❌ Failed to start new quiz:', error);
                            Swal.fire({
                                title: 'Quiz Error',
                                text: 'Unable to start quiz session. Please refresh the page and try again.',
                                icon: 'error',
                                confirmButtonText: 'OK',
                                confirmButtonColor: '#6366f1'
                            });
                            return;
                        }
                    }
                } catch (error) {
                    console.error('❌ Error getting current attempt:', error);
                    Swal.fire({
                        title: 'Quiz Error',
                        text: 'Unable to verify quiz session. Please refresh the page and try again.',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6366f1'
                    });
                    return;
                }
            }
            
            // Check if all questions are answered
            const totalQuestions = 11; // 10 multiple choice + 1 problem solving question
            let answered = 0;
            
            for (let i = 1; i <= 10; i++) {
                if (document.querySelector(`input[name="q${i}"]:checked`)) {
                    answered++;
                }
            }
            
            const psAnswer = document.getElementById('ps-answer').value.trim();
            
            if (psAnswer) answered++;
            
            // Show confirmation dialog
            const result = await Swal.fire({
                title: 'Submit Quiz?',
                html: `
                    <div class="text-center">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-paper-plane text-blue-500 text-2xl"></i>
                        </div>
                        <p class="text-lg text-gray-700 mb-4">Are you ready to submit your quiz?</p>
                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <div class="text-2xl font-bold text-blue-600">${answered}/${totalQuestions}</div>
                            <div class="text-sm text-gray-500">Questions Answered</div>
                        </div>
                        <p class="text-sm text-gray-600">You cannot change your answers after submission.</p>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Yes, Submit Quiz',
                cancelButtonText: 'Continue Quiz',
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280',
                background: '#ffffff',
                customClass: {
                    popup: 'rounded-2xl',
                    title: 'text-slate-800',
                    content: 'text-slate-600'
                }
            });
            
            if (!result.isConfirmed) {
                return; // User cancelled submission
            }
            
            // Stop the timer
            stopTimer();
            
            // Show loading
            Swal.fire({
                title: 'Submitting Quiz...',
                text: 'Please wait while we process your answers',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                background: '#ffffff',
                customClass: {
                    popup: 'rounded-2xl',
                    title: 'text-slate-800',
                    content: 'text-slate-600'
                },
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Collect answers
            const answers = {};
            
            // Collect multiple choice answers
            for (let i = 1; i <= 10; i++) {
                const selected = document.querySelector(`input[name="q${i}"]:checked`);
                if (selected) {
                    answers[`q${i}`] = selected.value;
                } else {
                    answers[`q${i}`] = ''; // Empty string for unanswered questions
                }
            }
            
            // Collect problem solving answer
            const psInput = document.getElementById('ps-answer');
            if (psInput) {
                answers['ps-answer'] = psInput.value.trim();
            } else {
                answers['ps-answer'] = '';
            }
            
            console.log('Collected answers for submission:', answers);
            
            // Submit to database
            const dbResult = await submitQuizToDatabase(answers, quizDuration);
            
            // Close loading dialog
            Swal.close();
            
            if (dbResult && dbResult.success) {
                // Use database results
                console.log('✅ Using database results for display');
                showResults(dbResult);
            } else {
                // Database submission failed - show error and don't proceed
                console.error('❌ Database submission failed, cannot proceed');
                Swal.fire({
                    title: 'Quiz Not Saved',
                    text: 'Your quiz could not be saved to the database. Please contact your teacher or try again later.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#6366f1'
                });
                return; // Don't show results if database save failed
            }
        }
        
        // Calculate results locally (fallback)
        function calculateLocalResults(answers) {
            let score = 0;
            let correct = 0;
            let incorrect = 0;

            // Check multiple choice questions (10 questions, 1 point each)
            for (let i = 1; i <= 10; i++) {
                const selected = answers[`q${i}`];
                const correctAnswer = quizData.answers[`q${i}`];
                
                if (selected) {
                    if (selected === correctAnswer) {
                        score += 1;
                        correct++;
                    } else {
                        incorrect++;
                    }
                } else {
                    // No answer selected counts as incorrect
                    incorrect++;
                }
            }

            // Check problem solving (1 question, 5 points)
            const psAnswer = parseInt(answers['ps-answer']) || 0;
            
            let psScore = 0;
            let psCorrect = 0;
            let psIncorrect = 0;
            
            // Problem solving question (5 points) - allow tolerance of ±50
            if (answers['ps-answer'] && answers['ps-answer'].trim() !== '') {
                if (Math.abs(psAnswer - quizData.problemSolving.answer) <= 50) {
                    psScore += 5;
                    psCorrect++;
                } else {
                    psIncorrect++;
                }
            } else {
                // No answer provided
                psIncorrect++;
            }
            
            score += psScore;
            
            // Add problem solving correct/incorrect to totals
            correct += psCorrect;
            incorrect += psIncorrect;

            return {
                score: score,
                correct_answers: correct,
                incorrect_answers: incorrect,
                total_questions: 11 // 10 multiple choice + 1 problem solving question
            };
        }
        
        // Show results
        async function showResults(result) {
            try {
                // Stop the timer when showing results
                stopTimer();
                
                // Show results
                const quizContainer = document.getElementById('quizContainer');
                const resultsContainer = document.getElementById('resultsContainer');
                
                if (quizContainer) quizContainer.classList.add('hidden');
                if (resultsContainer) resultsContainer.classList.remove('hidden');
                
                const totalQuestions = result.total_questions || 11; // Default to 11 if not provided
                const percentage = Math.round((result.score / totalQuestions) * 100);
                
                // Update score displays
                const totalScoreEl = document.getElementById('totalScore');
                const correctAnswersEl = document.getElementById('correctAnswers');
                const incorrectAnswersEl = document.getElementById('incorrectAnswers');
                const completionTimeEl = document.getElementById('completionTime');
                
                if (totalScoreEl) totalScoreEl.textContent = `${result.score}/${totalQuestions}`;
                if (correctAnswersEl) correctAnswersEl.textContent = result.correct_answers;
                if (incorrectAnswersEl) incorrectAnswersEl.textContent = result.incorrect_answers;
                if (completionTimeEl) completionTimeEl.textContent = getFormattedTime();
                
                // Update overall grade
                const overallGradeEl = document.getElementById('overallGrade');
                const gradeProgressEl = document.getElementById('gradeProgress');
                
                if (overallGradeEl) overallGradeEl.textContent = `${percentage}%`;
                if (gradeProgressEl) {
                    gradeProgressEl.style.width = `${percentage}%`;
                    
                    // Change progress bar color based on grade
                    if (percentage >= 80) {
                        gradeProgressEl.className = 'bg-green-500 h-3 rounded-full transition-all duration-1000';
                    } else if (percentage >= 60) {
                        gradeProgressEl.className = 'bg-yellow-500 h-3 rounded-full transition-all duration-1000';
                    } else {
                        gradeProgressEl.className = 'bg-red-500 h-3 rounded-full transition-all duration-1000';
                    }
                }
                
                // Update character based on score
                updateResultsCharacter(percentage);

                // Get and display student's rank
                await displayStudentRank();

                // Check and award badges for any completed quiz (backend decides which badges apply)
                if (!isReviewMode) {
                    await checkAndAwardBadges(result);
                } else {
                    console.log('Skipping badge check - quiz in review mode');
                }

                // Scroll to results
                if (resultsContainer) {
                    resultsContainer.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error('Error showing results:', error);
                Swal.fire({
                    title: 'Results Error',
                    text: 'Unable to display quiz results. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#6366f1'
                });
            }
        }

        // Check and award badges for quiz completion
        async function checkAndAwardBadges(result) {
            try {
                console.log('🏆 Checking for badge eligibility...');
                console.log('Quiz result:', result);
                // Always check with backend; it will decide which badges qualify (e.g., completion, 50%+, perfect)
                const userId = await getCurrentUserId();
                if (!userId) {
                    console.log('❌ No user ID available for badge checking');
                    return;
                }
                
                console.log('User ID:', userId);
                console.log('Attempt ID:', currentAttemptId);
                console.log('Submitting result to backend for badge evaluation');
                
                const formData = new FormData();
                formData.append('action', 'check_and_award_badges');
                formData.append('student_id', userId);
                formData.append('quiz_type', 'functions');
                formData.append('score', result.score);
                formData.append('total_questions', result.total_questions);
                formData.append('attempt_id', currentAttemptId);
                
                console.log('Sending badge check request...');
                const response = await fetch('../php/badge-management.php', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                console.log('Badge check response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Badge check result:', data);
                    
                    if (data.success && data.awarded_badges && data.awarded_badges.length > 0) {
                        console.log('✅ Badges awarded:', data.awarded_badges);
                        // Validate badge data before showing notification
                        const validBadges = data.awarded_badges.filter(badge => {
                            const isValid = badge && (badge.name || badge.icon_url || badge.description);
                            if (!isValid) {
                                console.warn('Invalid badge data found:', badge);
                            }
                            return isValid;
                        });
                        
                        if (validBadges.length > 0) {
                            showBadgeNotification(validBadges);
                        } else {
                            console.log('No valid badges to display');
                        }
                    } else {
                        console.log('No badges awarded or empty badge array');
                    }
                } else {
                    console.error('❌ Failed to check badges:', response.status);
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                }
            } catch (error) {
                console.error('❌ Error checking badges:', error);
            }
        }

        // Show badge notification
        function showBadgeNotification(badges) {
            if (!badges || badges.length === 0) {
                console.log('No badges to display');
                return;
            }
            
            const badge = badges[0]; // Show the first badge
            
            // Validate badge data and provide fallbacks for null/undefined values
            const badgeIcon = badge.icon_url || '🏆'; // Default trophy emoji if icon_url is null
            const badgeName = badge.name || 'New Badge'; // Default name if null
            const badgeDescription = badge.description || 'Congratulations on earning this badge!'; // Default description if null
            
            console.log('Displaying badge:', {
                icon: badgeIcon,
                name: badgeName,
                description: badgeDescription
            });
            
            Swal.fire({
                title: '🎉 Congratulations!',
                html: `
                    <div class="text-center">
                        <div class="text-6xl mb-4">${badgeIcon}</div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">${badgeName}</h3>
                        <p class="text-gray-600 mb-4">${badgeDescription}</p>
                        <p class="text-sm text-gray-500">You've earned a new badge!</p>
                    </div>
                `,
                icon: 'success',
                confirmButtonText: 'Awesome!',
                confirmButtonColor: '#10b981',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showCloseButton: false,
                customClass: {
                    popup: 'badge-notification'
                }
            });
        }

        // Get current user ID from server
        async function getCurrentUserId() {
            try {
                const response = await fetch('../php/user.php', {
                    credentials: 'include',
                    cache: 'no-store'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.user) {
                        return data.user.id;
                    }
                }
                return null;
            } catch (error) {
                console.error('Error getting user ID:', error);
                return null;
            }
        }

        // Display student's rank in the leaderboard
        async function displayStudentRank() {
            try {
                console.log('Fetching student rank...');
                const response = await fetch('../php/quiz-management.php?action=get_leaderboard&quiz_type=functions&limit=50&same_class_only=true', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.leaderboard) {
                    // Find the current student in the leaderboard
                    const currentStudent = result.leaderboard.find(student => student.is_current_user == 1 || student.is_current_user === true);
                    
                    if (currentStudent) {
                        const rankElement = document.getElementById('studentRank');
                        const rank = currentStudent.rank_position;
                        
                        // Add rank icon based on position
                        let rankDisplay = '';
                        if (rank === 1) {
                            rankDisplay = '🥇 1st';
                        } else if (rank === 2) {
                            rankDisplay = '🥈 2nd';
                        } else if (rank === 3) {
                            rankDisplay = '🥉 3rd';
                        } else {
                            rankDisplay = `#${rank}`;
                        }
                        
                        rankElement.textContent = rankDisplay;
                        console.log(`Student rank: ${rank}`);
                    } else {
                        // Student not found in leaderboard (shouldn't happen)
                        document.getElementById('studentRank').textContent = 'N/A';
                        console.log('Student not found in leaderboard');
                    }
                } else {
                    document.getElementById('studentRank').textContent = 'N/A';
                    console.error('Failed to get leaderboard for rank:', result.message);
                }
            } catch (error) {
                console.error('Error getting student rank:', error);
                document.getElementById('studentRank').textContent = 'N/A';
            }
        }

        // Show leaderboard
        function showLeaderboard() {
            document.getElementById('resultsContainer').classList.add('hidden');
            document.getElementById('leaderboardContainer').classList.remove('hidden');
            loadLeaderboard();
            
            // Scroll to leaderboard
            document.getElementById('leaderboardContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // Hide leaderboard
        function hideLeaderboard() {
            document.getElementById('leaderboardContainer').classList.add('hidden');
            document.getElementById('resultsContainer').classList.remove('hidden');
        }

        // Load leaderboard data
        async function loadLeaderboard() {
            const podiumContainer = document.getElementById('podiumContainer');
            const detailedLeaderboard = document.getElementById('detailedLeaderboard');
            
            try {
                console.log('Loading leaderboard...');
                
                // Show loading state
                podiumContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl mb-4 text-blue-500"></i>
                        <p class="text-lg text-gray-500">Loading leaderboard...</p>
                    </div>
                `;
                
                detailedLeaderboard.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2 text-blue-500"></i>
                        <p class="text-sm text-gray-500">Loading details...</p>
                    </div>
                `;
                
                // Get leaderboard from database
                const leaderboardData = await getLeaderboardFromDatabase();
                console.log('Leaderboard data:', leaderboardData);
                
                const statistics = await getQuizStatisticsFromDatabase();
                console.log('Statistics:', statistics);
                
                if (leaderboardData.length === 0) {
                    // Show empty state
                    document.getElementById('totalParticipants').textContent = '0';
                    document.getElementById('averageScore').textContent = '0%';
                    document.getElementById('fastestTime').textContent = '0:00';
                    
                    podiumContainer.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-trophy text-4xl mb-4 text-gray-300"></i>
                            <p class="text-lg text-gray-500">No quiz attempts yet</p>
                            <p class="text-sm text-gray-400">Be the first to take the quiz!</p>
                        </div>
                    `;
                    
                    detailedLeaderboard.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-trophy text-2xl mb-2 text-gray-300"></i>
                            <p class="text-sm text-gray-500">No participants yet</p>
                        </div>
                    `;
                    return;
                }

                // Update stats
                if (statistics && statistics.total_attempts > 0) {
                    document.getElementById('totalParticipants').textContent = statistics.total_attempts;
                    document.getElementById('averageScore').textContent = Math.round(statistics.average_percentage) + '%';
                    document.getElementById('fastestTime').textContent = formatTime(statistics.fastest_time);
                } else {
                    // Calculate from leaderboard data
                    const totalParticipants = leaderboardData.length;
                    const averageScore = totalParticipants > 0 ? Math.round(leaderboardData.reduce((sum, student) => {
                        return sum + parseFloat(student.percentage);
                    }, 0) / totalParticipants) : 0;
                    
                    const fastestTime = totalParticipants > 0 ? leaderboardData.reduce((fastest, student) => {
                        const studentTime = parseFloat(student.formatted_time.replace(':', '.'));
                        const fastestTime = parseFloat(fastest.replace(':', '.'));
                        return studentTime < fastestTime ? student.formatted_time : fastest;
                    }, leaderboardData[0].formatted_time) : '0:00';

                    document.getElementById('totalParticipants').textContent = totalParticipants;
                    document.getElementById('averageScore').textContent = averageScore + '%';
                    document.getElementById('fastestTime').textContent = fastestTime;
                }

                // Create podium for top 3
                createPodium(leaderboardData.slice(0, 3));
                
                // Create detailed leaderboard list
                createDetailedLeaderboard(leaderboardData);
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                // Show error state
                podiumContainer.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p class="text-lg">Error loading leaderboard</p>
                        <p class="text-sm">Please try again later</p>
                    </div>
                `;
                
                detailedLeaderboard.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p class="text-sm">Error loading details</p>
                    </div>
                `;
            }
        }
        
        // Create podium for top 3 students
        function createPodium(topThree) {
            const podiumContainer = document.getElementById('podiumContainer');
            
            if (topThree.length === 0) {
                podiumContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-trophy text-4xl mb-4 text-gray-300"></i>
                        <p class="text-lg">No participants yet</p>
                    </div>
                `;
                return;
            }
            
            // Ensure we have at least 3 positions, fill with empty if needed
            const podiumData = [
                topThree[0] || null,
                topThree[1] || null,
                topThree[2] || null
            ];
            
            podiumContainer.innerHTML = '';
            
            // Create podium blocks (2nd, 1st, 3rd order for visual effect)
            const podiumOrder = [1, 0, 2]; // 2nd place, 1st place, 3rd place
            
            podiumOrder.forEach((index, position) => {
                const student = podiumData[index];
                const podiumBlock = document.createElement('div');
                podiumBlock.className = 'podium-block';
                
                if (student) {
                    const initials = student.student_name.split(' ').map(n => n[0]).join('').toUpperCase();
                    const rank = student.rank_position;
                    
                    podiumBlock.innerHTML = `
                        <div class="podium-${rank}">
                            <div class="podium-rank podium-rank-${rank}">${rank}</div>
                            <div class="podium-avatar">
                                <span class="text-sm font-bold text-gray-600">${initials}</span>
                            </div>
                            ${rank === 1 ? '<div class="podium-crown">👑</div>' : ''}
                        </div>
                        <div class="podium-info">
                            <div class="podium-name">${student.student_name}</div>
                            <div class="podium-points">${student.score}/${student.total_questions}</div>
                        </div>
                    `;
                } else {
                    // Empty podium position
                    podiumBlock.innerHTML = `
                        <div class="podium-${index + 1} opacity-30">
                            <div class="podium-rank podium-rank-${index + 1}">${index + 1}</div>
                            <div class="podium-avatar">
                                <i class="fas fa-user text-gray-400"></i>
                            </div>
                        </div>
                        <div class="podium-info">
                            <div class="podium-name text-gray-400">No participant</div>
                            <div class="podium-points text-gray-400">--</div>
                        </div>
                    `;
                }
                
                podiumContainer.appendChild(podiumBlock);
            });
        }
        
        // Create detailed leaderboard list
        function createDetailedLeaderboard(leaderboardData) {
            const detailedLeaderboard = document.getElementById('detailedLeaderboard');
            
            if (leaderboardData.length === 0) {
                detailedLeaderboard.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-trophy text-2xl mb-2 text-gray-300"></i>
                        <p class="text-sm">No participants yet</p>
                    </div>
                `;
                return;
            }
            
            detailedLeaderboard.innerHTML = '';
            
            // Separate cheating students from regular students
            const cheatingStudents = leaderboardData.filter(student => 
                student.cheating_reason && student.cheating_reason !== null
            );
            const regularStudents = leaderboardData.filter(student => 
                !student.cheating_reason || student.cheating_reason === null
            );
            
            // Show top 5 regular students
            const topFive = regularStudents.slice(0, 5);
            const currentUser = leaderboardData.find(student => student.is_current_user == 1 || student.is_current_user === true);
            const showCurrentUser = currentUser && currentUser.rank_position > 5;
            
            // Add top 5 regular entries
            topFive.forEach((student, index) => {
                const entry = createLeaderboardEntry(student, false);
                detailedLeaderboard.appendChild(entry);
            });
            
            // Add current user if not in top 5 (whether cheating or not)
            if (showCurrentUser) {
                const currentUserEntry = createLeaderboardEntry(currentUser, true);
                detailedLeaderboard.appendChild(currentUserEntry);
            }
            
            // If current user cheated and is not in top 5, also add them to cheating section
            if (currentUser && (currentUser.cheating_reason && currentUser.cheating_reason !== null) && showCurrentUser) {
                // Current user is already added above, so we don't need to add them again
            }
            
            // Add cheating students section if there are any
            if (cheatingStudents.length > 0) {
                // Add separator
                const separator = document.createElement('div');
                separator.className = 'border-t border-red-200 my-4';
                detailedLeaderboard.appendChild(separator);
                
                // Add cheating section header
                const cheatingHeader = document.createElement('div');
                cheatingHeader.className = 'text-center py-2';
                cheatingHeader.innerHTML = `
                    <div class="flex items-center justify-center text-red-600 font-medium">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span>Students with Cheating Incidents</span>
                    </div>
                `;
                detailedLeaderboard.appendChild(cheatingHeader);
                
                // Add all cheating students
                cheatingStudents.forEach((student, index) => {
                    const entry = createLeaderboardEntry(student, false);
                    detailedLeaderboard.appendChild(entry);
                });
            }
        }
        
        // Create individual leaderboard entry
        function createLeaderboardEntry(student, isCurrentUser) {
            const entry = document.createElement('div');
            entry.className = `leaderboard-entry ${isCurrentUser ? 'you' : ''}`;
            
            const initials = student.student_name.split(' ').map(n => n[0]).join('').toUpperCase();
            
            // Check if this student was marked as cheating
            const isCheating = student.cheating_reason && student.cheating_reason !== null;
            const cheatingIndicator = isCheating ? 
                `<div class="flex items-center mt-1">
                    <i class="fas fa-exclamation-triangle text-red-500 text-xs mr-1"></i>
                    <span class="text-red-600 text-xs font-medium">Cheating Detected</span>
                </div>` : '';
            
            // Add special styling for cheating students
            if (isCheating) {
                entry.classList.add('cheating-entry');
            }
            
            // For cheating students, always show score as 0
            const displayScore = isCheating ? 0 : student.score;
            
            entry.innerHTML = `
                <div class="flex items-center">
                    <div class="leaderboard-rank">${student.rank_position}</div>
                    <div class="leaderboard-student">
                        <div class="leaderboard-avatar ${isCheating ? 'bg-red-500' : ''}">${initials}</div>
                        <div>
                            <div class="leaderboard-name">${student.student_name}</div>
                            ${cheatingIndicator}
                        </div>
                    </div>
                </div>
                <div class="leaderboard-points ${isCheating ? 'text-red-500' : ''}">${displayScore}</div>
            `;
            
            return entry;
        }
        
        // Format time from seconds to MM:SS
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Go to dashboard
        function goToDashboard() {
            window.location.href = '../dashboard.html';
        }

        // Main initialization and auth guard
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Prevent back navigation by adding a history state
                window.history.pushState(null, null, window.location.href);
                
                // Check if this is a page refresh (allow continuation)
                const isRefresh = isPageRefresh();
                console.log('Page refresh detected:', isRefresh);
                
                // Auth guard - check if user is logged in
                const res = await fetch('../php/user.php', { credentials: 'include', cache: 'no-store' });
                if (res.status === 401) { 
                    // User is not logged in - this could be a logout during quiz
                    if (isRefresh) {
                        // Page was refreshed but user is logged out - mark as cheating
                        console.log('User logged out during quiz - marking as cheating');
                        hasLoggedOut = true;
                    }
                    window.location.href = '../login.html'; 
                    return; 
                }
                const data = await res.json();
                if (!data.success) { 
                    if (isRefresh) {
                        // Page was refreshed but user session is invalid - mark as cheating
                        console.log('User session invalid during quiz - marking as cheating');
                        hasLoggedOut = true;
                    }
                    window.location.href = '../login.html'; 
                    return; 
                }
                const u = data.user || {};
                
                // Update user name
                const userNameEl = document.getElementById('userName');
                if (userNameEl && u.first_name) {
                    userNameEl.textContent = `${u.first_name} ${u.last_name || ''}`.trim();
                }
                
                // Check if deadline has passed first
                const isDeadlinePassed = await checkQuizDeadline();
                
                // Check if quiz is already completed
                const completionCheck = await checkQuizCompletion();
                
                // If quiz is completed AND deadline has passed, load review mode
                if (completionCheck === false && isDeadlinePassed) {
                    // Quiz completed and deadline passed - load review mode with completed answers
                    console.log('Quiz completed and deadline passed - loading review mode');
                    await loadCompletedQuizForReview();
                    return;
                }
                
                // If deadline passed but quiz not completed, enable review mode
                if (isDeadlinePassed) {
                    // Deadline passed - enable review mode
                    console.log('Deadline passed - enabling review mode');
                    await loadCompletedQuizForReview();
                    return;
                }
                
                // If quiz is completed but deadline not passed, show completion message
                if (completionCheck) {
                    return; // Stop execution - already shown message in checkQuizCompletion
                }
                
                // If this is a page refresh, allow continuation
                if (isRefresh) {
                    console.log('Page refresh detected - allowing quiz continuation');
                    // The existing quiz attempt will be loaded by initializeQuiz()
                }
                
                // Only show tips container if quiz hasn't been started yet
                if (!quizStarted) {
                    document.getElementById('tipsContainer').classList.remove('hidden');
                    document.getElementById('quizContainer').classList.add('hidden');
                }
                
            } catch (e) {
                console.error('Error during initialization:', e);
                window.location.href = '../login.html';
            }
        });

        // Check quiz deadline and settings
        async function checkQuizDeadline() {
            try {
                const response = await fetch('../php/quiz-management.php?action=get_quiz_settings', {
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success && result.settings && result.settings.functions) {
                    const settings = result.settings.functions;
                    quizDeadline = new Date(settings.deadline);
                    const now = new Date();
                    
                    // Check if deadline has passed
                    if (now > quizDeadline) {
                        isReviewMode = true;
                        enableReviewMode();
                        return true; // Quiz is in review mode
                    }
                }
                
                return false; // Quiz is not in review mode
            } catch (error) {
                console.error('Error checking quiz deadline:', error);
                return false; // On error, allow normal quiz mode
            }
        }

        // Enable review mode
        function enableReviewMode() {
            try {
                console.log('Enabling review mode...');
                
                // Show review mode banner
                const reviewBanner = document.getElementById('reviewModeBanner');
                if (reviewBanner) {
                    reviewBanner.classList.remove('hidden');
                }
                
                // Update quiz title and description
                const quizTitle = document.getElementById('quizTitle');
                const quizDescription = document.getElementById('quizDescription');
                if (quizTitle) quizTitle.textContent = 'Review Your Answers';
                if (quizDescription) quizDescription.textContent = 'Quiz deadline has passed. Review your answers and see the correct solutions.';
                
                // Hide tips container and show quiz container
                const tipsContainer = document.getElementById('tipsContainer');
                const quizContainer = document.getElementById('quizContainer');
                if (tipsContainer) {
                    tipsContainer.classList.add('hidden');
                    tipsContainer.style.display = 'none'; // Ensure it's completely hidden
                }
                if (quizContainer) {
                    quizContainer.classList.remove('hidden');
                    quizContainer.classList.add('review-mode');
                }
                
                // Hide submit button and add back to dashboard button
                const submitContainer = document.getElementById('submitButtonContainer');
                if (submitContainer) {
                    submitContainer.classList.add('hidden');
                }
                addBackToDashboardButton();
                
                console.log('Review mode enabled successfully');
            } catch (error) {
                console.error('Error enabling review mode:', error);
            }
        }

        // Add back to dashboard button in review mode
        function addBackToDashboardButton() {
            const submitContainer = document.getElementById('submitButtonContainer');
            if (submitContainer) {
                submitContainer.innerHTML = `
                    <div class="text-center">
                        <button onclick="goToDashboard()" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-12 py-4 rounded-2xl font-bold text-lg shadow-2xl hover:shadow-3xl transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-home mr-3"></i>
                            Back to Dashboard
                        </button>
                    </div>
                `;
                submitContainer.classList.remove('hidden');
            }
        }

        // Debug function to check student answers (for testing)
        function debugStudentAnswers() {
            console.log('=== DEBUG: Checking Student Answers ===');
            for (let i = 1; i <= 10; i++) {
                const checkedInput = document.querySelector(`input[name="q${i}"]:checked`);
                if (checkedInput) {
                    console.log(`Question ${i}: ${checkedInput.value} ✅`);
                } else {
                    console.log(`Question ${i}: No answer ❌`);
                }
            }
            
            const psAnswer = document.getElementById('ps-answer');
            if (psAnswer && psAnswer.value.trim()) {
                console.log(`Easy Application: ${psAnswer.value} ✅`);
            } else {
                console.log(`Easy Application: No answer ❌`);
            }
            console.log('=== END DEBUG ===');
        }

        // Global debug function for browser console testing
        window.debugQuizAnswers = function() {
            debugStudentAnswers();
        };

        // Global function to manually test loading student answers
        window.testLoadStudentAnswers = async function(attemptId) {
            if (!attemptId) {
                console.log('Please provide an attempt ID. Example: testLoadStudentAnswers(47)');
                return;
            }
            
            console.log(`Testing load student answers for attempt ID: ${attemptId}`);
            await loadStudentAnswersForReview(attemptId);
            
            // Wait a bit then check results
            setTimeout(() => {
                debugStudentAnswers();
                debugQuizDOM();
            }, 100);
        };

        // Global function to force display student answers
        window.forceDisplayStudentAnswers = function() {
            console.log('=== FORCE DISPLAY STUDENT ANSWERS ===');
            
            // Check each question
            for (let i = 1; i <= 10; i++) {
                const inputs = document.querySelectorAll(`input[name="q${i}"]`);
                const checkedInput = document.querySelector(`input[name="q${i}"]:checked`);
                
                console.log(`Question ${i}:`);
                console.log(`  Total inputs: ${inputs.length}`);
                console.log(`  Checked input: ${checkedInput ? checkedInput.value : 'None'}`);
                
                if (checkedInput) {
                    const label = checkedInput.closest('label');
                    if (label) {
                        label.style.backgroundColor = '#3b82f6';
                        label.style.color = 'white';
                        label.style.border = '2px solid #1d4ed8';
                        console.log(`  ✅ Highlighted question ${i} answer: ${checkedInput.value}`);
                    }
                } else {
                    console.log(`  ❌ No answer found for question ${i}`);
                }
            }
            
            // Check problem solving
            const psAnswer = document.getElementById('ps-answer');
            if (psAnswer && psAnswer.value.trim()) {
                psAnswer.style.backgroundColor = '#3b82f6';
                psAnswer.style.color = 'white';
                psAnswer.style.border = '2px solid #1d4ed8';
                console.log(`✅ Highlighted problem solving answer: ${psAnswer.value}`);
            } else {
                console.log('❌ No problem solving answer found');
            }
            
            console.log('=== END FORCE DISPLAY ===');
        };

        // Global function to test review mode with specific attempt
        window.testReviewMode = async function(attemptId) {
            if (!attemptId) {
                console.log('Please provide an attempt ID. Example: testReviewMode(47)');
                return;
            }
            
            console.log(`Testing review mode with attempt ID: ${attemptId}`);
            
            // Enable review mode
            enableReviewMode();
            
            // Load student answers
            await loadStudentAnswersForReview(attemptId);
            
            // Get student answers and load correct answers
            const studentAnswers = await getStudentAnswersForReview(attemptId);
            
            // Wait and then force display
            setTimeout(() => {
                forceDisplayStudentAnswers();
                debugStudentAnswers();
                loadCorrectAnswers(studentAnswers);
            }, 300);
        };

        // Global function to show all available test functions
        window.showReviewModeHelp = function() {
            console.log('=== REVIEW MODE TESTING FUNCTIONS ===');
            console.log('Available functions:');
            console.log('1. testReviewMode(attemptId) - Test complete review mode');
            console.log('2. testLoadStudentAnswers(attemptId) - Test loading student answers');
            console.log('3. forceDisplayStudentAnswers() - Force highlight student answers');
            console.log('4. debugStudentAnswers() - Debug current student answers');
            console.log('5. debugQuizDOM() - Debug DOM elements');
            console.log('');
            console.log('Example usage:');
            console.log('testReviewMode(49)');
            console.log('testLoadStudentAnswers(49)');
            console.log('forceDisplayStudentAnswers()');
            console.log('');
            console.log('Recent attempt IDs to test:');
            console.log('- 49 (Cloe Derecho, Score: 8/15)');
            console.log('- 47 (Cloe Derecho, Score: 4/15)');
            console.log('- 46 (Cloe Derecho, Score: 3/15)');
        };

        // Global function to test anti-cheating system
        window.testAntiCheating = function() {
            console.log('=== ANTI-CHEATING SYSTEM TEST ===');
            console.log('Current settings:');
            console.log(`- Max allowed tab switches: ${maxAllowedTabSwitches}`);
            console.log(`- Max allowed focus loss: ${maxAllowedFocusLoss}ms`);
            console.log(`- Current tab switch count: ${tabSwitchCount}`);
            console.log(`- Quiz active: ${isQuizActive}`);
            console.log(`- Page visible: ${isPageVisible}`);
            console.log('');
            console.log('To test tab switching:');
            console.log('1. Switch to another tab (1st warning)');
            console.log('2. Switch to another tab again (quiz terminated with 0 score)');
            console.log('');
            console.log('To test focus loss:');
            console.log('1. Leave the page for more than 30 seconds');
            console.log('');
            console.log('To manually trigger cheating detection:');
            console.log('markAsCheating("excessive_tab_switches")');
            console.log('');
            console.log('To re-initialize anti-cheating:');
            console.log('reinitializeAntiCheating()');
        };

        // Global function to manually trigger cheating detection for testing
        window.triggerCheating = function(reason = 'excessive_tab_switches') {
            console.log(`🚨 MANUALLY TRIGGERING CHEATING DETECTION: ${reason}`);
            markAsCheating(reason);
        };

        // Global function to check anti-cheating status
        window.checkAntiCheatingStatus = function() {
            console.log('=== ANTI-CHEATING STATUS CHECK ===');
            console.log('Quiz Active:', isQuizActive);
            console.log('Tab Switch Count:', tabSwitchCount);
            console.log('Max Allowed:', maxAllowedTabSwitches);
            console.log('Page Visible:', isPageVisible);
            console.log('Focus Lost Time:', focusLostTime);
            console.log('Current Attempt ID:', currentAttemptId);
            
            // Check if event listeners are still attached
            const hasVisibilityListener = document.hasEventListener && document.hasEventListener('visibilitychange');
            console.log('Visibility Listener Active:', hasVisibilityListener);
            
            return {
                isQuizActive,
                tabSwitchCount,
                maxAllowedTabSwitches,
                isPageVisible,
                focusLostTime,
                currentAttemptId
            };
        };

        // Global function to reset anti-cheating (for testing)
        window.resetAntiCheating = function() {
            console.log('🔄 Resetting anti-cheating system...');
            tabSwitchCount = 0;
            focusLostTime = null;
            isPageVisible = true;
            console.log('✅ Anti-cheating system reset');
        };

        // Global function to re-initialize anti-cheating system
        window.reinitializeAntiCheating = function() {
            console.log('🔄 Re-initializing anti-cheating system...');
            if (isQuizActive) {
                // Stop existing system first
                stopAntiCheating();
                
                // Reset variables
                tabSwitchCount = 0;
                focusLostTime = null;
                isPageVisible = true;
                hasExitedQuiz = false;
                hasLoggedOut = false;
                
                // Re-initialize
                initializeAntiCheating();
                console.log('✅ Anti-cheating system re-initialized');
            } else {
                console.log('❌ Cannot re-initialize - quiz is not active');
            }
        };

        // Global function to force re-attach event listeners
        window.forceReattachListeners = function() {
            console.log('🔧 Force re-attaching all event listeners...');
            
            if (!isQuizActive) {
                console.log('❌ Quiz is not active - cannot re-attach listeners');
                return;
            }
            
            // Remove existing listeners first
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            window.removeEventListener('focus', handleWindowFocus);
            window.removeEventListener('blur', handleWindowBlur);
            window.removeEventListener('beforeunload', handleBeforeUnload);
            window.removeEventListener('unload', handlePageUnload);
            window.removeEventListener('popstate', handlePopState);
            document.removeEventListener('keydown', handleKeyboardShortcuts);
            
            console.log('🗑️ Removed existing listeners');
            
            // Re-attach listeners
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('focus', handleWindowFocus);
            window.addEventListener('blur', handleWindowBlur);
            window.addEventListener('beforeunload', handleBeforeUnload);
            window.addEventListener('unload', handlePageUnload);
            window.addEventListener('popstate', handlePopState);
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            console.log('✅ Event listeners re-attached');
            console.log('🧪 Testing re-attached listeners...');
            
            // Test the listeners
            setTimeout(() => {
                checkEventListeners();
            }, 100);
        };

        // Global function to check if anti-cheating is working
        window.checkAntiCheatingStatus = function() {
            console.log('🔍 CHECKING ANTI-CHEATING STATUS');
            console.log('Quiz Active:', isQuizActive);
            console.log('Tab Switch Count:', tabSwitchCount);
            console.log('Max Allowed:', maxAllowedTabSwitches);
            console.log('Page Visible:', isPageVisible);
            console.log('Focus Lost Time:', focusLostTime);
            console.log('Current Attempt ID:', currentAttemptId);
            console.log('Has Exited Quiz:', hasExitedQuiz);
            console.log('Has Logged Out:', hasLoggedOut);
            
            // Test if event listeners are working
            console.log('Testing visibility change detection...');
            const testEvent = new Event('visibilitychange');
            document.dispatchEvent(testEvent);
            
            console.log('Anti-cheating status check completed');
        };

        // Global function to verify anti-cheating system status
        window.verifyAntiCheatingSystem = function() {
            console.log('=== ANTI-CHEATING SYSTEM VERIFICATION ===');
            console.log('Quiz Active:', isQuizActive);
            console.log('Tab Switch Count:', tabSwitchCount);
            console.log('Max Allowed:', maxAllowedTabSwitches);
            console.log('Page Visible:', isPageVisible);
            console.log('Focus Lost Time:', focusLostTime);
            console.log('Current Attempt ID:', currentAttemptId);
            console.log('Has Exited Quiz:', hasExitedQuiz);
            console.log('Has Logged Out:', hasLoggedOut);
            console.log('Document Hidden:', document.hidden);
            
            // Test if event listeners are working
            console.log('🧪 Testing visibility change detection...');
            console.log('🔍 Simulating tab switch (document.hidden = true)...');
            
            // Manually trigger the visibility change handler
            const originalHidden = document.hidden;
            Object.defineProperty(document, 'hidden', {
                writable: true,
                value: true
            });
            
            // Trigger the event
            const testEvent = new Event('visibilitychange');
            document.dispatchEvent(testEvent);
            
            // Restore original value
            Object.defineProperty(document, 'hidden', {
                writable: true,
                value: originalHidden
            });
            
            console.log('🔍 Tab switch count after test:', tabSwitchCount);
            
            return {
                isQuizActive,
                tabSwitchCount,
                maxAllowedTabSwitches,
                isPageVisible,
                focusLostTime,
                currentAttemptId,
                hasExitedQuiz,
                hasLoggedOut
            };
        };

        // Global function to manually test tab switching
        window.testTabSwitch = function() {
            console.log('🧪 MANUAL TAB SWITCH TEST');
            console.log('Current tab switch count:', tabSwitchCount);
            console.log('Max allowed:', maxAllowedTabSwitches);
            console.log('Quiz active:', isQuizActive);
            
            if (!isQuizActive) {
                console.log('❌ Quiz is not active - cannot test tab switching');
                return;
            }
            
            console.log('🔍 Simulating tab switch...');
            
            // Manually trigger visibility change
            const originalHidden = document.hidden;
            Object.defineProperty(document, 'hidden', {
                writable: true,
                value: true
            });
            
            const testEvent = new Event('visibilitychange');
            document.dispatchEvent(testEvent);
            
            // Restore original value
            Object.defineProperty(document, 'hidden', {
                writable: true,
                value: originalHidden
            });
            
            console.log('🔍 Tab switch count after simulation:', tabSwitchCount);
            
            if (tabSwitchCount >= maxAllowedTabSwitches) {
                console.log('🚨 Tab switch limit exceeded - should trigger cheating detection');
            } else {
                console.log('✅ Tab switch detected but within limits');
            }
        };

        // Global function to check if event listeners are attached
        window.checkEventListeners = function() {
            console.log('🔍 CHECKING EVENT LISTENERS');
            console.log('Quiz Active:', isQuizActive);
            console.log('Document Hidden:', document.hidden);
            console.log('Tab Switch Count:', tabSwitchCount);
            
            // Test if we can manually trigger the handler
            console.log('🧪 Testing manual trigger of handleVisibilityChange...');
            
            // Store original values
            const originalHidden = document.hidden;
            const originalTabSwitchCount = tabSwitchCount;
            
            // Simulate tab switch
            Object.defineProperty(document, 'hidden', {
                writable: true,
                value: true
            });
            
            // Call the handler directly
            handleVisibilityChange();
            
            // Restore original values
            Object.defineProperty(document, 'hidden', {
                writable: true,
                value: originalHidden
            });
            
            console.log('🔍 Tab switch count before:', originalTabSwitchCount);
            console.log('🔍 Tab switch count after:', tabSwitchCount);
            console.log('🔍 Count increased:', tabSwitchCount > originalTabSwitchCount ? 'YES' : 'NO');
            
            if (tabSwitchCount > originalTabSwitchCount) {
                console.log('✅ handleVisibilityChange is working correctly');
            } else {
                console.log('❌ handleVisibilityChange is NOT working');
            }
        };

        // Comprehensive debug function to check DOM elements and answers
        window.debugQuizDOM = function() {
            console.log('=== DEBUG: Checking DOM Elements ===');
            
            // Check if quiz container exists
            const quizContainer = document.getElementById('quizContainer');
            console.log('Quiz Container:', quizContainer ? 'Found' : 'Not Found');
            
            // Check each question's DOM elements
            for (let i = 1; i <= 10; i++) {
                const questionDiv = document.querySelector(`[data-question="${i}"]`);
                const inputs = document.querySelectorAll(`input[name="q${i}"]`);
                const checkedInput = document.querySelector(`input[name="q${i}"]:checked`);
                
                console.log(`Question ${i}:`);
                console.log(`  Question div: ${questionDiv ? 'Found' : 'Not Found'}`);
                console.log(`  Inputs: ${inputs.length} found`);
                console.log(`  Checked input: ${checkedInput ? checkedInput.value : 'None'}`);
                
                if (inputs.length > 0) {
                    console.log(`  Available values: ${Array.from(inputs).map(inp => inp.value).join(', ')}`);
                }
            }
            
            // Check problem solving
            const psInput = document.getElementById('ps-answer');
            console.log(`Easy Application Input: ${psInput ? 'Found' : 'Not Found'}`);
            if (psInput) {
                console.log(`  Value: "${psInput.value}"`);
            }
            
            console.log('=== END DOM DEBUG ===');
        };

        // Global function to test the complete anti-cheating flow
        window.testAntiCheatingFlow = function() {
            console.log('🧪 TESTING COMPLETE ANTI-CHEATING FLOW');
            console.log('Current state:');
            console.log('- Quiz active:', isQuizActive);
            console.log('- Tab switch count:', tabSwitchCount);
            console.log('- Max allowed:', maxAllowedTabSwitches);
            
            if (!isQuizActive) {
                console.log('❌ Quiz is not active - cannot test');
                return;
            }
            
            console.log('🔍 Testing first tab switch...');
            // Simulate first tab switch
            Object.defineProperty(document, 'hidden', { writable: true, value: true });
            document.dispatchEvent(new Event('visibilitychange'));
            Object.defineProperty(document, 'hidden', { writable: true, value: false });
            document.dispatchEvent(new Event('visibilitychange'));
            
            console.log('After first switch - tab count:', tabSwitchCount);
            
            if (tabSwitchCount >= maxAllowedTabSwitches) {
                console.log('✅ Second switch should trigger cheating detection');
            } else {
                console.log('🔍 Testing second tab switch...');
                // Simulate second tab switch
                Object.defineProperty(document, 'hidden', { writable: true, value: true });
                document.dispatchEvent(new Event('visibilitychange'));
                
                console.log('After second switch - tab count:', tabSwitchCount);
                console.log('Should trigger cheating:', tabSwitchCount >= maxAllowedTabSwitches);
            }
        };

        // SIMPLIFIED ANTI-CHEATING SYSTEM
        // Remove the complex backup system and use a simpler, more reliable approach
        
        // Global function to test if anti-cheating is working
        window.testAntiCheatingSimple = function() {
            console.log('🧪 SIMPLE ANTI-CHEATING TEST');
            console.log('Quiz Active:', isQuizActive);
            console.log('Tab Switch Count:', tabSwitchCount);
            console.log('Max Allowed:', maxAllowedTabSwitches);
            console.log('Page Visible:', isPageVisible);
            
            if (!isQuizActive) {
                console.log('❌ Quiz is not active - cannot test');
                return;
            }
            
            console.log('🔍 Testing visibility change detection...');
            const originalTabCount = tabSwitchCount;
            
            // Simulate a tab switch
            const originalHidden = document.hidden;
            Object.defineProperty(document, 'hidden', { writable: true, value: true });
            document.dispatchEvent(new Event('visibilitychange'));
            Object.defineProperty(document, 'hidden', { writable: true, value: originalHidden });
            
            setTimeout(() => {
                if (tabSwitchCount > originalTabCount) {
                    console.log('✅ Anti-cheating system is working');
                    console.log(`Tab switch count increased from ${originalTabCount} to ${tabSwitchCount}`);
                } else {
                    console.log('❌ Anti-cheating system is NOT working');
                    console.log('Tab switch count did not increase');
                }
            }, 100);
        };

        // Load completed quiz for review when deadline has passed
        async function loadCompletedQuizForReview() {
            try {
                console.log('Loading completed quiz for review...');
                
                // Get student's quiz history
                const response = await fetch('../php/quiz-management.php?action=get_student_history&quiz_type=functions', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Student history result:', result);
                
                if (result.success && result.attempts && result.attempts.length > 0) {
                    const latestAttempt = result.attempts[0]; // Get the most recent attempt
                    console.log('Latest attempt found:', latestAttempt);
                    
                    // Set current attempt ID for reference (use 'id' field from student history)
                    currentAttemptId = latestAttempt.id;
                    console.log('Set currentAttemptId to:', currentAttemptId);
                    
                    // Enable review mode first
                    enableReviewMode();
                    
                    // Load the student's answers first
                    await loadStudentAnswersForReview(latestAttempt.id);
                    
                    // Show the student's score
                    showReviewScore(latestAttempt);
                    
                    // Wait a bit to ensure DOM is updated, then load correct answers
                    setTimeout(() => {
                        // Debug DOM elements
                        debugQuizDOM();
                        // Debug student answers
                        debugStudentAnswers();
                        // Force display of student answers first
                        displayStudentAnswersInReview();
                        // Force highlight student answers
                        forceDisplayStudentAnswers();
                        // Then load correct answers after ensuring student answers are loaded
                        setTimeout(() => {
                            // Get student answers from database to pass to loadCorrectAnswers
                            getStudentAnswersForReview(latestAttempt.id).then(studentAnswers => {
                                loadCorrectAnswers(studentAnswers);
                                buildReviewSummary(studentAnswers);
                            });
                        }, 100);
                    }, 200);
                } else {
                    console.log('No completed quiz found, enabling review mode only');
                    // No completed quiz found, just enable review mode
                    enableReviewMode();
                    
                    // Ensure tips are hidden in review mode
                    const tipsContainer = document.getElementById('tipsContainer');
                    if (tipsContainer) {
                        tipsContainer.classList.add('hidden');
                        tipsContainer.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading completed quiz for review:', error);
                // Fallback to just enabling review mode
                enableReviewMode();
            }
        }

        // Get student answers from database (for passing to loadCorrectAnswers)
        async function getStudentAnswersForReview(attemptId) {
            try {
                console.log('Getting student answers for review, attempt ID:', attemptId);
                
                const response = await fetch(`../php/quiz-management.php?action=get_quiz_answers&attempt_id=${attemptId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Student answers result:', result);
                
                if (result.success && result.answers) {
                    console.log('Student answers from database:', result.answers);
                    return result.answers;
                } else {
                    console.log('❌ No student answers found or failed to load');
                    return {};
                }
            } catch (error) {
                console.error('❌ Error getting student answers for review:', error);
                return {};
            }
        }

        // Load student's answers for review
        async function loadStudentAnswersForReview(attemptId) {
            try {
                console.log('Loading student answers for review, attempt ID:', attemptId);
                
                const response = await fetch(`../php/quiz-management.php?action=get_quiz_answers&attempt_id=${attemptId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Student answers result:', result);
                
                if (result.success && result.answers) {
                    console.log('Student answers from database:', result.answers);
                    
                    // Restore student's multiple choice answers
                    for (let i = 1; i <= 10; i++) {
                        const answer = result.answers[`q${i}`];
                        console.log(`Question ${i} answer:`, answer);
                        
                        if (answer) {
                            const input = document.querySelector(`input[name="q${i}"][value="${answer}"]`);
                            console.log(`Looking for input[name="q${i}"][value="${answer}"]:`, input);
                            if (input) {
                                input.checked = true;
                                console.log(`✅ Set question ${i} answer to: ${answer}`);
                                
                                const label = input.closest('label');
                                if (label) {
                                    label.classList.add('option-selected');
                                    
                                    // Add strong visual indicator for student's answer
                                    label.style.backgroundColor = '#3b82f6';
                                    label.style.color = 'white';
                                    label.style.border = '2px solid #1d4ed8';
                                    label.style.fontWeight = 'bold';
                                    
                                    // Add visual indicator text
                                    if (!label.querySelector('.student-answer-indicator')) {
                                        const indicator = document.createElement('span');
                                        indicator.className = 'student-answer-indicator ml-2 text-sm font-medium text-white';
                                        indicator.innerHTML = '<i class="fas fa-user mr-1"></i>YOUR ANSWER';
                                        indicator.style.backgroundColor = '#1d4ed8';
                                        indicator.style.padding = '2px 6px';
                                        indicator.style.borderRadius = '4px';
                                        label.appendChild(indicator);
                                    }
                                }
                                
                                // Force a change event to ensure the input is properly recognized
                                input.dispatchEvent(new Event('change', { bubbles: true }));
                                
                                // Also trigger click event to ensure proper selection
                                input.click();
                            } else {
                                console.log(`❌ Could not find input for question ${i} with value: ${answer}`);
                                // List all available inputs for this question
                                const allInputs = document.querySelectorAll(`input[name="q${i}"]`);
                                console.log(`Available inputs for question ${i}:`, Array.from(allInputs).map(inp => inp.value));
                            }
                        } else {
                            console.log(`❌ No answer found for question ${i}`);
                        }
                    }
                    
                    // Restore student's problem solving answer
                    const psAnswerInput = document.getElementById('ps-answer');
                    if (psAnswerInput && result.answers['ps-answer']) {
                        psAnswerInput.value = result.answers['ps-answer'];
                        console.log('✅ Set problem solving answer to:', result.answers['ps-answer']);
                        
                        // Add strong visual indicator for problem solving answer
                        psAnswerInput.style.backgroundColor = '#3b82f6';
                        psAnswerInput.style.color = 'white';
                        psAnswerInput.style.border = '2px solid #1d4ed8';
                        psAnswerInput.style.fontWeight = 'bold';
                        
                        // Add visual indicator for problem solving answer
                        if (!psAnswerInput.parentNode.querySelector('.student-answer-indicator')) {
                            const indicator = document.createElement('div');
                            indicator.className = 'student-answer-indicator mt-2 text-sm font-medium text-white';
                            indicator.innerHTML = '<i class="fas fa-user mr-1"></i>YOUR ANSWER';
                            indicator.style.backgroundColor = '#1d4ed8';
                            indicator.style.padding = '4px 8px';
                            indicator.style.borderRadius = '4px';
                            indicator.style.display = 'inline-block';
                            psAnswerInput.parentNode.appendChild(indicator);
                        }
                    } else {
                        console.log('❌ No problem solving answer found or input not found');
                    }
                    
                    console.log('✅ Student answers loaded for review');
                } else {
                    console.log('❌ No student answers found or failed to load');
                    console.log('Result:', result);
                }
            } catch (error) {
                console.error('❌ Error loading student answers for review:', error);
            }
        }

        // Display student answers in review mode
        function displayStudentAnswersInReview() {
            try {
                console.log('Displaying student answers in review mode...');
                
                // Check each question to see if student answered
                for (let i = 1; i <= 10; i++) {
                    const checkedInput = document.querySelector(`input[name="q${i}"]:checked`);
                    if (checkedInput) {
                        console.log(`✅ Student answered question ${i}: ${checkedInput.value}`);
                        
                        // Add visual indicator that this is the student's answer
                        const label = checkedInput.closest('label');
                        if (label && !label.querySelector('.student-answer-indicator')) {
                            const indicator = document.createElement('span');
                            indicator.className = 'student-answer-indicator ml-2 text-sm font-medium text-blue-600';
                            indicator.innerHTML = '<i class="fas fa-user mr-1"></i>Your Answer';
                            label.appendChild(indicator);
                        }
                    } else {
                        console.log(`❌ Student did not answer question ${i}`);
                    }
                }
                
                // Check problem solving answer
                const psAnswer = document.getElementById('ps-answer');
                if (psAnswer && psAnswer.value.trim()) {
                    console.log(`✅ Student answered problem solving: ${psAnswer.value}`);
                } else {
                    console.log(`❌ Student did not answer problem solving`);
                }
                
                console.log('✅ Student answers display completed');
            } catch (error) {
                console.error('❌ Error displaying student answers:', error);
            }
        }

        // Show review score information
        function showReviewScore(attempt) {
            // Add score display to the quiz header
            const quizHeader = document.querySelector('.gradient-bg');
            if (quizHeader) {
                const scoreDisplay = document.createElement('div');
                scoreDisplay.className = 'mt-4 bg-white/20 backdrop-blur-sm rounded-lg px-6 py-3';
                scoreDisplay.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl font-bold text-white mb-1">Your Score: ${attempt.score}/${attempt.total_questions}</div>
                        <div class="text-lg text-white/90">${attempt.percentage}% - Completed on ${attempt.quiz_date}</div>
                    </div>
                `;
                quizHeader.appendChild(scoreDisplay);
            }
        }

        // Load and display correct answers in review mode
        function loadCorrectAnswers(studentAnswers = null) {
            try {
                console.log('Loading correct answers for review mode...');
                console.log('Student answers passed to loadCorrectAnswers:', studentAnswers);
                
                // Show correct answers for multiple choice questions
                for (let i = 1; i <= 10; i++) {
                    const correctAnswer = quizData.answers[`q${i}`];
                    
                    // Use passed student answers if available, otherwise check DOM
                    let studentAnswer = null;
                    let checkedInput = null;
                    
                    if (studentAnswers && studentAnswers[`q${i}`]) {
                        studentAnswer = studentAnswers[`q${i}`];
                        console.log(`✅ Using passed student answer for Q${i}: "${studentAnswer}" (type: ${typeof studentAnswer})`);
                    } else {
                        checkedInput = document.querySelector(`input[name="q${i}"]:checked`);
                        studentAnswer = checkedInput ? checkedInput.value : null;
                        console.log(`⚠️ Using DOM student answer for Q${i}: "${studentAnswer}" (type: ${typeof studentAnswer})`);
                    }
                    
                    console.log(`Review Mode - Question ${i}:`);
                    console.log(`  Correct answer: ${correctAnswer}`);
                    console.log(`  Checked input found:`, checkedInput);
                    console.log(`  Student answer: ${studentAnswer || 'None'}`);
                    
                    // Debug: Check all inputs for this question
                    const allInputs = document.querySelectorAll(`input[name="q${i}"]`);
                    console.log(`  All inputs for question ${i}:`, allInputs);
                    allInputs.forEach(input => {
                        console.log(`    Input value: ${input.value}, checked: ${input.checked}`);
                    });
                    
                    // Always show the correct answer with green background and checkmark
                    const correctInput = document.querySelector(`input[name="q${i}"][value="${correctAnswer}"]`);
                    if (correctInput) {
                        const correctLabel = correctInput.closest('label');
                        if (correctLabel) {
                            correctLabel.classList.add('option-correct');
                            
                            // Add checkmark icon to correct answer (only if not already added)
                            if (!correctLabel.querySelector('.fa-check-circle')) {
                                const checkIcon = document.createElement('i');
                                checkIcon.className = 'fas fa-check-circle text-white ml-2';
                                checkIcon.title = 'Correct Answer';
                                correctLabel.appendChild(checkIcon);
                            }
                        }
                    }
                    
                    // Mark student's answer if they selected one
                    if (studentAnswer) {
                        const studentInput = document.querySelector(`input[name="q${i}"][value="${studentAnswer}"]`);
                        if (studentInput) {
                            const studentLabel = studentInput.closest('label');
                            if (studentLabel) {
                                if (studentAnswer === correctAnswer) {
                                    // Student's answer is correct - add "Your Answer" indicator
                                    if (!studentLabel.querySelector('.fa-user-check')) {
                                        const yourAnswerIcon = document.createElement('i');
                                        yourAnswerIcon.className = 'fas fa-user-check text-white ml-2';
                                        yourAnswerIcon.title = 'Your Answer (Correct)';
                                        studentLabel.appendChild(yourAnswerIcon);
                                    }
                                } else {
                                    // Student's answer is incorrect - highlight their mistake
                                    studentLabel.classList.add('option-incorrect');
                                    if (!studentLabel.querySelector('.fa-times-circle')) {
                                        const wrongIcon = document.createElement('i');
                                        wrongIcon.className = 'fas fa-times-circle text-white ml-2';
                                        wrongIcon.title = 'Your Answer (Incorrect)';
                                        studentLabel.appendChild(wrongIcon);
                                    }
                                    
                                    // Add red border to highlight the mistake
                                    studentLabel.style.border = '3px solid #ef4444';
                                    studentLabel.style.boxShadow = '0 0 10px rgba(239, 68, 68, 0.3)';
                                }
                            }
                        }
                    } else {
                        // Student didn't answer - show as unanswered
                        const questionCard = document.querySelector(`[data-question="${i}"]`);
                        if (questionCard && !questionCard.querySelector('.unanswered-notice')) {
                            const unansweredDiv = document.createElement('div');
                            unansweredDiv.className = 'mt-2 p-2 bg-yellow-100 border border-yellow-300 rounded-lg unanswered-notice';
                            unansweredDiv.innerHTML = `
                                <div class="flex items-center text-yellow-800">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    <span class="text-sm font-medium">You did not answer this question</span>
                                </div>
                            `;
                            const optionsContainer = questionCard.querySelector('.space-y-3');
                            if (optionsContainer) {
                                optionsContainer.parentNode.insertBefore(unansweredDiv, optionsContainer.nextSibling);
                            }
                        }
                    }
                    
                    // Add explanation for each question (only once)
                    addQuestionExplanation(i, correctAnswer, studentAnswer);
                }
            
                // Show correct answer for problem solving
                const psAnswer = document.getElementById('ps-answer');
                
                if (psAnswer) {
                    // Use passed student answer if available, otherwise use DOM value
                    let studentAnswer = null;
                    if (studentAnswers && studentAnswers['ps-answer']) {
                        studentAnswer = studentAnswers['ps-answer'];
                        console.log(`Using passed problem solving answer: ${studentAnswer}`);
                    } else {
                        studentAnswer = psAnswer.value;
                        console.log(`Using DOM problem solving answer: ${studentAnswer}`);
                    }
                    const correctAnswer = quizData.problemSolving.answer;
                    
                    if (studentAnswer) {
                        psAnswer.value = `${studentAnswer} (Correct: ${correctAnswer})`;
                        
                        if (Math.abs(parseInt(studentAnswer) - correctAnswer) <= 50) {
                            psAnswer.style.backgroundColor = '#10b981';
                            psAnswer.style.color = 'white';
                            psAnswer.style.border = '3px solid #10b981';
                        } else {
                            psAnswer.style.backgroundColor = '#ef4444';
                            psAnswer.style.color = 'white';
                            psAnswer.style.border = '3px solid #ef4444';
                            psAnswer.style.boxShadow = '0 0 10px rgba(239, 68, 68, 0.3)';
                        }
                    } else {
                        psAnswer.value = `No answer (Correct: ${correctAnswer})`;
                        psAnswer.style.backgroundColor = '#f59e0b';
                        psAnswer.style.color = 'white';
                        psAnswer.style.border = '3px solid #f59e0b';
                    }
                }
                
                // Add problem solving explanation (only once)
                addProblemSolvingExplanation();
                
                console.log('✅ Correct answers loaded for review mode');
            } catch (error) {
                console.error('❌ Error loading correct answers:', error);
            }
        }

        // Add explanation for each question (prevent duplication)
        function addQuestionExplanation(questionNumber, correctAnswer, studentAnswer) {
            const questionCard = document.querySelector(`[data-question="${questionNumber}"]`);
            if (!questionCard) return;
            
            // Debug logging
            console.log(`addQuestionExplanation - Q${questionNumber}:`);
            console.log(`  Correct answer: ${correctAnswer}`);
            console.log(`  Student answer: ${studentAnswer}`);
            console.log(`  Student answer type: ${typeof studentAnswer}`);
            console.log(`  Student answer truthy: ${!!studentAnswer}`);
            
            // Check if explanation already exists to prevent duplication
            if (questionCard.querySelector('.explanation-added')) {
                return;
            }
            
            const explanations = {
                1: {
                    correct: "A function is a relationship where each input has exactly one output. This is the fundamental definition of a function in mathematics.",
                    incorrect: "A function cannot have multiple outputs for the same input. Each input must correspond to exactly one output."
                },
                2: {
                    correct: "f(x) is read as 'f of x' and represents the value of the function f when the input is x.",
                    incorrect: "f(x) is not multiplication. It's function notation meaning 'f of x'."
                },
                3: {
                    correct: "f(4) = 3(4) - 2 = 12 - 2 = 10. We substitute 4 for x in the function.",
                    incorrect: "Remember to substitute the value into the function: f(4) = 3(4) - 2 = 10."
                },
                4: {
                    correct: "For √(x - 3) to be real, x - 3 must be ≥ 0, so x ≥ 3.",
                    incorrect: "The square root function requires the expression inside to be non-negative."
                },
                5: {
                    correct: "x² is always ≥ 0 for any real number x, so the range is y ≥ 0.",
                    incorrect: "x² can never be negative, so the range starts from 0 and goes to positive infinity."
                },
                6: {
                    correct: "(f + g)(x) = f(x) + g(x) = (2x + 1) + (x - 3) = 3x - 2",
                    incorrect: "To add functions, add their expressions: (2x + 1) + (x - 3) = 3x - 2."
                },
                7: {
                    correct: "(f · g)(x) = f(x) · g(x) = (2x)(x + 3) = 2x² + 6x",
                    incorrect: "To multiply functions, multiply their expressions: (2x)(x + 3) = 2x² + 6x."
                },
                8: {
                    correct: "The denominator x - 2 cannot be zero, so x ≠ 2.",
                    incorrect: "Division by zero is undefined, so x - 2 ≠ 0, which means x ≠ 2."
                },
                9: {
                    correct: "(f ∘ g)(x) = f(g(x)) = f(x-3) = 2(x-3) + 1 = 2x - 6 + 1 = 2x - 5",
                    incorrect: "For composition, substitute g(x) into f: f(x-3) = 2(x-3) + 1 = 2x - 5."
                },
                10: {
                    correct: "To find the inverse, solve y = 3x - 2 for x: y + 2 = 3x, so x = (y + 2)/3. Therefore f⁻¹(x) = (x + 2)/3.",
                    incorrect: "To find the inverse, swap x and y and solve for y: x = 3y - 2, so y = (x + 2)/3."
                }
            };
            
            const explanation = explanations[questionNumber];
            if (explanation) {
                const explanationDiv = document.createElement('div');
                explanationDiv.className = 'mt-4 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400 explanation-added';

                // Determine if student got it right or wrong
                const isCorrect = studentAnswer === correctAnswer;
                const explanationText = isCorrect ? explanation.correct : explanation.incorrect;
                const iconClass = isCorrect ? 'fa-check-circle text-green-500' : 'fa-exclamation-triangle text-orange-500';
                const titleText = isCorrect ? 'Correct Answer!' : 'Review This Concept';

                // Add status chip on question header (once)
                const header = questionCard.querySelector('h3');
                if (header && !questionCard.querySelector('.review-status-chip')) {
                    const chip = document.createElement('span');
                    chip.className = `review-status-chip inline-flex items-center ml-3 px-2 py-1 rounded-full text-xs font-semibold ${isCorrect ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
                    chip.innerHTML = isCorrect ? '<i class="fas fa-check mr-1"></i>Correct' : '<i class="fas fa-times mr-1"></i>Incorrect';
                    header.appendChild(chip);
                }

                // Collapsible explanation content
                const contentId = `exp-q${questionNumber}`;
                explanationDiv.innerHTML = `
                    <button type="button" class="mb-2 text-sm font-semibold text-blue-700 hover:text-blue-900 focus:outline-none flex items-center" onclick="toggleExplanation('${contentId}')">
                        <i class="fas fa-info-circle mr-2"></i> Show/Hide Explanation
                    </button>
                    <div id="${contentId}" class="mt-2">
                        <div class="flex items-start">
                            <i class="fas ${iconClass} mt-1 mr-3"></i>
                            <div>
                                <h4 class="font-semibold text-blue-800 mb-2">${titleText}</h4>
                                <p class="text-blue-700 text-sm">${explanationText}</p>
                                ${!isCorrect ? `
                                    <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded">
                                        <p class="text-red-700 text-xs">
                                            <strong>Your mistake:</strong> You selected option ${studentAnswer ? studentAnswer.toUpperCase() : 'none'}, 
                                            but the correct answer is ${correctAnswer.toUpperCase()}.
                                        </p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;

                // Insert explanation after the options
                const optionsContainer = questionCard.querySelector('.space-y-3');
                if (optionsContainer) {
                    optionsContainer.parentNode.insertBefore(explanationDiv, optionsContainer.nextSibling);
                }
            }
        }

        // Add problem solving explanation (prevent duplication)
        function addProblemSolvingExplanation() {
            const problemSolvingCard = document.querySelector('[data-question="11"]');
            if (!problemSolvingCard) return;
            
            // Check if explanation already exists to prevent duplication
            if (problemSolvingCard.querySelector('.ps-explanation-added')) {
                return;
            }
            
            const explanationDiv = document.createElement('div');
            explanationDiv.className = 'mt-6 p-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border-2 border-purple-200 ps-explanation-added';
            explanationDiv.innerHTML = `
                <button type="button" class="mb-3 text-sm font-semibold text-purple-700 hover:text-purple-900 focus:outline-none flex items-center" onclick="toggleExplanation('ps-exp')">
                    <i class="fas fa-info-circle mr-2"></i> Show/Hide Solution
                </button>
                <div id="ps-exp">
                    <div class="flex items-start">
                        <i class="fas fa-calculator text-purple-500 mt-1 mr-3 text-xl"></i>
                        <div>
                            <h4 class="font-bold text-purple-800 mb-4 text-lg">Easy Application Solution:</h4>
                            <div class="space-y-4">
                                <div class="bg-white rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-2">Maximum Profit Solution:</h5>
                                    <p class="text-gray-700 text-sm mb-2">To find the maximum profit, we find the vertex of the parabola P(x) = -2x² + 80x - 500.</p>
                                    <p class="text-gray-700 text-sm mb-2">The x-coordinate of the vertex is: x = -b/(2a) = -80/(2(-2)) = 20</p>
                                    <p class="text-gray-700 text-sm">Maximum profit: P(20) = -2(20)² + 80(20) - 500 = -800 + 1600 - 500 = <strong>300 thousand pesos</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Insert explanation after the problem solving inputs
            const inputsContainer = problemSolvingCard.querySelector('.bg-white.rounded-lg.p-6');
            if (inputsContainer) {
                inputsContainer.parentNode.insertBefore(explanationDiv, inputsContainer.nextSibling);
            }
        }

        // Toggle helper for collapsible explanations
        function toggleExplanation(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.style.display = (el.style.display === 'none') ? '' : 'none';
        }

        // Build review summary of missed concepts with tips
        function buildReviewSummary(studentAnswers) {
            try {
                const concepts = {
                    1: { title: 'Definition of a function', tip: 'Each input must map to exactly one output.' },
                    2: { title: 'Function notation f(x)', tip: "Read f(x) as 'f of x' and substitute x." },
                    3: { title: 'Evaluating functions', tip: 'Substitute the input value into x and simplify.' },
                    4: { title: 'Domain with square roots', tip: 'Ensure the radicand is ≥ 0.' },
                    5: { title: 'Range of quadratic y = x²', tip: 'Outputs are never negative; minimum at 0.' },
                    6: { title: 'Adding functions', tip: 'Add corresponding expressions term-by-term.' },
                    7: { title: 'Multiplying functions', tip: 'Multiply expressions and combine like terms.' },
                    8: { title: 'Domain with rational functions', tip: 'Denominator cannot be zero.' },
                    9: { title: 'Function composition f ∘ g', tip: 'Plug g(x) into f(x) carefully.' },
                    10: { title: 'Inverse functions', tip: 'Swap x and y, then solve for y.' }
                };

                const missed = [];
                for (let i = 1; i <= 10; i++) {
                    const student = studentAnswers && studentAnswers[`q${i}`];
                    const correct = quizData.answers[`q${i}`];
                    if (!student || student !== correct) {
                        missed.push({ q: i, ...concepts[i] });
                    }
                }

                // Create summary block under results header
                const resultsContainer = document.getElementById('resultsContainer');
                if (!resultsContainer) return;

                // Avoid duplicates
                if (resultsContainer.querySelector('#reviewSummary')) return;

                const summary = document.createElement('div');
                summary.id = 'reviewSummary';
                summary.className = 'bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-6 mb-8';
                summary.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-lightbulb text-yellow-500 mr-2"></i> What to Review Next
                    </h3>
                    ${missed.length === 0 ? `
                        <p class="text-green-700 font-semibold">Great job! You got all multiple-choice questions correct.</p>
                    ` : `
                        <p class="text-gray-700 mb-3">Focus on these concepts you missed:</p>
                        <ul class="list-disc ml-6 space-y-1 text-gray-700">
                            ${missed.map(m => `<li><strong>Q${m.q} — ${m.title}</strong>: ${m.tip}</li>`).join('')}
                        </ul>
                    `}
                `;

                // Insert summary near top of results content
                const resultsContent = resultsContainer.querySelector('.bg-white.rounded-2xl.shadow-xl.p-8');
                if (resultsContent) {
                    resultsContent.insertBefore(summary, resultsContent.children[1] || resultsContent.firstChild);
                }
            } catch (e) {
                console.error('Error building review summary:', e);
            }
        }

        // Check if student has already completed this quiz
        async function checkQuizCompletion() {
            try {
                const response = await fetch('../php/quiz-management.php?action=get_student_history&quiz_type=functions', {
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success && result.attempts && result.attempts.length > 0) {
                    // Student has completed this quiz
                    const latestAttempt = result.attempts[0]; // Get the most recent attempt
                    
                    // Check if deadline has passed
                    const isDeadlinePassed = await checkQuizDeadline();
                    
                    if (isDeadlinePassed) {
                        // Deadline passed - allow review access
                        console.log('Quiz completed but deadline passed - allowing review access');
                        return false; // Continue with quiz in review mode
                    } else {
                        // Deadline not passed - show completion message and redirect
                        Swal.fire({
                            title: 'Quiz Already Completed',
                            html: `
                                <div class="text-center">
                                    <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <i class="fas fa-check-circle text-blue-500 text-3xl"></i>
                                    </div>
                                    <p class="text-lg text-gray-700 mb-4">You have already completed this quiz!</p>
                                    <div class="bg-blue-50 rounded-lg p-4 mb-4">
                                        <div class="text-2xl font-bold text-blue-600">${latestAttempt.score}/${latestAttempt.total_questions}</div>
                                        <div class="text-sm text-blue-500">Score: ${latestAttempt.percentage}%</div>
                                        <div class="text-xs text-gray-500 mt-1">Completed on ${latestAttempt.quiz_date}</div>
                                    </div>
                                    <p class="text-sm text-gray-600">You cannot retake this quiz.</p>
                                </div>
                            `,
                            icon: 'info',
                            confirmButtonText: 'Back to Quizzes',
                            confirmButtonColor: '#6366f1',
                            background: '#ffffff',
                            customClass: {
                                popup: 'rounded-2xl',
                                title: 'text-slate-800',
                                content: 'text-slate-600'
                            },
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '../quizzes.html';
                            }
                        });
                        
                        return true; // Quiz is completed, stop execution
                    }
                }
                
                return false; // Quiz is not completed, continue
            } catch (error) {
                console.error('Error checking quiz completion:', error);
                return false; // On error, allow quiz to continue
            }
        }

        // ==================== ANTI-CHEATING SYSTEM ====================
        
        // Initialize anti-cheating monitoring
        function initializeAntiCheating() {
            console.log('🔧 Initializing anti-cheating system...');
            
            // Stop any existing anti-cheating first
            stopAntiCheating();
            
            // Reset variables
            tabSwitchCount = 0;
            focusLostTime = null;
            isPageVisible = true;
            hasExitedQuiz = false;
            hasLoggedOut = false;
            isQuizActive = true; // Ensure quiz is marked as active
            
            // Start heartbeat monitoring
            startHeartbeat();
            
            // Monitor page visibility - CRITICAL for tab switch detection
            document.addEventListener('visibilitychange', handleVisibilityChange);
            console.log('✅ Visibility change listener attached');
            
            // Monitor window focus
            window.addEventListener('focus', handleWindowFocus);
            window.addEventListener('blur', handleWindowBlur);
            console.log('✅ Focus/blur listeners attached');
            
            // Monitor beforeunload (page exit)
            window.addEventListener('beforeunload', handleBeforeUnload);
            
            // Monitor page unload (logout, close tab)
            window.addEventListener('unload', handlePageUnload);
            
            // Monitor browser back button
            window.addEventListener('popstate', handlePopState);
            
            // Monitor new tab/window opening
            window.addEventListener('beforeunload', handleNewTab);
            
            // Monitor keyboard shortcuts for new tab
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            console.log('✅ Anti-cheating system initialized');
            console.log('📊 Initial state - Tab switches: 0, Quiz active: true');
            console.log('🔍 Event listeners attached for visibility, focus, blur, keyboard');
            
            // Test the visibility change detection immediately
            console.log('🧪 Testing visibility change detection...');
            setTimeout(() => {
                console.log('🔍 Current document.hidden:', document.hidden);
                console.log('🔍 Current isQuizActive:', isQuizActive);
            }, 100);
        }
        
        // Stop anti-cheating monitoring
        function stopAntiCheating() {
            console.log('Stopping anti-cheating system...');
            
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
            
            // Remove event listeners
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            window.removeEventListener('focus', handleWindowFocus);
            window.removeEventListener('blur', handleWindowBlur);
            window.removeEventListener('beforeunload', handleBeforeUnload);
            window.removeEventListener('unload', handlePageUnload);
            window.removeEventListener('popstate', handlePopState);
            document.removeEventListener('keydown', handleKeyboardShortcuts);
            
            isQuizActive = false;
            console.log('Anti-cheating system stopped');
        }
        
        // Start heartbeat monitoring
        function startHeartbeat() {
            lastHeartbeat = Date.now();
            
            heartbeatInterval = setInterval(async () => {
                if (!isQuizActive) return;
                
                // Skip heartbeat if no attempt ID
                if (!currentAttemptId) {
                    console.log('⚠️ Skipping heartbeat - no attempt ID');
                    return;
                }
                
                try {
                    // Send heartbeat to server
                    const response = await fetch('../php/quiz-management.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `action=heartbeat&attempt_id=${currentAttemptId}`,
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (!result.success) {
                            console.warn('Heartbeat failed:', result.message);
                        }
                    }
                } catch (error) {
                    console.error('Heartbeat error:', error);
                }
                
                lastHeartbeat = Date.now();
            }, 10000); // Send heartbeat every 10 seconds
        }
        
        // Handle page visibility changes
        function handleVisibilityChange() {
            console.log('🔍 Visibility change detected - isQuizActive:', isQuizActive, 'document.hidden:', document.hidden);
            console.log('🔍 Current tab switch count:', tabSwitchCount);
            console.log('🔍 Max allowed tab switches:', maxAllowedTabSwitches);
            
            if (!isQuizActive) {
                console.log('❌ Quiz not active - ignoring visibility change');
                return;
            }
            
            if (document.hidden) {
                console.log('👁️ Page became hidden - potential cheating detected');
                focusLostTime = Date.now();
                isPageVisible = false;
                
                // Only increment tab switch count if this is a real tab switch
                // Add a small delay to avoid counting rapid visibility changes
                setTimeout(() => {
                    if (document.hidden && isQuizActive) {
                        tabSwitchCount++;
                        
                        console.log(`📊 Tab switch count: ${tabSwitchCount}/${maxAllowedTabSwitches}`);
                        console.log(`📊 Will trigger cheating on: ${maxAllowedTabSwitches} switches`);
                        
                        // Check if too many tab switches (trigger on 2nd switch)
                        if (tabSwitchCount >= maxAllowedTabSwitches) {
                            console.log('🚨 MAXIMUM TAB SWITCHES EXCEEDED - TERMINATING QUIZ WITH 0 SCORE');
                            console.log(`Student switched tabs ${tabSwitchCount} times (limit: ${maxAllowedTabSwitches})`);
                            
                            // Stop the quiz immediately
                            isQuizActive = false;
                            stopTimer();
                            
                            // Mark as cheating
                            markAsCheating('excessive_tab_switches');
                            return;
                        }
                        
                        // Show warning for first switch
                        if (tabSwitchCount === 1) {
                            console.log('⚠️ First tab switch - showing warning');
                            showCheatingWarning('Tab Switch Detected', 
                                `You have switched tabs ${tabSwitchCount}/${maxAllowedTabSwitches} times. 
                                ${maxAllowedTabSwitches - tabSwitchCount} more switch will result in automatic submission with zero score.`);
                        }
                    }
                }, 100); // 100ms delay to avoid rapid counting
            } else {
                console.log('👁️ Page became visible');
                isPageVisible = true;
                
                // Check if focus was lost for too long
                if (focusLostTime) {
                    const focusLossDuration = Date.now() - focusLostTime;
                    console.log(`⏱️ Focus was lost for ${focusLossDuration}ms (limit: ${maxAllowedFocusLoss}ms)`);
                    if (focusLossDuration > maxAllowedFocusLoss) {
                        console.log('🚨 Focus lost for too long - marking as cheating');
                        markAsCheating('excessive_focus_loss');
                        return;
                    }
                }
                
                focusLostTime = null;
            }
        }
        
        // Handle window focus
        function handleWindowFocus() {
            if (!isQuizActive) return;
            
            console.log('Window focused');
            isPageVisible = true;
            focusLostTime = null;
        }
        
        // Handle window blur
        function handleWindowBlur() {
            if (!isQuizActive) return;
            
            console.log('Window blurred - potential cheating detected');
            focusLostTime = Date.now();
            isPageVisible = false;
        }
        
        // Handle before page unload
        function handleBeforeUnload(event) {
            if (!isQuizActive) return;
            
            console.log('Page is about to unload - potential cheating detected');
            
            hasExitedQuiz = true;
            
            // Mark as cheating immediately
            markAsCheating('page_exit');
            
            // Enhanced warning message with more details
            const warningMessage = '⚠️ WARNING: Leaving this quiz will result in a ZERO SCORE!\n\nAre you sure you want to leave? Your progress will be lost and you will receive a score of 0.\n\nClick "Leave" to exit with zero score, or "Stay" to continue the quiz.';
            
            event.preventDefault();
            event.returnValue = warningMessage;
            return warningMessage;
        }
        
        // Handle page unload (logout, close tab)
        function handlePageUnload() {
            if (!isQuizActive) return;
            
            console.log('Page unloaded - marking as cheating');
            
            hasExitedQuiz = true;
            markAsCheating('page_unload');
        }
        
        // Handle new tab detection
        function handleNewTab(event) {
            if (!isQuizActive) return;
            
            // This is a simplified detection - in practice, you'd need more sophisticated methods
            console.log('Potential new tab/window opened');
        }
        
        // Handle keyboard shortcuts for new tab
        function handleKeyboardShortcuts(event) {
            if (!isQuizActive) return;
            
            // Detect Ctrl+T (new tab) or Ctrl+N (new window)
            if ((event.ctrlKey || event.metaKey) && (event.key === 't' || event.key === 'n')) {
                console.log('New tab/window shortcut detected - potential cheating');
                event.preventDefault();
                showCheatingWarning('Shortcut Blocked', 
                    'Opening new tabs or windows during the quiz is not allowed and will result in a zero score.');
            }
        }
        
        // Handle browser back button navigation
        function handlePopState(event) {
            // Allow normal browser back navigation without warning
            return true;
        }
        
        // Function to show periodic warning reminders
        function showPeriodicWarning() {
            // Warning reminders disabled
            return;
        }
        
        // Mark attempt as cheating
        async function markAsCheating(reason) {
            if (!currentAttemptId) {
                console.log('❌ No current attempt ID - trying to get current attempt...');
                
                // Try to get the current attempt ID
                try {
                    const response = await fetch('../php/quiz-management.php?action=check_existing_attempt&quiz_type=functions', {
                        credentials: 'include'
                    });
                    const result = await response.json();
                    
                    if (result.success && result.attempt) {
                        currentAttemptId = result.attempt.attempt_id;
                        console.log('✅ Retrieved current attempt ID:', currentAttemptId);
                    } else {
                        console.log('❌ No current attempt found - cannot mark as cheating');
                        // Still show the cheating notification even without database update
                        showCheatingNotification(reason);
                        stopQuizDueToCheating();
                        return;
                    }
                } catch (error) {
                    console.error('❌ Error getting current attempt:', error);
                    // Still show the cheating notification even without database update
                    showCheatingNotification(reason);
                    stopQuizDueToCheating();
                    return;
                }
            }
            
            console.log(`🚨 Marking attempt ${currentAttemptId} as cheating - reason: ${reason}`);
            
            // Stop the quiz immediately to prevent further interaction
            isQuizActive = false;
            stopTimer();
            stopAntiCheating();
            
            try {
                const response = await fetch('../php/quiz-management.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=mark_cheating&attempt_id=${currentAttemptId}&reason=${reason}`,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log('✅ Successfully marked as cheating');
                        
                        // Show cheating notification
                        showCheatingNotification(reason);
                        
                        // Stop the quiz completely
                        stopQuizDueToCheating();
                    } else {
                        console.log('❌ Failed to mark as cheating:', result.message);
                        // Still show the notification even if database update fails
                        showCheatingNotification(reason);
                        stopQuizDueToCheating();
                    }
                } else {
                    console.log('❌ HTTP error marking as cheating');
                    // Still show the notification even if database update fails
                    showCheatingNotification(reason);
                    stopQuizDueToCheating();
                }
            } catch (error) {
                console.error('❌ Error marking as cheating:', error);
                // Still show the notification even if database update fails
                showCheatingNotification(reason);
                stopQuizDueToCheating();
            }
        }
        
        // Update results character based on score
        function updateResultsCharacter(percentage) {
            const characterImg = document.querySelector('#resultsCharacter img');
            if (!characterImg) return;
            
            // Remove existing animation classes
            characterImg.classList.remove('sad', 'happy', 'motivate', 'celebrate');
            
            if (percentage < 60) {
                // Low score - show motivate character
                characterImg.src = '../Img/Character/motivate-removebg-preview.png';
                characterImg.alt = 'Motivate Character - Keep Going!';
                characterImg.classList.add('motivate');
                console.log('💪 Showing motivate character for low score:', percentage + '%');
            } else if (percentage >= 80) {
                // High score - show celebrate character
                characterImg.src = '../Img/Character/celebrate-removebg-preview.png';
                characterImg.alt = 'Celebrate Character - Excellent Score!';
                characterImg.classList.add('celebrate');
                console.log('🎉 Showing celebrate character for high score:', percentage + '%');
            } else {
                // Medium score - show neutral character
                characterImg.src = '../Img/Character/tips_approved-removebg-preview.png';
                characterImg.alt = 'Neutral Character - Good Score';
                console.log('😐 Showing neutral character for medium score:', percentage + '%');
            }
        }
        
        // Update character for cheating cases
        function updateCheatingCharacter() {
            const characterImg = document.querySelector('#resultsCharacter img');
            if (!characterImg) return;
            
            // Remove existing animation classes
            characterImg.classList.remove('sad', 'happy', 'motivate', 'celebrate');
            
            // Show sad character for cheating
            characterImg.src = '../Img/Character/sad-removebg-preview.png';
            characterImg.alt = 'Sad Character - Cheating Detected';
            characterImg.classList.add('sad');
            console.log('😢 Showing sad character for cheating violation');
        }
        
        // Show cheating warning
        function showCheatingWarning(title, message) {
            console.log('🚨 Showing cheating warning - tab switch count:', tabSwitchCount);
            
            Swal.fire({
                title: title,
                html: `
                    <div class="text-center">
                        <div class="w-24 h-24 mx-auto mb-4 flex items-center justify-center">
                            <img src="../Img/Character/warning_example-removebg-preview.png" 
                                 alt="Warning Character" 
                                 class="w-full h-full object-contain warning-character"
                                 style="filter: drop-shadow(0 10px 20px rgba(0,0,0,0.15));">
                        </div>
                        <p class="text-slate-600 text-lg leading-relaxed">${message}</p>
                    </div>
                `,
                icon: false,
                confirmButtonText: 'I Understand',
                confirmButtonColor: '#f59e0b',
                background: '#ffffff',
                customClass: {
                    popup: 'rounded-2xl',
                    title: 'text-slate-800',
                    content: 'text-slate-600'
                },
                allowOutsideClick: false,
                allowEscapeKey: false
            }).then((result) => {
                // After the user clicks "I Understand", ensure anti-cheating is still active
                if (result.isConfirmed) {
                    console.log('✅ User acknowledged warning - anti-cheating system remains active');
                    console.log(`📊 Current tab switch count: ${tabSwitchCount}/${maxAllowedTabSwitches}`);
                    console.log(`📊 Quiz active status: ${isQuizActive}`);
                    
                    // Simple verification that the system is still active
                    if (isQuizActive) {
                        console.log('🔍 Anti-cheating system is still monitoring...');
                        console.log(`📊 Current tab switch count: ${tabSwitchCount}/${maxAllowedTabSwitches}`);
                        console.log('✅ System is ready to detect the next tab switch');
                    } else {
                        console.log('⚠️ Quiz is not active - this should not happen');
                    }
                }
            });
        }
        
        // Show cheating notification and results
        function showCheatingNotification(reason) {
            const reasonMessages = {
                'excessive_tab_switches': 'You switched tabs too many times during the quiz.',
                'excessive_focus_loss': 'You left the quiz page for too long.',
                'page_exit': 'You attempted to leave the quiz page.',
                'page_unload': 'You closed the browser or logged out during the quiz.',
                'new_tab': 'You opened a new tab during the quiz.'
            };
            
            const message = reasonMessages[reason] || 'Suspicious activity detected during the quiz.';
            
            // Hide quiz container and show results with 0 score
            const quizContainer = document.getElementById('quizContainer');
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (quizContainer) quizContainer.classList.add('hidden');
            if (resultsContainer) {
                resultsContainer.classList.remove('hidden');
                
                // Update results with 0 score
                const totalScoreEl = document.getElementById('totalScore');
                const correctAnswersEl = document.getElementById('correctAnswers');
                const incorrectAnswersEl = document.getElementById('incorrectAnswers');
                const completionTimeEl = document.getElementById('completionTime');
                const overallGradeEl = document.getElementById('overallGrade');
                const gradeProgressEl = document.getElementById('gradeProgress');
                
                if (totalScoreEl) totalScoreEl.textContent = '0/11';
                if (correctAnswersEl) correctAnswersEl.textContent = '0';
                if (incorrectAnswersEl) incorrectAnswersEl.textContent = '11';
                if (completionTimeEl) completionTimeEl.textContent = getFormattedTime();
                if (overallGradeEl) overallGradeEl.textContent = '0%';
                if (gradeProgressEl) {
                    gradeProgressEl.style.width = '0%';
                    gradeProgressEl.className = 'bg-red-500 h-3 rounded-full transition-all duration-1000';
                }
                
                // Update character to show sad character for cheating
                updateCheatingCharacter();
                
                // Add cheating notice to results
                const resultsContent = resultsContainer.querySelector('.bg-white.rounded-2xl.shadow-xl.p-8');
                if (resultsContent) {
                    const cheatingNotice = document.createElement('div');
                    cheatingNotice.className = 'bg-red-50 border-l-4 border-red-500 p-4 rounded-lg mb-6';
                    cheatingNotice.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                            <div>
                                <h4 class="font-semibold text-red-800">Quiz Terminated Due to Cheating</h4>
                                <p class="text-sm text-red-700">${message}</p>
                            </div>
                        </div>
                    `;
                    resultsContent.insertBefore(cheatingNotice, resultsContent.firstChild);
                }
            }
            
            // Scroll to results
            if (resultsContainer) {
                resultsContainer.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // Stop quiz due to cheating
        function stopQuizDueToCheating() {
            // Stop timer
            stopTimer();
            
            // Disable all quiz interactions
            const quizContainer = document.getElementById('quizContainer');
            if (quizContainer) {
                quizContainer.style.pointerEvents = 'none';
                quizContainer.style.opacity = '0.5';
            }
            
            // Disable submit button
            const submitButton = document.querySelector('[onclick="submitQuiz()"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = 'Quiz Terminated';
            }
            
            // Stop anti-cheating
            stopAntiCheating();
        }
        
        // Check if page was refreshed (allow continuation)
        function isPageRefresh() {
            // Check if the page was refreshed by looking at performance navigation
            if (performance.navigation && performance.navigation.type === 1) {
                return true; // Page was refreshed
            }
            
            // Check if the page was refreshed by looking at performance timing
            if (performance.timing && performance.timing.navigationStart) {
                const navigationStart = performance.timing.navigationStart;
                const now = Date.now();
                const timeDiff = now - navigationStart;
                
                // If the page was loaded very recently, it might be a refresh
                if (timeDiff < 5000) { // Less than 5 seconds
                    return true;
                }
            }
            
            return false;
        }
        
        // Override the submit quiz function to check for cheating
        const originalSubmitQuiz = submitQuiz;
        submitQuiz = async function() {
            // Check if student has been marked as cheating
            if (hasExitedQuiz || hasLoggedOut) {
                showCheatingNotification('quiz_exit');
                return;
            }
            
            // Call original submit function
            return await originalSubmitQuiz();
        };
    </script>
</body>
</html>
